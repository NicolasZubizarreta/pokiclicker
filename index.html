<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Poké-Clicker: Kanto Origins</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; background: #0f172a; color: white; overflow: hidden; }
        h1, h2, h3, .pixel-font { font-family: 'Press Start 2P', cursive; }
        
        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .pokemon-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-5deg); } 75% { transform: translateX(5px) rotate(5deg); } 100% { transform: translateX(0); } }
        .shake-anim { animation: shake 0.3s ease-in-out; filter: brightness(2) drop-shadow(0 0 5px red); }

        @keyframes catch-shake { 
            0% { transform: scale(1) rotate(0); } 
            20% { transform: scale(0.8) rotate(-10deg); } 
            40% { transform: scale(0.8) rotate(10deg); } 
            60% { transform: scale(0.8) rotate(-10deg); } 
            80% { transform: scale(0.8) rotate(0); } 
            100% { transform: scale(0); opacity: 0; }
        }
        .catching { animation: catch-shake 1.5s ease-in-out forwards; filter: brightness(0); }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* UI Elements */
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
        .locked-blur { filter: blur(4px) grayscale(100%); pointer-events: none; opacity: 0.5; }
        .pc-screen { background: radial-gradient(circle, #1a2e1a 0%, #051405 100%); box-shadow: inset 0 0 20px #000; border: 4px solid #333; }
        
        /* Background Layer */
        #bg-layer {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            image-rendering: pixelated;
            z-index: 0;
            position: absolute;
            inset: 0;
            opacity: 0.4;
        }
        
        .cheat-active { box-shadow: 0 0 15px #ef4444; border-color: #ef4444; color: #ef4444; background: #450a0a !important; }
        
        /* Utility for missing images */
        img[src=""] { opacity: 0; }

        /* Shiny Effect */
        .shiny-filter { filter: hue-rotate(150deg) saturate(150%) brightness(1.1) drop-shadow(0 0 5px gold); }
        .grayscale { filter: grayscale(100%) opacity(0.3); }

        /* Gen 1 Fly Animation */
        #gen1-fly-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .fly-track {
            width: 100%;
            height: 180px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-top: 20px solid black;
            border-bottom: 20px solid black;
            clip-path: inset(50% 0 50% 0);
            transition: clip-path 0.8s ease-in-out;
        }
        .fly-speed-lines {
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='180'%3E%3Crect width='400' height='180' fill='black'/%3E%3Crect x='25' y='15' width='8' height='2' fill='white'/%3E%3Crect x='150' y='30' width='12' height='2' fill='white'/%3E%3Crect x='80' y='100' width='10' height='2' fill='white'/%3E%3Crect x='300' y='80' width='8' height='2' fill='white'/%3E%3Crect x='350' y='20' width='9' height='2' fill='white'/%3E%3Crect x='220' y='90' width='11' height='2' fill='white'/%3E%3Crect x='20' y='70' width='7' height='2' fill='white'/%3E%3Crect x='250' y='50' width='9' height='2' fill='white'/%3E%3Crect x='120' y='5' width='8' height='2' fill='white'/%3E%3Crect x='380' y='110' width='10' height='2' fill='white'/%3E%3Crect x='50' y='85' width='9' height='2' fill='white'/%3E%3Crect x='180' y='60' width='12' height='2' fill='white'/%3E%3Crect x='100' y='140' width='10' height='2' fill='white'/%3E%3Crect x='320' y='160' width='8' height='2' fill='white'/%3E%3Crect x='200' y='130' width='12' height='2' fill='white'/%3E%3C/svg%3E");
        }
        .fly-bird-sprite {
            position: absolute; top: 50%; left: 150%;
            transform: translate(-50%, -50%) scale(2.2);
            image-rendering: pixelated;
        }
        #gen1-fly-overlay.active .fly-speed-lines,
        #gen1-fly-overlay.closing .fly-speed-lines { animation: move-lines 0.2s linear infinite; }
        #gen1-fly-overlay.active .fly-track { 
            clip-path: inset(0 0 0 0);
            animation: track-open 0.4s ease-out forwards; 
        }
        #gen1-fly-overlay.active .fly-bird-sprite { 
            animation: bird-fly-sequence 2.5s ease-in-out forwards; 
        }
        #gen1-fly-overlay.closing .fly-track {
            animation: track-close 0.4s ease-in-out forwards;
        }
        @keyframes move-lines { from { background-position: 0 0; } to { background-position: -400px 0; } }
        @keyframes track-open {
            0% { clip-path: inset(48% 0 48% 100%); } /* Trait fin à droite */
            50% { clip-path: inset(48% 0 48% 0); }   /* Trait fin toute largeur */
            100% { clip-path: inset(0 0 0 0); }      /* Pleine hauteur */
        }
        @keyframes track-close {
            0% { clip-path: inset(0 0 0 0); }
            100% { clip-path: inset(50% 0 50% 0); }
        }
        @keyframes bird-fly-sequence {
            0% { left: 150%; }
            10% { left: 150%; } /* Attente ouverture */
            30% { left: 50%; }  /* Arrivée au centre (Rapide) */
            60% { left: 50%; }  /* Pause */
            100% { left: -50%; } /* Départ vers la gauche (Lent) */
        }
    </style>
</head>
<body class="h-screen flex flex-col selection:bg-red-500 selection:text-white">

<div class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-4 hidden" id="starter-modal">
    <div class="text-center mb-10 animate-bounce">
        <h1 class="text-3xl md:text-5xl text-yellow-400 mb-2 pixel-font drop-shadow-lg">POKÉ CLICKER</h1>
        <p class="text-gray-400 text-sm tracking-widest">KANTO ORIGINS</p>
    </div>
    <div class="bg-slate-800/80 p-8 rounded-3xl border-4 border-slate-600 shadow-2xl max-w-4xl w-full backdrop-blur-sm">
        <h2 class="text-center text-white mb-8 pixel-font text-lg">CHOISIS TON STARTER</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="group relative bg-gradient-to-br from-green-900 to-slate-900 border-2 border-green-600 hover:border-green-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(1)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png">
                <div class="pixel-font text-green-400 text-sm">BULBIZARRE</div>
            </div>
            <div class="group relative bg-gradient-to-br from-red-900 to-slate-900 border-2 border-red-600 hover:border-red-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(4)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png">
                <div class="pixel-font text-red-400 text-sm">SALAMÈCHE</div>
            </div>
            <div class="group relative bg-gradient-to-br from-blue-900 to-slate-900 border-2 border-blue-600 hover:border-blue-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(7)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png">
                <div class="pixel-font text-blue-400 text-sm">CARAPUCE</div>
            </div>
        </div>
        <div class="mt-8 text-center">
            <button onclick="loadSaveFile()" class="text-xs text-gray-500 hover:text-white underline">Importer une sauvegarde (JSON)</button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileSelect(event)">
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="pokedex-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl relative">
        <button onclick="togglePokedex()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-4xl z-10">close</button>
        <div class="p-4 border-b border-slate-700 bg-slate-900 rounded-t-xl flex justify-between items-center pr-20">
            <div>
                <h2 class="text-yellow-400 pixel-font text-xl">POKÉDEX</h2>
                <p class="text-xs text-gray-400 mt-1">CAPTUREZ-LES TOUS POUR DES BONUS !</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleMilestones()" class="bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] font-bold py-1 px-3 rounded shadow-md border border-yellow-400 flex items-center gap-1 transition-all"><span class="material-symbols-outlined text-[14px]">trophy</span> RÉCOMPENSES</button>
                <div class="text-right">
                    <div class="text-2xl font-bold text-white"><span id="pokedex-count">0</span>/151</div>
                    <div class="text-xs text-blue-400" id="next-milestone-text">Prochain palier: 10</div>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 custom-scroll">
            <div class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-2" id="pokedex-grid"></div>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="map-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-3xl aspect-video flex flex-col shadow-2xl relative overflow-hidden">
        <button onclick="toggleMap()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-4xl z-20 bg-slate-900 rounded-full">close</button>
        <div class="relative w-full h-full bg-[#70A8C0]" id="map-container">
            <img src="kanto.png" class="absolute inset-0 w-full h-full object-fill opacity-90" alt="Carte de Kanto">
            <svg id="map-svg" class="absolute inset-0 w-full h-full" preserveAspectRatio="none"></svg>
            <img id="fly-trainer" src="https://raw.githubusercontent.com/msikma/pokesprite/master/trainers/firered-leafgreen/back/red.png" class="absolute z-30 hidden" style="height: 120px; image-rendering: pixelated; transform: translate(-50%, -50%);">
            <div id="gen1-fly-overlay" class="hidden">
                <div class="fly-track">
                    <div class="fly-speed-lines"></div>
                    <img src="https://img.pokemondb.net/sprites/black-white/anim/normal/pidgeot.gif" class="fly-bird-sprite">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="badges-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6">
        <button onclick="toggleBadges()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <h2 class="text-center text-yellow-400 pixel-font text-xl mb-2">BOÎTE À BADGES</h2>
        <p class="text-center text-xs text-gray-400 mb-6">BATTEZ LES CHAMPIONS POUR OBTENIR DES BONUS PERMANENTS</p>
        
        <div class="grid grid-cols-4 gap-4" id="badges-grid">
            <!-- Badges will be rendered here -->
        </div>

        <div class="mt-6 bg-slate-900/50 p-3 rounded border border-slate-700 text-center min-h-[60px] flex items-center justify-center">
            <p id="badge-tooltip" class="text-sm text-blue-300 font-bold">Survolez un badge pour voir son effet</p>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="milestones-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6 max-h-[80vh]">
        <button onclick="toggleMilestones()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <h2 class="text-center text-yellow-400 pixel-font text-xl mb-6">RÉCOMPENSES</h2>
        
        <div class="flex-1 overflow-y-auto custom-scroll space-y-2" id="milestones-list">
            <!-- Generated by JS -->
        </div>
    </div>
</div>

<div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 hidden pointer-events-none" id="rare-alert">
    <div class="bg-yellow-500 text-black px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white animate-bounce flex items-center gap-2">
        <span class="material-symbols-outlined">warning</span>
        POKÉMON RARE ! COMBAT AUTO STOPPÉ !
    </div>
</div>
<div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 hidden pointer-events-none" id="swap-alert">
    <div class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white flex items-center gap-2 animate-pulse">
        <span class="material-symbols-outlined">swap_horiz</span>
        SÉLECTIONNEZ UN POKÉMON À REMPLACER
    </div>
</div>

<div class="flex-1 flex h-full opacity-0 transition-opacity duration-1000 hidden" id="game-ui">
    
    <div class="w-72 md:w-80 flex-shrink-0 bg-slate-900 border-r border-slate-700 flex flex-col z-20 shadow-2xl">
        <div class="flex-1 flex flex-col min-h-0 bg-slate-800/50">
            <div class="p-3 bg-gradient-to-r from-red-700 to-red-800 shadow-lg z-10 flex justify-between items-center border-b border-red-900">
                <div>
                    <span class="pixel-font text-[10px] text-white block tracking-wide">ÉQUIPE (<span id="team-count">1</span>/6)</span>
                    <span class="text-[9px] text-red-200 font-mono">DPS: <span class="font-bold text-white" id="total-dps">15</span></span>
                </div>
                <div class="flex items-center">
                <button class="bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-2 rounded-full shadow-md border border-green-400 flex items-center gap-1 transition-all mr-1" id="auto-stop-btn" onclick="toggleStopOnRare()" title="Si ACTIF : Le combat auto s'arrête quand un Pokémon Rare ou Shiny apparaît.">
                    <span class="material-symbols-outlined text-[12px]">front_hand</span>
                </button>
                <button class="bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-green-400 flex items-center gap-1 transition-all" id="auto-attack-btn" onclick="toggleAutoAttack()" title="Attaque automatiquement les ennemis (DPS)">
                    <span class="material-symbols-outlined text-[12px]">swords</span> <span id="auto-txt">ON</span>
                </button>
                <button class="bg-gray-600 hover:bg-gray-500 text-gray-300 text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-gray-400 flex items-center gap-1 transition-all ml-1 hidden" id="auto-click-btn" onclick="toggleAutoClicker()" title="Restes : Clique automatiquement 4 fois par seconde">
                    <span class="material-symbols-outlined text-[12px]">restaurant</span> <span id="auto-click-txt">OFF</span>
                </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll" id="team-list">
                </div>
        </div>
        <div class="h-1/4 flex-shrink-0 bg-slate-800 border-t border-slate-700 flex flex-col">
            <div class="p-2 bg-slate-700 text-center shadow-md border-b border-slate-600">
                <span class="pixel-font text-[10px] text-yellow-300 tracking-wider">SAC À DOS</span>
            </div>
            <div class="flex-1 overflow-y-auto p-2 grid grid-cols-2 gap-2 custom-scroll" id="bag-content">
                </div>
        </div>
    </div>

    <div class="flex-1 relative flex flex-col overflow-hidden bg-black">
        <div id="bg-layer" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-slate-900/50 pointer-events-none z-0"></div>

        <div class="absolute top-0 w-full p-4 flex justify-between items-start z-30 pointer-events-none">
            <div class="flex flex-col gap-2 pointer-events-auto">
                <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-3 shadow-lg transform hover:scale-105 transition-transform">
                    <span class="material-symbols-outlined text-yellow-400">radio_button_unchecked</span>
                    <span class="text-xl font-bold pixel-font text-white text-shadow" id="money-display">0</span>
                </div>
                <button onclick="toggleMap()" class="w-12 h-12 bg-slate-800 rounded-full border-2 border-blue-400 hover:bg-slate-700 shadow-lg flex items-center justify-center transition-all hover:scale-110 group" title="Ouvrir la Carte">
                    <span class="material-symbols-outlined text-blue-200 group-hover:text-white text-2xl">map</span>
                </button>
            </div>
            <div class="glass-panel px-6 py-2 rounded-xl text-right shadow-lg pointer-events-auto min-w-[200px]">
                <div class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">Zone <span id="zone-id">1</span></div>
                <div class="text-lg font-bold pixel-font text-white leading-snug mb-1 truncate" id="zone-name">Route 1</div>
                <div class="flex items-center justify-end gap-2">
                    <div class="w-24 h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500 transition-all duration-300 w-1/10" id="zone-progress" style="width: 10%;"></div>
                    </div>
                    <span class="text-xs text-gray-400 font-mono" id="stage-text">1/10</span>
                </div>
            </div>
        </div>

        <div class="relative flex-1 flex flex-col items-center justify-center z-20 select-none">
            <div class="relative w-96 h-96 flex items-center justify-center group">
                <div class="absolute -top-20 left-0 w-full text-center hidden pointer-events-none z-50" id="feedback-msg">
                    <span class="text-yellow-400 font-bold text-2xl pixel-font text-shadow-lg drop-shadow-lg">CAPTURED!</span>
                </div>
                <img class="w-72 h-72 object-contain pokemon-float drop-shadow-2xl transition-all duration-100 cursor-pointer active:scale-95" id="enemy-sprite" onclick="clickAttack(event)" src="">
                <div class="hidden absolute top-0 right-10 bg-red-600 text-white font-bold text-[10px] px-3 py-1 rounded border border-white shadow-lg animate-bounce" id="boss-badge" style="display: none;">BOSS</div>
            </div>
            
            <div class="w-80 md:w-96 mt-4 bg-slate-900/80 rounded-xl border-2 border-slate-600 p-2 shadow-2xl backdrop-blur-md relative">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-[10px] font-bold px-3 py-0.5 rounded-full border border-slate-500 shadow-md">
                    <span id="enemy-level">Lv. 2</span>
                </div>
                <div class="flex justify-between text-[11px] font-bold px-2 mb-1 mt-1">
                    <span class="text-white truncate max-w-[60%]" id="enemy-name">...</span>
                    <span class="text-white font-mono" id="hp-text">...</span>
                </div>
                <div class="h-4 bg-slate-800 rounded-full overflow-hidden relative">
                    <div class="h-full transition-all duration-100 bg-red-500" id="hp-bar" style="width: 100%;"></div>
                </div>
                <div class="h-1.5 mt-1 bg-slate-800 rounded-full overflow-hidden relative hidden" id="boss-timer-wrapper">
                    <div class="h-full bg-purple-500 transition-all duration-1000 ease-linear" id="boss-timer-bar" style="width: 100%;"></div>
                </div>
            </div>

            <button class="absolute bottom-4 left-4 z-40 bg-gray-800 text-gray-400 border border-gray-600 px-3 py-1 rounded text-xs font-bold hover:bg-gray-700 transition-all opacity-50 hover:opacity-100" id="cheat-btn" onclick="toggleCheat()" title="Active le mode triche : Dégâts massifs et objets à 1$">CHEAT</button>

            <div class="absolute bottom-4 right-4 z-40 grid grid-cols-2 gap-2 justify-items-end">
                <button class="col-start-1 row-start-1 bg-blue-800 text-blue-200 border border-blue-600 px-3 py-1 rounded text-xs font-bold hover:bg-blue-700 transition-all flex items-center gap-1 shadow-lg" onclick="exportSave()">
                    <span class="material-symbols-outlined text-[14px]">save</span> SAUVER
                </button>
                <button class="col-start-1 row-start-2 bg-red-800 text-red-200 border border-red-600 px-3 py-1 rounded text-xs font-bold hover:bg-red-700 transition-all flex items-center gap-1 shadow-lg" onclick="resetSave()">
                    <span class="material-symbols-outlined text-[14px]">delete</span> RESET
                </button>
                <button class="col-start-2 row-start-2 bg-slate-800 text-yellow-400 border border-yellow-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-slate-700 transition-all shadow-lg flex items-center gap-1" onclick="toggleBadges()" title="Voir les Badges">
                    <span class="material-symbols-outlined text-[16px]">military_tech</span> BADGES
                </button>
                <button class="col-start-2 row-start-1 bg-red-700 text-white border border-red-500 px-3 py-1 rounded text-xs font-bold hover:bg-red-600 transition-all flex items-center gap-1 shadow-lg" onclick="togglePokedex()">
                    <span class="material-symbols-outlined text-[14px]">book</span> POKÉDEX
                </button>
            </div>

            <div class="mt-8 flex flex-row items-center gap-4">
                <button class="group relative bg-slate-100 hover:bg-white text-red-600 font-bold py-3 px-8 rounded-full shadow-lg active:translate-y-1 transition-all flex items-center gap-2 border-2 border-slate-300" id="catch-btn" onclick="attemptCatch('poke')">
                    <img class="w-6 h-6 group-hover:rotate-12 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">
                    <span class="pixel-font text-xs tracking-wide">CAPTURER</span>
                    <div class="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] w-6 h-6 rounded-full flex items-center justify-center border-2 border-white shadow-md font-bold" id="ball-count-btn">0</div>
                </button>
                <button class="hidden group relative bg-blue-100 hover:bg-blue-50 text-blue-800 font-bold py-3 px-4 rounded-full shadow-lg active:translate-y-1 transition-all flex items-center gap-2 border-2 border-blue-400" id="super-catch-btn" onclick="attemptCatch('super')" title="3x Chances" style="display: none;">
                    <img class="w-6 h-6 group-hover:rotate-12 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png">
                    <div class="absolute -top-2 -right-2 bg-yellow-500 text-white text-[10px] w-6 h-6 rounded-full flex items-center justify-center border-2 border-white shadow-md font-bold" id="superball-count-btn">0</div>
                </button>
                <button class="hidden group relative bg-yellow-100 hover:bg-yellow-50 text-yellow-900 font-bold py-3 px-4 rounded-full shadow-lg active:translate-y-1 transition-all flex items-center gap-2 border-2 border-yellow-500" id="hyper-catch-btn" onclick="attemptCatch('hyper')" title="5x Chances" style="display: none;">
                    <img class="w-6 h-6 group-hover:rotate-12 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png">
                    <div class="absolute -top-2 -right-2 bg-black text-yellow-400 text-[10px] w-6 h-6 rounded-full flex items-center justify-center border-2 border-white shadow-md font-bold" id="hyperball-count-btn">0</div>
                </button>
                <button class="hidden group relative bg-purple-900 hover:bg-purple-800 text-purple-200 font-bold py-3 px-4 rounded-full shadow-lg active:translate-y-1 transition-all flex items-center gap-2 border-2 border-purple-500" id="master-catch-btn" onclick="attemptCatch('master')" title="100% Chance" style="display: none;">
                    <img class="w-6 h-6 group-hover:rotate-12 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png">
                    <div class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-6 h-6 rounded-full flex items-center justify-center border-2 border-white shadow-md font-bold" id="masterball-count-btn">0</div>
                </button>
            </div>
        </div>

        <div class="absolute bottom-8 w-full flex justify-center gap-6 z-30 pointer-events-none">
            <button class="pointer-events-auto w-12 h-12 rounded-full bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 text-white shadow-xl flex items-center justify-center transition disabled:opacity-50" id="prev-zone-btn" onclick="changeZone(-1)" disabled>
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <button class="pointer-events-auto w-14 h-14 rounded-full bg-slate-800 border-4 border-slate-600 text-gray-500 shadow-none flex items-center justify-center cursor-not-allowed opacity-50" id="next-zone-btn" onclick="changeZone(1)" disabled>
                <span class="material-symbols-outlined text-2xl">arrow_forward</span>
            </button>
        </div>
    </div>

    <div class="w-72 md:w-80 flex-shrink-0 bg-slate-900 border-l border-slate-700 flex flex-col z-20 shadow-2xl">
        <div class="h-1/2 flex flex-col relative border-b border-slate-700">
            <div class="p-2 bg-slate-800 text-center shadow-md border-b border-slate-600 z-10">
                <span class="pixel-font text-[10px] text-blue-300 tracking-wider">BOUTIQUE</span>
            </div>
            <div class="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center text-center p-4" id="shop-locked">
                <span class="material-symbols-outlined text-gray-500 text-3xl mb-2">lock</span>
                <p class="text-xs text-gray-400 font-bold">DÉBLOQUÉ ZONE 2</p>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scroll locked-blur" id="shop-content">
                </div>
        </div>
        <div class="h-1/2 flex flex-col relative bg-slate-900">
            <div class="p-2 bg-green-900/50 text-center shadow-md border-b border-green-800 z-10">
                <span class="pixel-font text-[10px] text-green-300 tracking-wider">PC DE LÉO</span>
            </div>
            <div class="absolute inset-0 bg-slate-900/95 z-20 flex flex-col items-center justify-center text-center p-4" id="pc-locked">
                <span class="material-symbols-outlined text-gray-600 text-3xl mb-2">computer</span>
                <p class="text-xs text-gray-500 font-bold">DÉBLOQUÉ ZONE 4</p>
            </div>
            <div class="flex-1 overflow-y-auto p-2 pc-screen custom-scroll bg-black" id="pc-content"></div>
        </div>
    </div>
</div>

<script>
// --- CONSTANTS ---
const ITEMS = {
    // Consommables
    pokeball: { name: "Pokéball", price: 100, desc: "Capture des Pokémon (Faible chance)", type: "consumable", zone: 0, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png", invKey: "balls" },
    superball: { name: "Superball", price: 300, desc: "Capture des Pokémon (Moyenne chance x2)", type: "consumable", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png", invKey: "superballs" },
    hyperball: { name: "Hyperball", price: 800, desc: "Capture des Pokémon (Haute chance x4)", type: "consumable", zone: 9, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png", invKey: "hyperballs" },
    candy: { name: "Bonbon", price: 2000, desc: "Fait monter un Pokémon de niveau", type: "consumable", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/rare-candy.png", invKey: "candy" },
    masterball: { name: "Master Ball", price: 100000, desc: "Capture à coup sûr (100%)", type: "consumable", zone: 16, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png", invKey: "masterball" },
    repel: { name: "Repousse", price: 2000, desc: "Empêche les Pokémon communs d'apparaître pendant 30s", type: "consumable", zone: 5, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/repel.png", invKey: "repel" },
    xAttack: { name: "Attaque +", price: 5000, desc: "Dégâts/clic x2 (60s)", type: "consumable", zone: 8, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-attack.png", invKey: "xAttack" },
    xSpecial: { name: "Attaque Spé +", price: 7500, desc: "DPS Équipe x2 (60s)", type: "consumable", zone: 11, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-sp-atk.png", invKey: "xSpecial" },
    superRepel: { name: "Superepousse", price: 9000, desc: "Bloque Communs/Peu Communs (30s)", type: "consumable", zone: 13, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/super-repel.png", invKey: "superRepel" },
    pokeDoll: { name: "Poké Poupée", price: 7500, desc: "Invoque le Boss (Si déjà vaincu)", type: "consumable", zone: 15, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-doll.png", invKey: "pokeDoll" },
    // Améliorations
    runningShoes: { name: "Chaussures Sport", price: 1000, desc: "Divise le temps d'apparition des ennemis par 1.5", type: "upgrade", zone: 1, icon: "sprint", iconColor: "text-orange-400" },
    amuletCoin: { name: "Pièce Rune", price: 1500, desc: "Augmente les gains d'argent de +50%", type: "upgrade", zone: 2, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/amulet-coin.png" },
    protein: { name: "Protéine", price: 3000, desc: "Augmente les dégâts du clic de +50%", type: "upgrade", zone: 3, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/protein.png" },
    expShare: { name: "Multi Exp", price: 5000, desc: "Augmente les dégâts de l'équipe de +50%", type: "upgrade", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/exp-share.png" },
    hardStone: { name: "Pierre Dure", price: 10000, desc: "Augmente les dégâts du clic de +30%", type: "upgrade", zone: 6, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/hard-stone.png" },
    bicycle: { name: "Bicyclette", price: 20000, desc: "Vitesse de spawn x3 (Remplace Chaussures)", type: "upgrade", zone: 7, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/bicycle.png" },
    luckyEgg: { name: "Oeuf Chance", price: 50000, desc: "XP gagnée x1.5", type: "upgrade", zone: 10, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/lucky-egg.png" },
    leftovers: { name: "Restes", price: 100000, desc: "Auto-click 4 clics/sec", type: "upgrade", zone: 12, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/leftovers.png" }
};
const EVOLUTIONS = {
    1:{id:2,lvl:16,name:"Herbizarre"}, 2:{id:3,lvl:32,name:"Florizarre"},
    4:{id:5,lvl:16,name:"Reptincel"}, 5:{id:6,lvl:36,name:"Dracaufeu"},
    7:{id:8,lvl:16,name:"Carabaffe"}, 8:{id:9,lvl:36,name:"Tortank"},
    10:{id:11,lvl:7,name:"Chrysacier"}, 11:{id:12,lvl:10,name:"Papilusion"},
    13:{id:14,lvl:7,name:"Coconfort"}, 14:{id:15,lvl:10,name:"Dardargnan"},
    16:{id:17,lvl:18,name:"Roucoups"}, 17:{id:18,lvl:36,name:"Roucarnage"},
    19:{id:20,lvl:20,name:"Rattatac"},
    25:{id:26,lvl:22,name:"Raichu"},
    29:{id:30,lvl:16,name:"Nidorina"}, 30:{id:31,lvl:36,name:"Nidoqueen"},
    32:{id:33,lvl:16,name:"Nidorino"}, 33:{id:34,lvl:36,name:"Nidoking"},
    41:{id:42,lvl:22,name:"Nosferalto"},
    43:{id:44,lvl:21,name:"Ortide"}, 44:{id:45,lvl:32,name:"Rafflesia"}, // Rafflesia requires Stone usually
    46:{id:47,lvl:24,name:"Parasect"},
    48:{id:49,lvl:31,name:"Aéromite"},
    60:{id:61,lvl:25,name:"Têtarte"},
    63:{id:64,lvl:16,name:"Kadabra"}, 64:{id:65,lvl:36,name:"Alakazam"}, // Trade logic ignored for clicker
    69:{id:70,lvl:21,name:"Boustiflor"}, 70:{id:71,lvl:32,name:"Empiflor"},
    74:{id:75,lvl:25,name:"Gravalanch"}, 75:{id:76,lvl:36,name:"Grolem"}
};

const BASE_STATS = {
    "1": 49, "2": 62, "3": 82,
    "4": 52, "5": 64, "6": 84,
    "7": 48, "8": 63, "9": 83,
    "10": 30, "11": 25, "12": 90,
    "13": 35, "14": 25, "15": 90,
    "16": 45, "17": 60, "18": 80,
    "19": 56, "20": 81,
    "21": 60, "22": 90,
    "23": 60, "24": 85,
    "25": 55, "26": 90,
    "27": 75, "28": 100,
    "29": 47, "30": 62, "31": 92,
    "32": 57, "33": 72, "34": 102,
    "35": 45, "36": 70,
    "37": 38, "38": 76,
    "39": 45, "40": 70,
    "41": 45, "42": 80,
    "43": 50, "44": 65, "45": 110,
    "46": 70, "47": 95,
    "48": 55, "49": 90,
    "50": 55, "51": 100,
    "52": 45, "53": 70,
    "54": 50, "55": 82,
    "56": 80, "57": 105,
    "58": 70, "59": 110,
    "60": 50, "61": 65, "62": 95,
    "63": 105, "64": 120, "65": 135,
    "66": 80, "67": 100, "68": 130,
    "69": 75, "70": 90, "71": 105,
    "72": 40, "73": 80,
    "74": 80, "75": 95, "76": 120,
    "77": 85, "78": 100,
    "79": 65, "80": 95,
    "81": 60, "82": 120,
    "83": 65, "84": 85, "85": 110,
    "86": 45, "87": 70,
    "88": 80, "89": 105,
    "90": 65, "91": 95,
    "92": 100, "93": 115, "94": 130,
    "95": 45,
    "96": 48, "97": 73,
    "98": 105, "99": 130,
    "100": 50, "101": 80,
    "102": 60, "103": 125,
    "104": 50, "105": 80,
    "106": 120,
    "107": 105,
    "108": 55,
    "109": 65, "110": 90,
    "111": 85, "112": 130,
    "113": 10,
    "114": 100,
    "115": 95,
    "116": 60, "117": 85,
    "118": 67, "119": 92,
    "120": 75, "121": 100,
    "122": 100,
    "123": 110,
    "124": 115,
    "125": 83,
    "126": 95,
    "127": 125,
    "128": 100,
    "129": 10, "130": 125,
    "131": 85,
    "132": 48,
    "133": 55,
    "134": 110, "135": 110, "136": 130,
    "137": 65,
    "138": 60, "139": 115,
    "140": 80, "141": 115,
    "142": 105,
    "143": 110,
    "144": 95, "145": 90, "146": 100,
    "147": 64, "148": 84, "149": 134,
    "150": 154,
    "151": 100
};

const BASE_HP = {
    "1": 45, "2": 60, "3": 80, "4": 39, "5": 58, "6": 78, "7": 44, "8": 59, "9": 79,
    "10": 45, "11": 50, "12": 60, "13": 40, "14": 45, "15": 65, "16": 40, "17": 63, "18": 83,
    "19": 30, "20": 55, "21": 40, "22": 65, "23": 35, "24": 60, "25": 35, "26": 60,
    "27": 50, "28": 75, "29": 55, "30": 70, "31": 90, "32": 46, "33": 61, "34": 81,
    "35": 70, "36": 95, "37": 38, "38": 73, "39": 115, "40": 140, "41": 40, "42": 75,
    "43": 45, "44": 60, "45": 75, "46": 35, "47": 60, "48": 60, "49": 70, "50": 10, "51": 35,
    "52": 40, "53": 65, "54": 50, "55": 82, "56": 40, "57": 65, "58": 55, "59": 90,
    "60": 40, "61": 65, "62": 90, "63": 25, "64": 40, "65": 55, "66": 70, "67": 80, "68": 90,
    "69": 50, "70": 65, "71": 80, "72": 40, "73": 80, "74": 40, "75": 55, "76": 80,
    "77": 50, "78": 65, "79": 90, "80": 95, "81": 25, "82": 50, "83": 52, "84": 35, "85": 60,
    "86": 65, "87": 90, "88": 80, "89": 105, "90": 30, "91": 50, "92": 30, "93": 45, "94": 60,
    "95": 35, "96": 60, "97": 85, "98": 30, "99": 55, "100": 40, "101": 60, "102": 60, "103": 95,
    "104": 50, "105": 60, "106": 50, "107": 50, "108": 90, "109": 40, "110": 65,
    "111": 80, "112": 105, "113": 250, "114": 65, "115": 105, "116": 30, "117": 55,
    "118": 45, "119": 80, "120": 30, "121": 60, "122": 40, "123": 70, "124": 65, "125": 65,
    "126": 65, "127": 65, "128": 75, "129": 20, "130": 95, "131": 130, "132": 48, "133": 55,
    "134": 130, "135": 65, "136": 65, "137": 65, "138": 35, "139": 70, "140": 30, "141": 60,
    "142": 80, "143": 160, "144": 90, "145": 90, "146": 90, "147": 41, "148": 61, "149": 91,
    "150": 106, "151": 100
};

const ZONE_MULT = [1, 1.5, 2.2, 3.5, 6];

const TYPES = {
    NORMAL:"Normal", FIRE:"Fire", WATER:"Water", GRASS:"Grass", ELECTRIC:"Electric", ICE:"Ice", 
    FIGHTING:"Fighting", POISON:"Poison", GROUND:"Ground", FLYING:"Flying", PSYCHIC:"Psychic", 
    BUG:"Bug", ROCK:"Rock", GHOST:"Ghost", DRAGON:"Dragon", STEEL:"Steel", DARK:"Dark", FAIRY:"Fairy"
};

const TYPE_CHART = {
    Normal: { Rock: 0.5, Ghost: 0, Steel: 0.5 },
    Fire: { Fire: 0.5, Water: 0.5, Grass: 2, Ice: 2, Bug: 2, Rock: 0.5, Dragon: 0.5, Steel: 2 },
    Water: { Fire: 2, Water: 0.5, Grass: 0.5, Ground: 2, Rock: 2, Dragon: 0.5 },
    Grass: { Fire: 0.5, Water: 2, Grass: 0.5, Poison: 0.5, Ground: 2, Flying: 0.5, Bug: 0.5, Rock: 2, Dragon: 0.5, Steel: 0.5 },
    Electric: { Water: 2, Grass: 0.5, Electric: 0.5, Ground: 0, Flying: 2, Dragon: 0.5 },
    Ice: { Fire: 0.5, Grass: 2, Ice: 0.5, Ground: 2, Flying: 2, Dragon: 2, Steel: 0.5 },
    Fighting: { Normal: 2, Ice: 2, Poison: 0.5, Flying: 0.5, Psychic: 0.5, Bug: 0.5, Rock: 2, Ghost: 0, Dark: 2, Steel: 2, Fairy: 0.5 },
    Poison: { Grass: 2, Poison: 0.5, Ground: 0.5, Rock: 0.5, Ghost: 0.5, Steel: 0, Fairy: 2 },
    Ground: { Fire: 2, Grass: 0.5, Electric: 2, Poison: 2, Flying: 0, Bug: 0.5, Rock: 2, Steel: 2 },
    Flying: { Grass: 2, Electric: 0.5, Fighting: 2, Bug: 2, Rock: 0.5, Steel: 0.5 },
    Psychic: { Fighting: 2, Poison: 2, Psychic: 0.5, Dark: 0, Steel: 0.5 },
    Bug: { Fire: 0.5, Grass: 2, Fighting: 0.5, Poison: 0.5, Flying: 0.5, Psychic: 2, Ghost: 0.5, Dark: 2, Steel: 0.5, Fairy: 0.5 },
    Rock: { Fire: 2, Ice: 2, Fighting: 0.5, Ground: 0.5, Flying: 2, Bug: 2, Steel: 0.5 },
    Ghost: { Normal: 0, Psychic: 2, Ghost: 2, Dark: 0.5 },
    Dragon: { Dragon: 2, Steel: 0.5, Fairy: 0 },
    Steel: { Fire: 0.5, Water: 0.5, Electric: 0.5, Ice: 2, Rock: 2, Steel: 0.5, Fairy: 2 },
    Dark: { Fighting: 0.5, Psychic: 2, Ghost: 2, Dark: 0.5, Fairy: 0.5 },
    Fairy: { Fire: 0.5, Fighting: 2, Poison: 0.5, Dragon: 2, Dark: 2, Steel: 0.5 }
};

const PKMN_TYPES = {
    1: ["Grass", "Poison"], 2: ["Grass", "Poison"], 3: ["Grass", "Poison"],
    4: ["Fire"], 5: ["Fire"], 6: ["Fire", "Flying"],
    7: ["Water"], 8: ["Water"], 9: ["Water"],
    10: ["Bug"], 11: ["Bug"], 12: ["Bug", "Flying"],
    13: ["Bug", "Poison"], 14: ["Bug", "Poison"], 15: ["Bug", "Poison"],
    16: ["Normal", "Flying"], 17: ["Normal", "Flying"], 18: ["Normal", "Flying"],
    19: ["Normal"], 20: ["Normal"],
    21: ["Normal", "Flying"], 22: ["Normal", "Flying"],
    23: ["Poison"], 24: ["Poison"],
    25: ["Electric"], 26: ["Electric"],
    27: ["Ground"], 28: ["Ground"],
    29: ["Poison"], 30: ["Poison"], 31: ["Poison", "Ground"],
    32: ["Poison"], 33: ["Poison"], 34: ["Poison", "Ground"],
    35: ["Fairy"], 36: ["Fairy"], // Retcon Fée
    37: ["Fire"], 38: ["Fire"],
    39: ["Normal", "Fairy"], 40: ["Normal", "Fairy"], // Retcon Fée
    41: ["Poison", "Flying"], 42: ["Poison", "Flying"],
    43: ["Grass", "Poison"], 44: ["Grass", "Poison"], 45: ["Grass", "Poison"],
    46: ["Bug", "Grass"], 47: ["Bug", "Grass"],
    48: ["Bug", "Poison"], 49: ["Bug", "Poison"],
    50: ["Ground"], 51: ["Ground"],
    52: ["Normal"], 53: ["Normal"],
    54: ["Water"], 55: ["Water"],
    56: ["Fighting"], 57: ["Fighting"],
    58: ["Fire"], 59: ["Fire"],
    60: ["Water"], 61: ["Water"], 62: ["Water", "Fighting"],
    63: ["Psychic"], 64: ["Psychic"], 65: ["Psychic"],
    66: ["Fighting"], 67: ["Fighting"], 68: ["Fighting"],
    69: ["Grass", "Poison"], 70: ["Grass", "Poison"], 71: ["Grass", "Poison"],
    72: ["Water", "Poison"], 73: ["Water", "Poison"],
    74: ["Rock", "Ground"], 75: ["Rock", "Ground"], 76: ["Rock", "Ground"],
    77: ["Fire"], 78: ["Fire"],
    79: ["Water", "Psychic"], 80: ["Water", "Psychic"],
    81: ["Electric", "Steel"], 82: ["Electric", "Steel"], // Retcon Acier
    83: ["Normal", "Flying"], 84: ["Normal", "Flying"], 85: ["Normal", "Flying"],
    86: ["Water"], 87: ["Water", "Ice"],
    88: ["Poison"], 89: ["Poison"],
    90: ["Water"], 91: ["Water", "Ice"],
    92: ["Ghost", "Poison"], 93: ["Ghost", "Poison"], 94: ["Ghost", "Poison"],
    95: ["Rock", "Ground"],
    96: ["Psychic"], 97: ["Psychic"],
    98: ["Water"], 99: ["Water"],
    100: ["Electric"], 101: ["Electric"],
    102: ["Grass", "Psychic"], 103: ["Grass", "Psychic"],
    104: ["Ground"], 105: ["Ground"],
    106: ["Fighting"], 107: ["Fighting"],
    108: ["Normal"],
    109: ["Poison"], 110: ["Poison"],
    111: ["Ground", "Rock"], 112: ["Ground", "Rock"],
    113: ["Normal"],
    114: ["Grass"],
    115: ["Normal"],
    116: ["Water"], 117: ["Water"],
    118: ["Water"], 119: ["Water"],
    120: ["Water"], 121: ["Water", "Psychic"],
    122: ["Psychic", "Fairy"], // Retcon Fée
    123: ["Bug", "Flying"],
    124: ["Ice", "Psychic"],
    125: ["Electric"],
    126: ["Fire"],
    127: ["Bug"],
    128: ["Normal"],
    129: ["Water"], 130: ["Water", "Flying"],
    131: ["Water", "Ice"],
    132: ["Normal"],
    133: ["Normal"],
    134: ["Water"],
    135: ["Electric"],
    136: ["Fire"],
    137: ["Normal"],
    138: ["Rock", "Water"], 139: ["Rock", "Water"],
    140: ["Rock", "Water"], 141: ["Rock", "Water"],
    142: ["Rock", "Flying"],
    143: ["Normal"],
    144: ["Ice", "Flying"],
    145: ["Electric", "Flying"],
    146: ["Fire", "Flying"],
    147: ["Dragon"], 148: ["Dragon"], 149: ["Dragon", "Flying"],
    150: ["Psychic"], 151: ["Psychic"]
};

const TYPE_COLORS = {
    Normal: "#A8A77A", Fire: "#EE8130", Water: "#6390F0", Electric: "#F7D02C", Grass: "#7AC74C",
    Ice: "#96D9D6", Fighting: "#C22E28", Poison: "#A33EA1", Ground: "#E2BF65", Flying: "#A98FF3",
    Psychic: "#F95587", Bug: "#A6B91A", Rock: "#B6A136", Ghost: "#735797", Dragon: "#6F35FC",
    Steel: "#B7B7CE", Dark: "#705746", Fairy: "#D685AD"
};

const MILESTONES = [
    {count:10, title:"Débutant", desc:"Dégâts Clic x2"},
    {count:20, title:"Amateur", desc:"+2,500 $P"},
    {count:30, title:"Collectionneur", desc:"DPS Équipe x2"},
    {count:40, title:"Dresseur", desc:"Omni XP (Sac)"},
    {count:50, title:"Expert", desc:"Spawn +20%"},
    {count:70, title:"Champion", desc:"Shop -15%"},
    {count:90, title:"Maître", desc:"Dégâts Totaux x3"},
    {count:110, title:"Légende", desc:"Jeton Brillant"},
    {count:130, title:"Mythique", desc:"Master Ball + 10 Bonbons"},
    {count:151, title:"Kanto Master", desc:"Shiny Chance x2"}
];

// Map names to IDs manually for older entries, but preferred to put ID in ZONE data
const ID_MAP_FALLBACK = {
    "Rattata":19,"Roucool":16,"Rattatac":20,"Roucoups":17,"Bulbizarre":1,"Chenipan":10,"Aspicot":13,"Chrysacier":11,"Coconfort":14,
    "Pikachu":25,"Salamèche":4,"Papilusion":12,"Racaillou":74,"Sabelette":27,"Nidoran♀":29,"Nidoran♂":32,"Onix":95,"Carapuce":7,
    "Nosferapti":41,"Paras":46,"Mélofée":35,"Rondoudou":39,"Leveinard":113,"Mélodelfe":36,"Mystherbe":43,"Chétiflor":69,"Abra":63,
    "Mimitoss":48,"Mew":151,"Roucarnage":18
};

const BADGES = [
    {id:1, zoneIdx:2, name:"Roche", desc:"Dégâts Clic x1.5", img:"boulder-badge"},
    {id:2, zoneIdx:4, name:"Cascade", desc:"DPS Équipe x1.5", img:"cascade-badge"},
    {id:3, zoneIdx:6, name:"Foudre", desc:"Dégâts Totaux +20%", img:"thunder-badge"},
    {id:4, zoneIdx:10, name:"Prisme", desc:"Or gagné x1.5", img:"rainbow-badge"},
    {id:5, zoneIdx:12, name:"Âme", desc:"XP gagnée x1.5", img:"soul-badge"},
    {id:6, zoneIdx:14, name:"Marais", desc:"Taux Capture +20%", img:"marsh-badge"},
    {id:7, zoneIdx:16, name:"Volcan", desc:"Dégâts Totaux x2", img:"volcano-badge"},
    {id:8, zoneIdx:17, name:"Terre", desc:"Vitesse de spawn +20%", img:"earth-badge"}
];

const MAP_DATA = [
    { type: "rect", coords: [300,694,359,762], name: "Route 1", zoneId: 0, color: "orange" },
    { type: "rect", coords: [308,486,352,533], name: "Forêt de Jade", zoneId: 1, color: "blue" },
    { type: "circle", coords: [331,391,37], name: "Arène d'Argenta", zoneId: 2, color: "red" },
    { type: "polygon", coords: [607,307,652,307,652,353,607,353], name: "Mont Sélénite", zoneId: 3, color: "blue" },
    { type: "circle", coords: [931,331,38], name: "Arène d'Azuria", zoneId: 4, color: "red" },
    { type: "rect", coords: [900,248,961,287], name: "Pont Pépite", zoneId: 5, color: "orange" },
    { type: "circle", coords: [931,690,38], name: "Arène de Carmin", zoneId: 6, color: "red" },
    { type: "rect", coords: [968,666,1013,713], name: "Cave Taupiqueur", zoneId: 7, color: "blue" },
    { type: "rect", coords: [1147,307,1193,353], name: "Tunnel Rocheux", zoneId: 8, color: "blue" },
    { type: "circle", coords: [1171,511,38], name: "Lavanville", zoneId: null, color: "gray" }, // Non jouable
    { type: "rect", coords: [1163,502,1209,548], name: "Tour Pokémon", zoneId: 9, color: "blue" },
    { type: "circle", coords: [751,510,38], name: "Arène de Céladopole", zoneId: 10, color: "red" },
    { type: "rect", coords: [1147,367,1193,413], name: "Centrale", zoneId: 11, color: "blue" },
    { type: "circle", coords: [810,870,38], name: "Arène de Parmanie", zoneId: 12, color: "red" },
    { type: "rect", coords: [923,503,969,548], name: "Sylphe SARL", zoneId: 13, color: "blue" },
    { type: "circle", coords: [931,509,37], name: "Arène de Safrania", zoneId: 14, color: "red" },
    { type: "rect", coords: [547,967,593,1013], name: "Îles Écume", zoneId: 15, color: "blue" },
    { type: "circle", coords: [331,992,37], name: "Arène Cramois'Île", zoneId: 16, color: "red" },
    { type: "circle", coords: [331,630,37], name: "Arène de Jadielle", zoneId: 17, color: "red" },
    { type: "polygon", coords: [917,180,917,153,927,153,927,146,956,145,956,152,966,152,966,180,956,180,950,167,934,166,927,180], name: "Caverne Azurée", zoneId: 18, color: "cyan" },
    { type: "rect", coords: [186,368,232,412], name: "Route Victoire", zoneId: 19, color: "blue" },
    { type: "circle", coords: [210,331,37], name: "Ligue Pokémon", zoneId: 20, color: "red" },
    { type: "circle", coords: [331,811,35], name: "Bourg Palette", zoneId: null, color: "gray" },
    { type: "rect", coords: [308,428,352,474], name: "Daran Ass", zoneId: null, color: "gray" }
];

// ZONE CONFIGURATION (Updated with explicit IDs)
const ZONES = [
  // --- DÉBUT DE L'AVENTURE ---
  {id:1, name:"Route 1", bg:"linear-gradient(to bottom, #87CEEB 0%, #90EE90 100%)", minLevel:2, maxLevel:5,
   pokemons:[
     {name:"Rattata", id:19, rarity:"Commun", spawnRate:0.4, catchRate:255},
     {name:"Roucool", id:16, rarity:"Commun", spawnRate:0.4, catchRate:255},
     {name:"Rattatac", id:20, rarity:"Peu Commun", spawnRate:0.1, catchRate:127},
     {name:"Roucoups", id:17, rarity:"Peu Commun", spawnRate:0.05, catchRate:120},
     {name:"Bulbizarre", id:1, rarity:"Très Rare", spawnRate:0.05, catchRate:45} // STARTER 1
   ], boss:{name:"Rattata (Géant)", id:19, level:6, catchRate:0}},
  
  {id:2, name:"Forêt de Jade", bg:"linear-gradient(to bottom, #006400 0%, #228B22 100%)", minLevel:5, maxLevel:8,
   pokemons:[
     {name:"Chenipan", id:10, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Aspicot", id:13, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Chrysacier", id:11, rarity:"Peu Commun", spawnRate:0.15, catchRate:120},
     {name:"Coconfort", id:14, rarity:"Peu Commun", spawnRate:0.15, catchRate:120},
     {name:"Pikachu", id:25, rarity:"Rare", spawnRate:0.15, catchRate:190},
     {name:"Salamèche", id:4, rarity:"Très Rare", spawnRate:0.05, catchRate:45} // STARTER 2
   ], boss:{name:"Papilusion", id:12, level:10, catchRate:0}},

  // BADGE 1 : ROCHE
  {id:3, name:"Arène d'Argenta", bg:"linear-gradient(to bottom, #696969 0%, #A9A9A9 100%)", minLevel:9, maxLevel:12,
   pokemons:[
     {name:"Racaillou", id:74, rarity:"Commun", spawnRate:0.3, catchRate:255},
     {name:"Sabelette", id:27, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Nidoran♀", id:29, rarity:"Peu Commun", spawnRate:0.15, catchRate:235},
     {name:"Nidoran♂", id:32, rarity:"Peu Commun", spawnRate:0.15, catchRate:235},
     {name:"Onix", id:95, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Carapuce", id:7, rarity:"Très Rare", spawnRate:0.05, catchRate:45} // STARTER 3
   ], boss:{name:"Pierre (Onix)", id:95, level:14, catchRate:0, badge:"Roche"}},

  {id:4, name:"Mont Sélénite", bg:"linear-gradient(to bottom, #2F4F4F 0%, #708090 100%)", minLevel:12, maxLevel:15,
   pokemons:[
     {name:"Nosferapti", id:41, rarity:"Commun", spawnRate:0.4, catchRate:255},
     {name:"Paras", id:46, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Mélofée", id:35, rarity:"Rare", spawnRate:0.15, catchRate:150},
     {name:"Rondoudou", id:39, rarity:"Rare", spawnRate:0.15, catchRate:170},
     {name:"Leveinard", id:113, rarity:"Très Rare", spawnRate:0.05, catchRate:30} // LE TANK
   ], boss:{name:"Mélodelfe", id:36, level:16, catchRate:0}},

  // BADGE 2 : CASCADE
  {id:5, name:"Arène d'Azuria", bg:"linear-gradient(to bottom, #00BFFF 0%, #1E90FF 100%)", minLevel:15, maxLevel:18,
   pokemons:[
     {name:"Mystherbe", id:43, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Chétiflor", id:69, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Stari", id:120, rarity:"Peu Commun", spawnRate:0.2, catchRate:225},
     {name:"Poissirène", id:118, rarity:"Peu Commun", spawnRate:0.2, catchRate:225},
     {name:"Psykokwak", id:54, rarity:"Rare", spawnRate:0.1, catchRate:190}
   ], boss:{name:"Ondine (Staross)", id:121, level:21, catchRate:0, badge:"Cascade"}},

  // ZONE SPÉCIALE MEW
  {id:6, name:"Pont Pépite", bg:"linear-gradient(to bottom, #DAA520 0%, #87CEFA 100%)", minLevel:17, maxLevel:20,
   pokemons:[
     {name:"Abra", id:63, rarity:"Commun", spawnRate:0.3, catchRate:200},
     {name:"Roucoups", id:17, rarity:"Commun", spawnRate:0.3, catchRate:120},
     {name:"Mimitoss", id:48, rarity:"Peu Commun", spawnRate:0.2, catchRate:190},
     {name:"Ramoloss", id:79, rarity:"Peu Commun", spawnRate:0.19, catchRate:190},
     {name:"Mew", id:151, rarity:"Légendaire", spawnRate:0.01, catchRate:45} // GLITCH
   ], boss:{name:"Rival (Roucarnage)", id:18, level:23, catchRate:0}},

  // BADGE 3 : FOUDRE
  {id:7, name:"Arène de Carmin", bg:"linear-gradient(to bottom, #FFD700 0%, #DAA520 100%)", minLevel:20, maxLevel:25,
   pokemons:[
     {name:"Voltorbe", id:100, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Magnéti", id:81, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Miaouss", id:52, rarity:"Peu Commun", spawnRate:0.2, catchRate:255},
     {name:"Canarticho", id:83, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Pikachu", id:25, rarity:"Rare", spawnRate:0.1, catchRate:190}
   ], boss:{name:"Major Bob (Raichu)", id:26, level:26, catchRate:0, badge:"Foudre"}},

  {id:8, name:"Cave Taupiqueur", bg:"linear-gradient(to bottom, #8B4513 0%, #A0522D 100%)", minLevel:23, maxLevel:27,
   pokemons:[
     {name:"Taupiqueur", id:50, rarity:"Commun", spawnRate:0.8, catchRate:255},
     {name:"Triopikeur", id:51, rarity:"Très Rare", spawnRate:0.1, catchRate:50},
     {name:"Osselait", id:104, rarity:"Rare", spawnRate:0.1, catchRate:190}
   ], boss:{name:"Triopikeur", id:51, level:29, catchRate:0}},

  {id:9, name:"Tunnel Rocheux", bg:"linear-gradient(to bottom, #000000 0%, #483D8B 100%)", minLevel:25, maxLevel:30,
   pokemons:[
     {name:"Machoc", id:66, rarity:"Commun", spawnRate:0.4, catchRate:180},
     {name:"Férosinge", id:56, rarity:"Commun", spawnRate:0.4, catchRate:190},
     {name:"Gravalanch", id:75, rarity:"Rare", spawnRate:0.15, catchRate:120},
     {name:"Onix", id:95, rarity:"Rare", spawnRate:0.05, catchRate:45}
   ], boss:{name:"Grolem", id:76, level:33, catchRate:0}},

  {id:10, name:"Tour Pokémon", bg:"linear-gradient(to bottom, #4B0082 0%, #800080 100%)", minLevel:28, maxLevel:33,
   pokemons:[
     {name:"Fantominus", id:92, rarity:"Commun", spawnRate:0.6, catchRate:190},
     {name:"Spectrum", id:93, rarity:"Peu Commun", spawnRate:0.25, catchRate:90},
     {name:"Soporifik", id:96, rarity:"Peu Commun", spawnRate:0.1, catchRate:190},
     {name:"Ossatueur", id:105, rarity:"Très Rare", spawnRate:0.05, catchRate:75}
   ], boss:{name:"Ectoplasma", id:94, level:36, catchRate:0}},

  // BADGE 4 : PRISME
  {id:11, name:"Arène de Céladopole", bg:"linear-gradient(to bottom, #32CD32 0%, #98FB98 100%)", minLevel:30, maxLevel:35,
   pokemons:[
     {name:"Goupix", id:37, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Caninos", id:58, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Ortide", id:44, rarity:"Peu Commun", spawnRate:0.2, catchRate:120},
     {name:"Boustiflor", id:70, rarity:"Peu Commun", spawnRate:0.2, catchRate:120},
     {name:"Évoli", id:133, rarity:"Très Rare", spawnRate:0.1, catchRate:45} // CADEAU
   ], boss:{name:"Erika (Empiflor)", id:71, level:39, catchRate:0, badge:"Prisme"}},

  // ZONE LÉGENDAIRE 1
  {id:12, name:"Centrale", bg:"linear-gradient(to bottom, #708090 0%, #FFFF00 100%)", minLevel:32, maxLevel:38,
   pokemons:[
     {name:"Voltorbe", id:100, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Magnéti", id:81, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Élektek", id:125, rarity:"Rare", spawnRate:0.15, catchRate:45},
     {name:"Électrode", id:101, rarity:"Peu Commun", spawnRate:0.2, catchRate:60},
     {name:"Électhor", id:145, rarity:"Légendaire", spawnRate:0.05, catchRate:3} // OISEAU 1
   ], boss:{name:"Électhor", id:145, level:45, catchRate:0}},

  // BADGE 5 : ÂME (Mix Parmanie + Safari pour tout avoir)
  {id:13, name:"Arène de Parmanie", bg:"linear-gradient(to bottom, #800080 0%, #556B2F 100%)", minLevel:35, maxLevel:40,
   pokemons:[
     {name:"Nidorino", id:33, rarity:"Commun", spawnRate:0.2, catchRate:120},
     {name:"Nidorina", id:30, rarity:"Commun", spawnRate:0.2, catchRate:120},
     {name:"Rhinocorne", id:111, rarity:"Peu Commun", spawnRate:0.2, catchRate:120},
     {name:"Kangourex", id:115, rarity:"Rare", spawnRate:0.05, catchRate:45},
     {name:"Insécateur", id:123, rarity:"Rare", spawnRate:0.05, catchRate:45},
     {name:"Scarhino", id:127, rarity:"Rare", spawnRate:0.05, catchRate:45}, // Scarabrute
     {name:"Tauros", id:128, rarity:"Rare", spawnRate:0.05, catchRate:45},
     {name:"Saquedeneu", id:114, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Minidraco", id:147, rarity:"Très Rare", spawnRate:0.05, catchRate:45} // SAFARI
   ], boss:{name:"Koga (Smogogo)", id:110, level:45, catchRate:0, badge:"Âme"}},

  {id:14, name:"Sylphe SARL", bg:"linear-gradient(to bottom, #708090 0%, #B0C4DE 100%)", minLevel:38, maxLevel:43,
   pokemons:[
     {name:"Abo", id:23, rarity:"Commun", spawnRate:0.2, catchRate:255},
     {name:"Smogo", id:109, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Tadmorv", id:88, rarity:"Peu Commun", spawnRate:0.15, catchRate:190},
     {name:"Porygon", id:137, rarity:"Très Rare", spawnRate:0.05, catchRate:45}, // CASINO
     {name:"Lokhlass", id:131, rarity:"Très Rare", spawnRate:0.05, catchRate:45} // CADEAU
   ], boss:{name:"Giovanni (Persian)", id:53, level:47, catchRate:0}},

  // BADGE 6 : MARAIS
  {id:15, name:"Arène de Safrania", bg:"linear-gradient(to bottom, #FF1493 0%, #FF69B4 100%)", minLevel:40, maxLevel:45,
   pokemons:[
     {name:"Abra", id:63, rarity:"Commun", spawnRate:0.3, catchRate:200},
     {name:"Kadabra", id:64, rarity:"Peu Commun", spawnRate:0.2, catchRate:100},
     {name:"M. Mime", id:122, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Kicklee", id:106, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Tygnon", id:107, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Excelangue", id:108, rarity:"Rare", spawnRate:0.15, catchRate:45}
   ], boss:{name:"Sabrina (Alakazam)", id:65, level:48, catchRate:0, badge:"Marais"}},

  // ZONE LÉGENDAIRE 2
  {id:16, name:"Îles Écume", bg:"linear-gradient(to bottom, #00CED1 0%, #E0FFFF 100%)", minLevel:43, maxLevel:48,
   pokemons:[
     {name:"Otaria", id:86, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Kokiyas", id:90, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Krabby", id:98, rarity:"Peu Commun", spawnRate:0.2, catchRate:225},
     {name:"Hypotrempe", id:116, rarity:"Peu Commun", spawnRate:0.15, catchRate:190},
     {name:"Lippoutou", id:124, rarity:"Rare", spawnRate:0.04, catchRate:45},
     {name:"Artikodin", id:144, rarity:"Légendaire", spawnRate:0.05, catchRate:3} // OISEAU 2
   ], boss:{name:"Artikodin", id:144, level:50, catchRate:0}},

  // BADGE 7 : VOLCAN
  {id:17, name:"Arène de Cramois'Île", bg:"linear-gradient(to bottom, #FF4500 0%, #FFA07A 100%)", minLevel:45, maxLevel:50,
   pokemons:[
     {name:"Ponyta", id:77, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Goupix", id:37, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Magmar", id:126, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Amonita", id:138, rarity:"Fossile", spawnRate:0.1, catchRate:45},
     {name:"Kabuto", id:140, rarity:"Fossile", spawnRate:0.1, catchRate:45},
     {name:"Ptéra", id:142, rarity:"Fossile", spawnRate:0.1, catchRate:45}
   ], boss:{name:"Blaine (Arcanin)", id:59, level:54, catchRate:0, badge:"Volcan"}},

  // BADGE 8 : TERRE (Jadielle déplacée avant Azurée)
  {id:18, name:"Arène de Jadielle", bg:"linear-gradient(to bottom, #DEB887 0%, #F5DEB3 100%)", minLevel:50, maxLevel:58,
   pokemons:[
     {name:"Nidorino", id:33, rarity:"Commun", spawnRate:0.25, catchRate:120},
     {name:"Nidorina", id:30, rarity:"Commun", spawnRate:0.25, catchRate:120},
     {name:"Rhinocorne", id:111, rarity:"Peu Commun", spawnRate:0.2, catchRate:120},
     {name:"Triopikeur", id:51, rarity:"Rare", spawnRate:0.15, catchRate:50},
     {name:"Rhinoféros", id:112, rarity:"Rare", spawnRate:0.1, catchRate:60}
   ], boss:{name:"Giovanni (Rhinoféros)", id:112, level:60, catchRate:0, badge:"Terre"}},

  // ZONE LÉGENDAIRE 3 + MEWTWO (Votre demande spécifique)
  {id:19, name:"Caverne Azurée", bg:"linear-gradient(to bottom, #4B0082 0%, #9370DB 100%)", minLevel:55, maxLevel:65,
   pokemons:[
     {name:"Parasect", id:47, rarity:"Commun", spawnRate:0.2, catchRate:75},
     {name:"Kadabra", id:64, rarity:"Commun", spawnRate:0.2, catchRate:100},
     {name:"Raichu", id:26, rarity:"Rare", spawnRate:0.15, catchRate:75},
     {name:"Draco", id:148, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Mewtwo", id:150, rarity:"LÉGENDE", spawnRate:0.01, catchRate:3} // MEWTWO EST ICI
   ], boss:{name:"Mewtwo", id:150, level:70, catchRate:0}},

  // ROUTE VICTOIRE
  {id:20, name:"Route Victoire", bg:"linear-gradient(to bottom, #8B0000 0%, #CD5C5C 100%)", minLevel:60, maxLevel:70,
   pokemons:[
     {name:"Machopeur", id:67, rarity:"Commun", spawnRate:0.3, catchRate:90},
     {name:"Gravalanch", id:75, rarity:"Commun", spawnRate:0.3, catchRate:120},
     {name:"Nosferalto", id:42, rarity:"Commun", spawnRate:0.25, catchRate:90},
     {name:"Sulfura", id:146, rarity:"Légendaire", spawnRate:0.02, catchRate:3}, // OISEAU 3
     {name:"Dracolosse", id:149, rarity:"Rare", spawnRate:0.05, catchRate:45}
   ], boss:{name:"Sulfura", id:146, level:75, catchRate:0}},

  // LA LIGUE (Final Boss)
  {id:21, name:"Ligue Pokémon", bg:"linear-gradient(to bottom, #191970 0%, #FFD700 100%)", minLevel:70, maxLevel:90,
   pokemons:[
     // OLGA (Glace/Eau)
     {name:"Lokhlass", id:131, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Lippoutou", id:124, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     
     // ALDO (Combat/Roche)
     {name:"Mackogneur", id:68, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Onix", id:95, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     
     // AGATHA (Spectre/Poison)
     {name:"Ectoplasma", id:94, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Arbok", id:24, rarity:"Conseil 4", spawnRate:0.1, catchRate:90},
     
     // PETER (Dragon)
     {name:"Dracolosse", id:149, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Léviator", id:130, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},

     // MAÎTRE BLUE (Son 1er Pokémon)
     {name:"Roucarnage", id:18, rarity:"Maître", spawnRate:0.1, catchRate:45}
   ], 
   // Le Boss est défini dynamiquement
   boss:{name:"Maître Blue", id:9, level:100, catchRate:0}}
];

// --- STATE ---
let state = {
    money: 0, 
    inv: { balls: 5, superballs: 0, hyperballs: 0, candy: 0, omniXp: 0, shinyToken: 0, masterball: 0, repel: 0, xAttack: 0, xSpecial: 0, superRepel: 0, pokeDoll: 0 },
    upgrades: { runningShoes: false, amuletCoin: false, protein: false, expShare: false, hardStone: false, bicycle: false, luckyEgg: false, leftovers: false },
    team: [], 
    pc: [],
    pokedex: [],
    badges: [],
    milestones: [],
    repelEndTime: 0,
    attackBoostEndTime: 0,
    dpsBoostEndTime: 0,
    superRepelEndTime: 0,
    zoneIdx: 0, 
    subStage: 1, 
    unlockedZone: 0,
    auto: true, 
    autoClicker: false,
    starterId: null,
    cheat: false,
    stats: { kills: 0 },
    stopOnRare: true,
    swapIdx: null,
    candyMode: false,
    candyTargetIdx: null,
    candyAmount: 1
};

// Runtime variables (not saved)
let enemy = { hp: 10, maxHp: 10, id: 0, level: 1, isBoss: false, isShiny: false, catchRate: 1, name: "", rarity: "Commun", dead: false };
let audioCtx = false, synth = null;
let bossTimer = null;
let autoSaveInterval = null;
let autoClickerInterval = null;

// --- INIT ---
function init() {
    // Check for save
    if (localStorage.getItem('pokiClickerSave')) {
        document.getElementById('starter-modal').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('game-ui').classList.remove('opacity-0');
        loadGame();
    } else {
        document.getElementById('starter-modal').classList.remove('hidden');
    }
}

function startGame(starterId) {
    state.starterId = starterId;
    let name = starterId===1?"Bulbizarre":starterId===4?"Salamèche":"Carapuce";
    addToTeam(starterId, name, 5, false);
    addToPokedex(starterId);
    
    document.getElementById('starter-modal').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    
    // Fade in
    setTimeout(()=>document.getElementById('game-ui').classList.remove('opacity-0'), 100);
    
    initAudio();
    spawnEnemy();
    updateBg(); 
    updateUI(); 
    renderShop(); 
    renderBag();
    startAutoClicker();
    startAutoSave();
}

function startAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
        localStorage.setItem('pokiClickerSave', JSON.stringify(state));
    }, 10000); // Save every 10s
}

function initAudio() { 
    if(!audioCtx) { 
        audioCtx=true; 
        try {
            synth=new Tone.PolySynth(Tone.Synth).toDestination(); 
            synth.volume.value=-12; 
        } catch(e) { console.log("Audio disabled"); }
    } 
}

function playTone(t) {
    if(!audioCtx || !synth) return;
    try {
        const now = Tone.now();
        if(t==='hit') synth.triggerAttackRelease("C2","32n",now);
        if(t==='coin') synth.triggerAttackRelease("B4","16n",now);
        if(t==='catch') synth.triggerAttackRelease(["C4","E4","G4"],"16n",now);
        if(t==='up') synth.triggerAttackRelease(["G3","C4"],"16n",now);
        if(t==='pc') synth.triggerAttackRelease(["E5","C5"],"16n",now);
    } catch(e){}
}

// --- CORE MECHANICS ---

function getPower(id) {
    const atk = BASE_STATS[id] || 40;
    const hp = BASE_HP[id] || 40;
    return atk + hp;
}

function calcMaxXp(id, level) {
    const power = getPower(id);
    let tier = (power < 100) ? 0.8 : (power > 180) ? 1.25 : 1.0;
    return Math.floor(((4 * Math.pow(level, 3)) * tier * 5) / 3);
}

function getTypes(id) {
    return PKMN_TYPES[id] || ["Normal"];
}

function getMultiplier(atkId, defId) {
    if(!defId) return 1;
    const atkType = getTypes(atkId)[0]; // Primary type attacks
    const defTypes = getTypes(defId);
    let mult = 1;
    
    defTypes.forEach(dt => {
        if(TYPE_CHART[atkType] && TYPE_CHART[atkType][dt] !== undefined) {
            mult *= TYPE_CHART[atkType][dt];
        }
    });
    return mult;
}

function hasBadge(name) { return state.badges.includes(name); }

function hasMilestone(c) { return state.milestones.includes(c); }

function getDPS(targetId) { 
    let dps = state.team.reduce((s,p) => {
        let m = targetId ? getMultiplier(p.id, targetId) : 1;
        let shinyBonus = p.isShiny ? 2 : 1; // Shiny deals x2 damage
        let baseStat = BASE_STATS[p.id] || 40; // Fallback if ID missing
        let rawDmg = (baseStat * p.level) / 5;
        return s + (rawDmg * m * shinyBonus);
    }, 0); 
    
    if(hasMilestone(30)) dps *= 2;
    if(hasMilestone(90)) dps *= 3;
    if(state.upgrades.expShare) dps *= 1.5;
    if(hasBadge("Cascade")) dps *= 1.5;
    if(hasBadge("Foudre")) dps *= 1.2;
    if(hasBadge("Volcan")) dps *= 2;
    dps *= (1 + state.unlockedZone * 0.1);
    if(Date.now() < state.dpsBoostEndTime) dps *= 2;
    return dps;
}

function getClick() { 
    let dmg = 5 + Math.floor(getDPS(enemy.id)*0.03);
    if(hasMilestone(10)) dmg *= 2;
    if(hasMilestone(90)) dmg *= 3;
    if(state.upgrades.protein) dmg = Math.floor(dmg * 1.5);
    if(state.upgrades.hardStone) dmg = Math.floor(dmg * 1.3);
    if(hasBadge("Roche")) dmg = Math.floor(dmg * 1.5);
    if(hasBadge("Foudre")) dmg = Math.floor(dmg * 1.2);
    if(hasBadge("Volcan")) dmg *= 2;
    dmg = Math.floor(dmg * (1 + state.unlockedZone * 0.1));
    if(Date.now() < state.attackBoostEndTime) dmg *= 2;
    return state.cheat ? 99999 : dmg; 
}

function toggleCheat() {
    state.cheat = !state.cheat;
    const b = document.getElementById('cheat-btn');
    const base = "absolute bottom-4 left-4 z-40 px-3 py-1 rounded text-xs font-bold transition-all";
    b.className = state.cheat ? 
        `${base} bg-red-600 text-white border-red-400 cheat-active` : 
        `${base} bg-gray-800 text-gray-400 border border-gray-600 hover:bg-gray-700 opacity-50 hover:opacity-100`;
    b.innerText = state.cheat ? "CHEAT: ON" : "CHEAT: OFF";
    renderShop();
    updateZone();
}

function startBossTimer() {
    const w = document.getElementById('boss-timer-wrapper');
    const b = document.getElementById('boss-timer-bar');
    w.classList.remove('hidden');
    b.style.width = "100%";
    
    let t = 30;
    bossTimer = setInterval(() => {
        t--;
        b.style.width = (t/30*100)+"%";
        if(t<=0) {
            stopBossTimer();
            showFeedback("TEMPS ÉCOULÉ !", "red");
            state.subStage = 9;
            updateZone();
            spawnEnemy();
        }
    }, 1000);
}

function stopBossTimer() {
    if(bossTimer) clearInterval(bossTimer);
    bossTimer = null;
    const w = document.getElementById('boss-timer-wrapper');
    if(w) w.classList.add('hidden');
}

function spawnEnemy() {
    stopBossTimer();
    enemy.dead = false;
    enemy.uid = Date.now(); // Unique ID to prevent race conditions
    const z = ZONES[state.zoneIdx];
    enemy.isBoss = (state.subStage === 10);
    
    let shinyChance = hasMilestone(151) ? (1/128) : (1/256);
    enemy.isShiny = !enemy.isBoss && Math.random() < shinyChance; 
    
    if(enemy.isBoss) {
        enemy.name = z.boss.name; 
        enemy.level = z.boss.level; 
        enemy.catchRate = z.boss.catchRate;
        enemy.id = z.boss.id;

        // --- LOGIQUE BOSS FINAL (MAÎTRE BLUE) ---
        // Zone 21 est à l'index 20
        if (state.zoneIdx === 20) { 
            if (state.starterId === 1) { // Joueur a Bulbizarre -> Rival a Dracaufeu
                enemy.id = 6; 
            } else if (state.starterId === 4) { // Joueur a Salamèche -> Rival a Tortank
                enemy.id = 9;
            } else if (state.starterId === 7) { // Joueur a Carapuce -> Rival a Florizarre
                enemy.id = 3;
            }
        }
        enemy.rarity = "Boss";
        startBossTimer();
    } else {
        const r = Math.random(); 
        let acc = 0; 
        
        // Repel Logic
        let pool = z.pokemons;
        if(Date.now() < state.superRepelEndTime) {
            const filtered = pool.filter(p => p.rarity !== "Commun" && p.rarity !== "Peu Commun");
            if(filtered.length > 0) pool = filtered;
        } else if(Date.now() < state.repelEndTime) {
            const filtered = pool.filter(p => p.rarity !== "Commun");
            if(filtered.length > 0) pool = filtered;
        }

        let sel = pool[0];
        for(let p of pool) { 
            acc += p.spawnRate; 
            if(r <= acc) { sel = p; break; } 
        }
        enemy.name = sel.name; 
        enemy.rarity = sel.rarity;
        enemy.id = sel.id || ID_MAP_FALLBACK[sel.name] || 25; 
        enemy.catchRate = sel.catchRate;
        enemy.level = Math.floor(Math.random()*(z.maxLevel-z.minLevel+1))+z.minLevel;
    }

    // Stop auto battle for rares
    if((["Rare","Très Rare","Légendaire"].includes(enemy.rarity) || enemy.isShiny) && state.stopOnRare && (state.auto || state.autoClicker)) {
        state.auto = false; 
        state.autoClicker = false;
        updateAutoBtn(); updateAutoClickerBtn();
        const a = document.getElementById('rare-alert'); 
        const msg = enemy.isShiny ? "SHINY APPARU ! AUTO STOPPÉ !" : "POKÉMON RARE ! AUTO STOPPÉ !";
        a.firstElementChild.innerHTML = `<span class="material-symbols-outlined">warning</span> ${msg}`;
        a.classList.remove('hidden');
        setTimeout(()=>a.classList.add('hidden'), 3000);
    }

    // HP Scaling
    const baseHp = BASE_HP[enemy.id] || 40;
    const zoneMult = ZONE_MULT[state.zoneIdx] || (6 + (state.zoneIdx - 4) * 2.5);
    enemy.maxHp = Math.floor((baseHp * enemy.level * 2) * zoneMult);
    if(enemy.isBoss) enemy.maxHp *= 4;
    enemy.hp = enemy.maxHp;
    updateUI(); // Refresh DPS display for new enemy
    updateEnemyUI();
    renderTeam(); // Refresh team DPS multipliers for new enemy
}

function damageEnemy(amt) {
    if(enemy.dead) return;
    enemy.hp -= amt;
    if(enemy.hp <= 0) {
        enemy.hp = 0;
        killEnemy();
    }
    updateHp();
}

function killEnemy() {
    if(enemy.dead) return; 
    stopBossTimer();
    enemy.dead = true;
    state.stats.kills++;
    
    let baseGold = 10 * Math.pow(1.5, state.zoneIdx);
    let variance = 0.8 + (Math.random() * 0.4); // +/- 20%
    let gold = Math.floor(baseGold * variance);

    if(enemy.isBoss) gold*=5;
    if(state.upgrades.amuletCoin) gold = Math.floor(gold * 1.5);
    if(hasBadge("Prisme")) gold = Math.floor(gold * 1.5);
    if(enemy.isShiny) {
        gold *= 5;
        state.inv.candy += 5;
        showFeedback("SHINY! +5 BONBONS", "purple");
    }

    state.money += gold;
    
    // XP Logic
    const baseHp = BASE_HP[enemy.id] || 40;
    let xpGain = Math.floor((baseHp * enemy.level) / 2);
    if (state.upgrades.expShare) xpGain = Math.floor(xpGain * 1.5);
    if (state.upgrades.luckyEgg) xpGain = Math.floor(xpGain * 1.5);
    if (state.inv.omniXp > 0) xpGain = Math.floor(xpGain * 1.5);
    if(hasBadge("Âme")) xpGain = Math.floor(xpGain * 1.5);
    
    state.team.forEach(p => {
        if(p.level < 100) {
            p.xp += xpGain;
            if(p.xp >= p.maxXp) {
                p.level++;
                p.xp -= p.maxXp;
                p.maxXp = calcMaxXp(p.id, p.level);
                playTone('up');
                if(p.level >= 100) { p.level = 100; p.xp = 0; p.maxXp = 0; }
            }
        }
    });

    playTone('coin');

    if(enemy.isBoss) {
        checkBadges();
        if(state.zoneIdx === state.unlockedZone && state.zoneIdx < ZONES.length-1) {
            state.unlockedZone++;
            showFeedback("ZONE DÉBLOQUÉE !", "yellow");
            renderShop(); 
            renderPC();
            // Allow user to stay on boss stage if they want, but usually reset
            state.subStage = 1; 
        } else {
             state.subStage = 1;
        }
    } else {
        if(state.subStage < 10) state.subStage++;
    }
    
    updateUI(); 
    updateZone();
    
    let spawnDelay = hasMilestone(50) ? 200 : 250;
    if(hasBadge("Terre")) spawnDelay = Math.floor(spawnDelay / 1.2);
    if(state.upgrades.bicycle) spawnDelay /= 3;
    else if(state.upgrades.runningShoes) spawnDelay /= 1.5;
    setTimeout(spawnEnemy, spawnDelay);
}

function attemptCatch(type) {
    if(enemy.dead || enemy.catchRate === 0) { showFeedback("IMPOSSIBLE !", "red"); return; }
    if(type === 'poke' && state.inv.balls <= 0) { shakeBtn('catch-btn'); return; }
    if(type === 'super' && state.inv.superballs <= 0) { shakeBtn('super-catch-btn'); return; }
    if(type === 'hyper' && state.inv.hyperballs <= 0) { shakeBtn('hyper-catch-btn'); return; }
    if(type === 'master' && state.inv.masterball <= 0) { shakeBtn('master-catch-btn'); return; }

    const captureUid = enemy.uid; // Capture current enemy ID
    if(type === 'poke') state.inv.balls--; 
    else if(type === 'super') state.inv.superballs--;
    else if(type === 'hyper') state.inv.hyperballs--;
    else if(type === 'master') state.inv.masterball--;
    updateUI(); renderBag();

    let ballMult = type === 'super' ? 2 : 1;
    if(type === 'hyper') ballMult = 4;
    let chance = (enemy.catchRate / 255) * ballMult;
    if(hasBadge("Marais")) chance *= 1.2;
    if(type === 'master') chance = 999;

    const img = document.getElementById('enemy-sprite');
    img.classList.remove('pokemon-float'); 
    img.classList.add('catching');

    setTimeout(() => {
        if(enemy.uid !== captureUid) return; // Timer killed enemy during animation
        if(Math.random() < chance) {
            stopBossTimer();
            enemy.dead = true;
            playTone('catch');
            let cleanName = enemy.name.replace(/\s*\(.*\)/,""); // Remove (Géant) etc
            addToPokedex(enemy.id);
            
            if(state.team.length < 6) { 
                addToTeam(enemy.id, cleanName, enemy.level, enemy.isShiny); 
                showFeedback("CAPTURÉ !", "yellow"); 
            } else { 
                addToPC(enemy.id, cleanName, enemy.level, enemy.isShiny); 
                showFeedback("ENVOYÉ AU PC", "blue"); 
            }
            
            state.money += Math.floor(enemy.maxHp/5) * (enemy.isShiny ? 5 : 1);
            if(enemy.isShiny) {
                state.inv.candy += 5;
                showFeedback("SHINY! +5 BONBONS", "purple");
            }
            
            if(enemy.isBoss) {
                checkBadges();
                if(state.zoneIdx===state.unlockedZone && state.zoneIdx<ZONES.length-1) { 
                    state.unlockedZone++; renderShop(); renderPC(); 
                }
                state.subStage = 1;
            } else { 
                if(state.subStage < 10) state.subStage++; 
            }
            
            updateUI(); updateZone();
            img.style.opacity = '0';
            setTimeout(() => { 
                spawnEnemy(); 
                img.style.opacity='1'; 
                img.classList.remove('catching'); 
                img.classList.add('pokemon-float'); 
            }, 1000);
        } else {
            img.classList.remove('catching'); 
            img.classList.add('pokemon-float');
            showFeedback("ÉCHAPPÉ !", "red");
            // Penalty? Maybe enemy heals a bit?
        }
    }, 1000);
}

// --- HELPERS ---
function getSprite(id) {
    return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}
function getArtwork(id) {
    return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
}

function addToTeam(id,n,l,s) { 
    const maxXp = calcMaxXp(id, l);
    state.team.push({id:id, name:n, level:l, isShiny:s, xp:0, maxXp:maxXp, uid:Date.now() + Math.random(), img:getSprite(id)}); 
    renderTeam(); 
}
function addToPC(id,n,l,s) { 
    const maxXp = calcMaxXp(id, l);
    state.pc.push({id:id, name:n, level:l, isShiny:s, xp:0, maxXp:maxXp, uid:Date.now() + Math.random(), img:getSprite(id)}); 
    renderPC(); 
}

function addToPokedex(id) {
    if(!state.pokedex.includes(id)) {
        state.pokedex.push(id);
        checkMilestones();
    }
}

function useShinyToken(uid) {
    let p = state.team.find(x=>x.uid===uid);
    if(p && !p.isShiny && state.inv.shinyToken > 0) {
        state.inv.shinyToken--; p.isShiny = true;
        playTone('up'); showFeedback("SHINY !!!", "purple");
        renderTeam(); renderBag();
    }
}

function useRepel() {
    if(state.inv.repel > 0) {
        state.inv.repel--;
        state.repelEndTime = Date.now() + 30000;
        showFeedback("REPOUSSE ACTIF !", "gray");
        renderBag();
    }
}

function useXAttack() {
    if(state.inv.xAttack > 0) {
        state.inv.xAttack--;
        state.attackBoostEndTime = Date.now() + 60000;
        showFeedback("ATTAQUE + ACTIF !", "red");
        renderBag();
    }
}

function useXSpecial() {
    if(state.inv.xSpecial > 0) {
        state.inv.xSpecial--;
        state.dpsBoostEndTime = Date.now() + 60000;
        showFeedback("DPS x2 ACTIF !", "blue");
        renderBag();
    }
}

function useSuperRepel() {
    if(state.inv.superRepel > 0) {
        state.inv.superRepel--;
        state.superRepelEndTime = Date.now() + 30000;
        showFeedback("SUPER REPOUSSE !", "gray");
        renderBag();
    }
}

function usePokeDoll() {
    if(state.inv.pokeDoll > 0) {
        if(state.unlockedZone > state.zoneIdx) {
            state.inv.pokeDoll--;
            state.subStage = 10;
            spawnEnemy();
            showFeedback("BOSS INVOQUÉ !", "purple");
            renderBag();
        } else {
            showFeedback("BOSS NON VAINCU !", "red");
        }
    }
}

function initCandyUse() {
    if(state.inv.candy <= 0) return;
    state.candyMode = true;
    state.candyTargetIdx = null;
    showFeedback("SÉLECTIONNEZ UN POKÉMON", "blue");
    renderTeam();
}

function handleTeamClick(i) {
    if(state.swapIdx !== null) {
        confirmSwap(i);
    } else if (state.candyMode) {
        if(state.team[i].level >= 100) {
            showFeedback("NIVEAU MAX !", "red");
            return;
        }
        state.candyTargetIdx = i;
        state.candyAmount = 1;
        renderTeam();
    }
}

function adjustCandyAmount(delta) {
    if (state.candyTargetIdx === null) return;
    const p = state.team[state.candyTargetIdx];
    const maxUse = Math.min(state.inv.candy, 100 - p.level);
    
    let newAmt = state.candyAmount + delta;
    if (newAmt < 1) newAmt = 1;
    if (newAmt > maxUse) newAmt = maxUse;
    
    state.candyAmount = newAmt;
    renderTeam();
}

function confirmCandyUse() {
    if (state.candyTargetIdx === null) return;
    const i = state.candyTargetIdx;
    const p = state.team[i];
    const count = state.candyAmount;
    
    if(count > 0 && state.inv.candy >= count) {
        state.inv.candy -= count;
        p.level += count;
        p.maxXp = calcMaxXp(p.id, p.level);
        playTone('up'); 
        showFeedback(`+${count} NIVEAUX !`, "green");
        
        state.candyMode = false;
        state.candyTargetIdx = null;
        updateUI(); renderBag(); renderTeam(); 
    }
}

function cancelCandyUse() {
    state.candyMode = false;
    state.candyTargetIdx = null;
    renderTeam();
}

function evolve(uid) {
    let p = state.team.find(x=>x.uid===uid);
    let ed = EVOLUTIONS[p.id];
    if(p && ed && p.level>=ed.lvl) { 
        p.id=ed.id; 
        p.name=ed.name; 
        p.img=getSprite(p.id); 
        addToPokedex(p.id);
        renderTeam(); 
        playTone('up'); 
        showFeedback("ÉVOLUTION !", "purple");
    }
}

function getPrice(base) {
    if(state.cheat) return 1;
    if(hasMilestone(70)) return Math.floor(base * 0.85);
    return base;
}

function buyItem(id) {
    const item = ITEMS[id];
    if(!item) return;
    
    let p = getPrice(item.price);
    
    if(state.money >= p) {
        if(item.type === 'upgrade' && state.upgrades[id]) return; // Already owned
        
        state.money -= p;
        
        if(item.type === 'consumable') {
            state.inv[item.invKey]++;
        } else {
            state.upgrades[id] = true;
        }
        
        updateUI(); renderBag(); renderShop();
    }
}

// --- SAVE SYSTEM ---
function exportSave() {
    const json = JSON.stringify(state);
    const blob = new Blob([json], {type: "application/json;charset=utf-8"});
    saveAs(blob, "pokiclicker_save.json");
    showFeedback("SAUVEGARDÉ", "green");
}

function loadSaveFile() {
    document.getElementById('file-input').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            loadData(data);
            document.getElementById('starter-modal').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('opacity-0');
        } catch(err) {
            alert("Sauvegarde invalide !");
        }
    };
    reader.readAsText(file);
}

function loadGame() {
    const saved = localStorage.getItem('pokiClickerSave');
    if(saved) loadData(JSON.parse(saved));
}

function loadData(data) {
    state = {...state, ...data};
    // Init new fields if missing
    state.candyMode = false;
    state.candyTargetIdx = null;
    state.candyAmount = 1;
    if(state.starterId === undefined) state.starterId = null;
    if(!state.pokedex) state.pokedex = [];
    if(!state.milestones) state.milestones = [];
    if(!state.badges) state.badges = [];
    if(state.inv.omniXp === undefined) state.inv.omniXp = 0;
    if(state.inv.shinyToken === undefined) state.inv.shinyToken = 0;
    if(state.inv.masterball === undefined) state.inv.masterball = 0;
    if(state.inv.repel === undefined) state.inv.repel = 0;
    if(state.inv.hyperballs === undefined) state.inv.hyperballs = 0;
    if(state.inv.xAttack === undefined) state.inv.xAttack = 0;
    if(state.inv.xSpecial === undefined) state.inv.xSpecial = 0;
    if(state.inv.superRepel === undefined) state.inv.superRepel = 0;
    if(state.inv.pokeDoll === undefined) state.inv.pokeDoll = 0;
    if(!state.attackBoostEndTime) state.attackBoostEndTime = 0;
    if(!state.dpsBoostEndTime) state.dpsBoostEndTime = 0;
    if(!state.superRepelEndTime) state.superRepelEndTime = 0;
    if(!state.upgrades) state.upgrades = { runningShoes: false, amuletCoin: false, protein: false, expShare: false };
    if(!state.repelEndTime) state.repelEndTime = 0;
    if(state.stopOnRare === undefined) state.stopOnRare = true;
    
    // Re-bind images and init XP if missing (for old saves)
    const initP = (p) => {
        if(!p.img) p.img = getSprite(p.id);
        if(p.xp === undefined) p.xp = 0;
        if(p.maxXp === undefined) p.maxXp = calcMaxXp(p.id, p.level);
    };
    
    state.team.forEach(initP);
    state.pc.forEach(initP);
    
    initAudio();
    updateUI(); renderTeam(); renderBag(); renderShop(); renderPC(); updateZone(); updateBg();
    spawnEnemy(); startAutoClicker();
    startAutoSave();
}

function checkMilestones() {
    const count = state.pokedex.length;
    MILESTONES.forEach(m => {
        if(count >= m.count && !state.milestones.includes(m.count)) {
            state.milestones.push(m.count);
            showFeedback(`PALIER ${m.count}: ${m.title}`, "yellow");
            
            // One-time rewards
            if(m.count === 20) state.money += 2500;
            if(m.count === 40) state.inv.omniXp++;
            if(m.count === 110) state.inv.shinyToken++;
            if(m.count === 130) { state.inv.masterball++; state.inv.candy+=10; }
            
            updateUI(); renderBag();
        }
    });
}

function checkBadges() {
    BADGES.forEach(b => {
        if(state.zoneIdx === b.zoneIdx && !state.badges.includes(b.name)) {
            state.badges.push(b.name);
            showFeedback(`BADGE ${b.name.toUpperCase()} OBTENU !`, "yellow");
            playTone('up');
        }
    });
}

function togglePokedex() {
    const m = document.getElementById('pokedex-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderPokedex();
    } else {
        m.classList.add('hidden');
    }
}

function toggleBadges() {
    const m = document.getElementById('badges-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderBadges();
    } else {
        m.classList.add('hidden');
    }
}

function toggleMilestones() {
    const m = document.getElementById('milestones-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderMilestones();
    } else {
        m.classList.add('hidden');
    }
}

function toggleMap() {
    const m = document.getElementById('map-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderMap();
    } else {
        m.classList.add('hidden');
    }
}

function flyToZone(zoneId) {
    const overlay = document.getElementById('gen1-fly-overlay');
    const trainer = document.getElementById('fly-trainer');
    const mapModal = document.getElementById('map-modal');
    const mapContainer = document.getElementById('map-container');
    const mapImg = mapContainer.querySelector('img');

    // Prevent multiple clicks during animation
    if (overlay.style.display === 'flex') return;

    // 1. Find current zone coordinates to position the trainer
    const currentArea = MAP_DATA.find(a => a.zoneId === state.zoneIdx);
    if (!currentArea) return;

    let centerX, centerY;
    const coords = currentArea.coords;
    if (currentArea.type === 'circle') {
        centerX = coords[0];
        centerY = coords[1];
    } else if (currentArea.type === 'rect') {
        centerX = (coords[0] + coords[2]) / 2;
        centerY = (coords[1] + coords[3]) / 2;
    } else if (currentArea.type === 'polygon') {
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        for (let i = 0; i < coords.length; i += 2) {
            minX = Math.min(minX, coords[i]);
            maxX = Math.max(maxX, coords[i]);
            minY = Math.min(minY, coords[i+1]);
            maxY = Math.max(maxY, coords[i+1]);
        }
        centerX = (minX + maxX) / 2;
        centerY = (minY + maxY) / 2;
    }

    // Convert to percentage for absolute positioning
    trainer.style.left = `${(centerX / mapImg.naturalWidth) * 100}%`;
    trainer.style.top = `${(centerY / mapImg.naturalHeight) * 100}%`;
    trainer.classList.remove('hidden');

    // 2. Wait a bit, then start the fly animation
    setTimeout(() => {
        // Show overlay (Black Band)
        overlay.style.display = 'flex';
        
        setTimeout(() => {
            overlay.classList.add('active');
        }, 50);

        // 3. Set timeout for the duration of the fly animation
        setTimeout(() => {
            // Execute the zone change
            if(state.cheat && zoneId > state.unlockedZone) state.unlockedZone = zoneId;
            state.zoneIdx = zoneId; 
            state.subStage = 1; 
            updateBg(); renderShop(); renderBag(); renderPC(); spawnEnemy(); 
            
            // Close map and hide/reset animation overlay
            overlay.classList.remove('active');
            overlay.classList.add('closing');
            
            setTimeout(() => {
                mapModal.classList.add('hidden');
                overlay.style.display = 'none';
                overlay.classList.remove('closing');
                
                trainer.classList.add('hidden');
            }, 500);
        }, 2500); // 2.5s animation
    }, 600); // Wait for trainer to appear and pose
}

function renderMap() {
    const img = document.querySelector('#map-container img');
    const c = document.getElementById('map-svg');
    
    if (!img.complete || img.naturalWidth === 0) {
        img.onload = () => renderMap();
        return;
    }
    
    c.setAttribute('viewBox', `0 0 ${img.naturalWidth} ${img.naturalHeight}`);
    c.innerHTML = "";
    
    MAP_DATA.forEach(area => {
        const isUnlocked = area.zoneId !== null && (area.zoneId <= state.unlockedZone || state.cheat);
        const isCurrent = area.zoneId === state.zoneIdx;
        
        // Determine Color
        let fillClass = "fill-gray-600/50"; // Default Locked/Placeholder
        if (isUnlocked) {
            if (area.color === "red") fillClass = "fill-red-500/50";
            else if (area.color === "orange") fillClass = "fill-amber-500/50";
            else if (area.color === "cyan") fillClass = "fill-cyan-400/50";
            else fillClass = "fill-blue-500/50";
        }
        if (isCurrent) fillClass = "fill-green-400/70 animate-pulse";

        // Create SVG Element
        let el = document.createElementNS("http://www.w3.org/2000/svg", area.type);
        
        if (area.type === "rect") {
            el.setAttribute("x", area.coords[0]);
            el.setAttribute("y", area.coords[1]);
            el.setAttribute("width", area.coords[2] - area.coords[0]);
            el.setAttribute("height", area.coords[3] - area.coords[1]);
        } else if (area.type === "circle") {
            el.setAttribute("cx", area.coords[0]);
            el.setAttribute("cy", area.coords[1]);
            el.setAttribute("r", area.coords[2]);
        } else if (area.type === "polygon") {
            el.setAttribute("points", area.coords.join(" "));
        }

        el.setAttribute("class", `${fillClass} stroke-white stroke-2 transition-all duration-300 hover:stroke-yellow-400 hover:fill-opacity-80 cursor-pointer`);
        
        // Tooltip Title
        let title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent = area.zoneId !== null ? `${area.name} (Zone ${area.zoneId + 1})` : area.name;
        el.appendChild(title);

        if (isUnlocked) {
            el.onclick = () => { 
                flyToZone(area.zoneId);
            };
        }
        c.appendChild(el);
    });
}

function renderMilestones() {
    const l = document.getElementById('milestones-list');
    l.innerHTML = "";
    
    MILESTONES.forEach(m => {
        const unlocked = state.pokedex.length >= m.count;
        const div = document.createElement('div');
        div.className = `p-3 rounded border flex justify-between items-center ${unlocked ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 grayscale opacity-50'}`;
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${unlocked ? 'bg-yellow-500 text-black' : 'bg-slate-800 text-gray-500'}">${m.count}</div>
                <div>
                    <div class="font-bold ${unlocked ? 'text-yellow-400' : 'text-gray-400'}">${m.title}</div>
                    <div class="text-xs text-gray-300">${m.desc}</div>
                </div>
            </div>
            ${unlocked ? '<span class="material-symbols-outlined text-green-400">check_circle</span>' : '<span class="material-symbols-outlined text-gray-600">lock</span>'}
        `;
        l.appendChild(div);
    });
}

function renderBadges() {
    const g = document.getElementById('badges-grid');
    g.innerHTML = "";
    
    BADGES.forEach(b => {
        const unlocked = state.badges.includes(b.name);
        const div = document.createElement('div');
        div.className = `aspect-square rounded-full border-4 flex items-center justify-center relative transition-all group ${unlocked ? 'bg-slate-700 border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.5)]' : 'bg-slate-900 border-slate-700 grayscale opacity-50'}`;
        div.innerHTML = `
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${b.img}.png" class="w-16 h-16 object-contain ${unlocked?'':'brightness-0 invert opacity-30'}">
        `;
        div.onmouseenter = () => document.getElementById('badge-tooltip').innerHTML = `<span class="text-yellow-400 font-bold">${b.name}</span>: ${b.desc}`;
        div.onmouseleave = () => document.getElementById('badge-tooltip').innerText = "Survolez un badge pour voir son effet";
        g.appendChild(div);
    });
    
    if(state.badges.length === 0) {
        document.getElementById('badge-tooltip').innerText = "Aucun badge obtenu. Battez les champions d'arène !";
    }
}

function resetSave() {
    if(confirm("Effacer la sauvegarde locale et recommencer ?")) {
        localStorage.removeItem('pokiClickerSave');
        location.reload();
    }
}

// --- UI LOGIC ---

function initSwap(idx) {
    if(state.team.length < 6) {
        let p = state.pc.splice(idx,1)[0]; 
        state.team.push(p);
        playTone('pc'); 
        renderTeam(); renderPC();
    } else {
        state.swapIdx = idx;
        document.getElementById('swap-alert').classList.remove('hidden');
        renderTeam();
    }
}

function confirmSwap(tIdx) {
    if(state.swapIdx === null) return;
    let temp = state.team[tIdx];
    state.team[tIdx] = state.pc[state.swapIdx];
    state.pc[state.swapIdx] = temp;
    state.swapIdx = null;
    document.getElementById('swap-alert').classList.add('hidden');
    playTone('pc'); renderTeam(); renderPC();
}

function releasePokemon(idx) { 
    if(confirm("Relâcher ce Pokémon ?")) { 
        state.pc.splice(idx,1); 
        renderPC(); 
    } 
}

function updateUI() {
    document.getElementById('money-display').innerText = state.money;
    document.getElementById('ball-count-btn').innerText = state.inv.balls;
    document.getElementById('superball-count-btn').innerText = state.inv.superballs;
    document.getElementById('hyperball-count-btn').innerText = state.inv.hyperballs;
    document.getElementById('total-dps').innerText = getDPS(enemy.dead ? null : enemy.id).toFixed(1);
    document.getElementById('team-count').innerText = state.team.length;
    
    // Shop Stocks
    if(document.getElementById('shop-stock-pokeball')) document.getElementById('shop-stock-pokeball').innerText = state.inv.balls;
    if(document.getElementById('shop-stock-superball')) document.getElementById('shop-stock-superball').innerText = state.inv.superballs;
    if(document.getElementById('shop-stock-candy')) document.getElementById('shop-stock-candy').innerText = state.inv.candy;
    if(document.getElementById('shop-stock-hyperball')) document.getElementById('shop-stock-hyperball').innerText = state.inv.hyperballs;
    if(document.getElementById('shop-stock-masterball')) document.getElementById('shop-stock-masterball').innerText = state.inv.masterball;
    if(document.getElementById('shop-stock-repel')) document.getElementById('shop-stock-repel').innerText = state.inv.repel;
    updateAutoStopBtn();
}

function updateZone() {
    const z = ZONES[state.zoneIdx];
    document.getElementById('zone-name').innerText = z.name;
    document.getElementById('zone-id').innerText = state.zoneIdx+1;
    document.getElementById('stage-text').innerText = state.subStage+"/10";
    document.getElementById('zone-progress').style.width = (state.subStage*10)+"%";
    
    document.getElementById('prev-zone-btn').disabled = state.zoneIdx===0;
    const next = document.getElementById('next-zone-btn');
    const canNext = (state.zoneIdx < state.unlockedZone || state.cheat) && state.zoneIdx < ZONES.length-1;
    next.disabled = !canNext;
    next.className = canNext ? "pointer-events-auto w-14 h-14 rounded-full bg-blue-600 hover:bg-blue-500 border-4 border-blue-400 text-white shadow-2xl flex items-center justify-center transition transform hover:scale-105 animate-pulse" : "pointer-events-auto w-14 h-14 rounded-full bg-slate-800 border-4 border-slate-600 text-gray-500 shadow-none flex items-center justify-center cursor-not-allowed opacity-50";
}

function updateBg() {
    const bg = ZONES[state.zoneIdx].bg;
    const layer = document.getElementById('bg-layer');
    if(bg.includes("http")) {
        layer.style.backgroundImage = `url('${bg}')`;
        layer.style.background = ""; 
    } else {
        layer.style.backgroundImage = "";
        layer.style.background = bg; // Use gradient
    }
}

function updateEnemyUI() {
    const img = document.getElementById('enemy-sprite');
    img.src = getArtwork(enemy.id);
    if(enemy.isBoss) img.classList.add('scale-125'); else img.classList.remove('scale-125');
    if(enemy.isShiny) img.classList.add('shiny-filter'); else img.classList.remove('shiny-filter');
    
    document.getElementById('enemy-name').innerText = enemy.name;
    document.getElementById('enemy-level').innerText = "Lv. " + enemy.level;
    document.getElementById('boss-badge').style.display = enemy.isBoss ? 'block' : 'none';
    
    // Show Types
    const types = getTypes(enemy.id);
    let typeHtml = types.map(t => `<span style="background:${TYPE_COLORS[t]}" class="text-[9px] px-1.5 py-0.5 rounded text-white shadow-sm ml-1 uppercase">${t}</span>`).join("");
    if(enemy.isShiny) typeHtml += `<span class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-400 text-black font-bold shadow-sm ml-1">★</span>`;
    document.getElementById('enemy-name').innerHTML = enemy.name + typeHtml;
    
    const hasSuper = state.unlockedZone>=4 || state.zoneIdx>=4;
    document.getElementById('super-catch-btn').style.display = hasSuper ? 'flex' : 'none';
    
    const hasHyper = state.unlockedZone>=9 || state.zoneIdx>=9 || state.inv.hyperballs > 0;
    document.getElementById('hyper-catch-btn').style.display = hasHyper ? 'flex' : 'none';
    
    const hasMaster = state.inv.masterball > 0;
    document.getElementById('master-catch-btn').style.display = hasMaster ? 'flex' : 'none';
    
    const hasLeftovers = state.upgrades.leftovers;
    document.getElementById('auto-click-btn').classList.toggle('hidden', !hasLeftovers);
    updateAutoClickerBtn();
    
    updateHp();
    updateZone();
}

function updateHp() {
    const pct = Math.max(0, (enemy.hp/enemy.maxHp)*100);
    const bar = document.getElementById('hp-bar');
    bar.style.width = pct + "%";
    bar.className = `h-full transition-all duration-100 ${pct<25?'bg-red-500':pct<50?'bg-yellow-500':'bg-green-500'}`;
    document.getElementById('hp-text').innerText = Math.ceil(Math.max(0, enemy.hp)) + "/" + enemy.maxHp;
}

function renderTeam() {
    const l = document.getElementById('team-list'); l.innerHTML="";
    state.team.forEach((p,i) => {
        const evo = EVOLUTIONS[p.id] && p.level>=EVOLUTIONS[p.id].lvl;
        const swapMode = state.swapIdx!==null;
        const candyMode = state.candyMode;
        const isCandyTarget = candyMode && state.candyTargetIdx === i;
        const isInteractive = swapMode || candyMode;
        const mult = !enemy.dead ? getMultiplier(p.id, enemy.id) : 1;
        const multColor = mult > 1 ? "text-green-400" : mult < 1 ? "text-red-400" : "text-gray-400";
        const typeIcon = `<div class="w-2 h-2 rounded-full inline-block mr-1" style="background:${TYPE_COLORS[getTypes(p.id)[0]]}"></div>`;
        const shinyClass = p.isShiny ? "shiny-filter" : "";
        const shinyIcon = p.isShiny ? "<span class='text-yellow-400 ml-1'>★</span>" : "";
        const shinyDpsMult = p.isShiny ? 2 : 1;
        let baseStat = BASE_STATS[p.id] || 40;
        let rawDmg = (baseStat * p.level) / 5;
        const xpPct = p.level >= 100 ? 100 : Math.min(100, (p.xp / p.maxXp) * 100);

        l.innerHTML += `
        <div onclick="${isInteractive ? `handleTeamClick(${i})` : ''}" class="flex items-center p-2 rounded border ${isInteractive?'border-blue-400 bg-blue-900/30 cursor-pointer animate-pulse':'border-slate-600 bg-slate-700/40'} hover:bg-slate-700 transition">
            <img src="${p.img}" class="w-10 h-10 mr-3 ${shinyClass}">
            <div class="flex-1 min-w-0">
                <div class="text-[10px] font-bold text-gray-200 truncate">${typeIcon}${p.name}${shinyIcon}</div>
                <div class="text-[9px] text-yellow-500">DPS: ${(rawDmg*mult*shinyDpsMult).toFixed(1)} <span class="${multColor} text-[8px]">x${mult}</span></div>
            </div>
            ${!swapMode ? `
            ${isCandyTarget ? `
            <div class="flex items-center gap-1 bg-slate-800 rounded p-1 border border-blue-500" onclick="event.stopPropagation()">
                <button onclick="adjustCandyAmount(-1)" class="w-5 h-5 bg-slate-600 hover:bg-slate-500 rounded flex items-center justify-center"><span class="material-symbols-outlined text-[14px]">remove</span></button>
                <span class="text-xs font-bold w-6 text-center text-white">${state.candyAmount}</span>
                <button onclick="adjustCandyAmount(1)" class="w-5 h-5 bg-slate-600 hover:bg-slate-500 rounded flex items-center justify-center"><span class="material-symbols-outlined text-[14px]">add</span></button>
                <button onclick="confirmCandyUse()" class="ml-1 text-green-400 hover:text-green-300 material-symbols-outlined text-[16px]" title="Confirmer">check</button>
                <button onclick="cancelCandyUse()" class="text-red-400 hover:text-red-300 material-symbols-outlined text-[16px]" title="Annuler">close</button>
            </div>
            ` : `
            <div class="flex items-center gap-1">
                <div class="w-12 h-1.5 bg-slate-800 rounded-full overflow-hidden relative border border-slate-600 mr-1" title="XP: ${Math.floor(p.xp)}/${p.maxXp}">
                    <div class="h-full bg-blue-500 transition-all duration-300" style="width:${xpPct}%"></div>
                </div>
                <span class="text-[10px] text-blue-300 mr-1">Lv.${p.level}</span>
                ${evo ? `<button onclick="evolve(${p.uid}); event.stopPropagation();" class="bg-purple-600 text-white text-[9px] px-2 py-1 rounded animate-pulse">EVO</button>` : ''} 
                ${!p.isShiny && state.inv.shinyToken>0 ? `<button onclick="useShinyToken(${p.uid}); event.stopPropagation();" class="bg-yellow-400 text-black text-[9px] px-1.5 py-1 rounded font-bold" title="Utiliser Jeton Shiny">★</button>` : ''}
            </div>`}
            ` : `<div class="text-[9px] text-blue-300 font-bold">REMPLACER</div>`}
        </div>`;
    });
}

function renderPC() {
    const c = document.getElementById('pc-content');
    if(state.unlockedZone<3 && state.zoneIdx<3) { 
        document.getElementById('pc-locked').classList.remove('hidden'); 
        return; 
    }
    document.getElementById('pc-locked').classList.add('hidden');
    c.innerHTML = state.pc.length===0 ? `<div class="text-center text-green-500 text-xs mt-10">VIDE</div>` : "";
    state.pc.forEach((p,i) => {
        const shinyClass = p.isShiny ? "shiny-filter" : "";
        c.innerHTML += `
        <div class="flex justify-between items-center bg-gray-900/80 p-2 mb-1 border-b border-green-900">
            <div class="flex items-center gap-2">
                <img src="${p.img}" class="w-8 h-8 ${shinyClass}">
                <div><div class="text-[10px] text-green-400">${p.name}${p.isShiny?"★":""}</div><div class="text-[8px] text-green-600">Lv.${p.level}</div></div>
            </div>
            <div class="flex gap-1">
                <button onclick="initSwap(${i})" class="text-[8px] bg-green-700 text-white px-2 py-1 rounded">IN</button>
                <button onclick="releasePokemon(${i})" class="text-[8px] bg-red-900 text-white px-2 py-1 rounded">X</button>
            </div>
        </div>`;
    });
}

function renderBag() {
    document.getElementById('bag-content').innerHTML = `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Pokéball</div><div class="text-xs font-bold">x${state.inv.balls}</div></div>
    </div>
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 ${state.inv.candy>0?'cursor-pointer hover:bg-slate-600':''}" ${state.inv.candy>0?'onclick="initCandyUse()"':''}>
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/rare-candy.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Super Bonbon</div><div class="text-xs font-bold">x${state.inv.candy} ${state.inv.candy>0?'<span class="text-[8px] text-yellow-500">UTILISER</span>':''}</div></div>
    </div>
    ${state.inv.repel>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useRepel()">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/repel.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Repousse</div><div class="text-xs font-bold">x${state.inv.repel} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.superRepel>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useSuperRepel()">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/super-repel.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Superepousse</div><div class="text-xs font-bold">x${state.inv.superRepel} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.xAttack>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useXAttack()">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-attack.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Attaque +</div><div class="text-xs font-bold">x${state.inv.xAttack} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.xSpecial>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useXSpecial()">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-sp-atk.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Attaque Spé +</div><div class="text-xs font-bold">x${state.inv.xSpecial} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.pokeDoll>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="usePokeDoll()">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-doll.png" class="w-6 h-6">
        <div><div class="text-[9px] text-gray-400">Poké Poupée</div><div class="text-xs font-bold">x${state.inv.pokeDoll} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.superballs>0 || state.unlockedZone>=4 || state.zoneIdx>=4 ? `
    <div class="bg-blue-900/40 p-2 rounded flex items-center gap-2 border border-blue-500">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png" class="w-6 h-6">
        <div><div class="text-[9px] text-blue-300">Superball</div><div class="text-xs font-bold">x${state.inv.superballs}</div></div>
    </div>`:''}
    ${state.inv.hyperballs>0 || state.unlockedZone>=9 || state.zoneIdx>=9 ? `
    <div class="bg-yellow-900/40 p-2 rounded flex items-center gap-2 border border-yellow-500">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png" class="w-6 h-6">
        <div><div class="text-[9px] text-yellow-300">Hyperball</div><div class="text-xs font-bold">x${state.inv.hyperballs}</div></div>
    </div>`:''}
    ${state.inv.masterball>0 ? `
    <div class="bg-purple-900/40 p-2 rounded flex items-center gap-2 border border-purple-500">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-6 h-6">
        <div><div class="text-[9px] text-purple-300">Masterball</div><div class="text-xs font-bold">x${state.inv.masterball}</div></div>
    </div>`:''}
    ${state.inv.shinyToken>0 ? `
    <div class="bg-yellow-900/40 p-2 rounded flex items-center gap-2 border border-yellow-500">
        <div class="w-6 h-6 rounded-full bg-yellow-400 border-2 border-white flex items-center justify-center text-[10px] text-black font-bold">★</div>
        <div><div class="text-[9px] text-yellow-300">Jeton Shiny</div><div class="text-xs font-bold">x${state.inv.shinyToken}</div></div>
    </div>`:''}
    ${state.inv.omniXp>0 ? `
    <div class="bg-indigo-900/40 p-2 rounded flex items-center gap-2 border border-indigo-500"><span class="material-symbols-outlined text-indigo-300">auto_awesome</span><div><div class="text-[9px] text-indigo-300">Omni XP</div><div class="text-xs font-bold">x${state.inv.omniXp}</div></div></div>`:''}
    `;
}

function renderShop() {
    const c = document.getElementById('shop-content');
    if(state.unlockedZone<1 && state.zoneIdx<1) { 
        document.getElementById('shop-locked').classList.remove('hidden'); 
        c.classList.add('locked-blur'); 
    } else { 
        document.getElementById('shop-locked').classList.add('hidden'); 
        c.classList.remove('locked-blur'); 
    }
    
    // Header Update
    const header = c.previousElementSibling.querySelector('span');
    if(header) header.innerText = "POKÉSHOP";

    let html = `<div class="text-[9px] font-bold text-gray-400 mb-1 uppercase tracking-wider border-b border-gray-700 pb-1">Consommables</div>`;
    
    // Consumables
    for (const [id, item] of Object.entries(ITEMS)) {
        if (item.type !== 'consumable') continue;
        if (state.unlockedZone < item.zone && state.zoneIdx < item.zone) continue;

        let stockDisplay = "";
        if (item.invKey) {
            stockDisplay = `<div class="text-[8px] text-blue-300">x<span id="shop-stock-${id}">${state.inv[item.invKey]}</span></div>`;
        }

        let iconHtml = "";
        if (item.img) iconHtml = `<img class="w-6 h-6" src="${item.img}">`;
        else if (item.icon) iconHtml = `<span class="material-symbols-outlined ${item.iconColor || 'text-gray-400'}">${item.icon}</span>`;

        html += `
        <div class="bg-slate-800 p-2 rounded border ${id==='superball'?'border-blue-600 bg-blue-900/30':'border-slate-700'} hover:border-blue-500 cursor-pointer flex items-center gap-2" onclick="buyItem('${id}')" title="${item.desc}">
            ${iconHtml}
            <div class="flex-1 text-[10px] ${id==='superball'?'text-blue-200':''}">${item.name}</div>
            <div class="text-yellow-400 text-xs">${getPrice(item.price)}$</div>
            ${stockDisplay}
        </div>`;
    }

    // Upgrades
    html += `<div class="text-[9px] font-bold text-gray-400 mb-1 mt-3 uppercase tracking-wider border-b border-gray-700 pb-1">Améliorations</div>`;
    
    for (const [id, item] of Object.entries(ITEMS)) {
        if (item.type !== 'upgrade') continue;
        if (state.unlockedZone < item.zone && state.zoneIdx < item.zone) continue;

        const owned = state.upgrades[id];
        let iconHtml = "";
        if (item.img) iconHtml = `<img class="w-6 h-6" src="${item.img}">`;
        else if (item.icon) iconHtml = `<span class="material-symbols-outlined ${item.iconColor || 'text-white'}">${item.icon}</span>`;

        html += `
        <div class="bg-slate-800 p-2 rounded border ${owned?'border-green-600 opacity-50':'border-slate-700 hover:border-blue-500 cursor-pointer'} flex items-center gap-2" ${!owned?`onclick="buyItem('${id}')"`:''} title="${item.desc}">
            ${iconHtml}
            <div class="flex-1 text-[10px]">${item.name}</div>
            ${owned ? `<div class="text-[9px] text-green-400 font-bold">ACQUIS</div>` : `<div class="text-yellow-400 text-xs">${getPrice(item.price)}$</div>`}
        </div>`;
    }

    c.innerHTML = html;
}

function renderPokedex() {
    const g = document.getElementById('pokedex-grid');
    g.innerHTML = "";
    document.getElementById('pokedex-count').innerText = state.pokedex.length;
    
    // Find next milestone
    let nextM = MILESTONES.find(m => m.count > state.pokedex.length);
    document.getElementById('next-milestone-text').innerText = nextM ? `Prochain: ${nextM.count} (${nextM.title})` : "COMPLET !";

    for(let i=1; i<=151; i++) {
        const caught = state.pokedex.includes(i);
        const div = document.createElement('div');
        div.className = `aspect-square rounded border flex items-center justify-center relative ${caught ? 'bg-slate-700 border-slate-500' : 'bg-slate-900 border-slate-800'}`;
        
        if(caught) {
            div.innerHTML = `<img src="${getSprite(i)}" class="w-full h-full object-contain"><div class="absolute bottom-0 right-1 text-[8px] text-white font-mono">#${i}</div>`;
        } else {
            div.innerHTML = `<div class="text-slate-700 font-bold text-xl">#${i}</div>`;
        }
        g.appendChild(div);
    }
}

function clickAttack(e) {
    if(enemy.dead) return;
    const dmg = getClick();
    damageEnemy(dmg);
    const img = document.getElementById('enemy-sprite');
    img.classList.remove('shake-anim'); 
    void img.offsetWidth; // Trigger reflow
    img.classList.add('shake-anim');
    
    // Determine color based on leader effectiveness
    const leaderMult = state.team.length > 0 ? getMultiplier(state.team[0].id, enemy.id) : 1;
    playTone('hit');
    
    // Damage number
    const d = document.createElement('div');
    d.innerText = getClick(); 
    d.className="absolute text-white font-bold text-xl pointer-events-none z-50 text-shadow";
    d.style.left=(e.clientX-10)+"px"; 
    d.style.top=(e.clientY-30)+"px"; 
    if(leaderMult > 1) d.style.color = "#4ade80"; // Green
    if(leaderMult < 1) d.style.color = "#f87171"; // Red
    d.style.transition="0.5s";
    document.body.appendChild(d);
    
    requestAnimationFrame(()=>{ d.style.transform="translateY(-30px)"; d.style.opacity="0"; });
    setTimeout(()=>d.remove(), 500);
}

function toggleAutoAttack() {
    state.auto = !state.auto;
    updateAutoBtn();
}

function updateAutoBtn() {
    const b = document.getElementById('auto-attack-btn');
    b.className = state.auto ? "bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-green-400 flex items-center gap-1" : "bg-red-600 hover:bg-red-500 text-white text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-red-400 flex items-center gap-1";
    document.getElementById('auto-txt').innerText = state.auto?"ON":"OFF";
}

function toggleAutoClicker() {
    state.autoClicker = !state.autoClicker;
    updateAutoClickerBtn();
}

function updateAutoClickerBtn() {
    const b = document.getElementById('auto-click-btn');
    b.className = state.autoClicker ? "bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-green-400 flex items-center gap-1 transition-all ml-1" : "bg-gray-600 hover:bg-gray-500 text-gray-300 text-[9px] font-bold py-1 px-3 rounded-full shadow-md border border-gray-400 flex items-center gap-1 transition-all ml-1";
    document.getElementById('auto-click-txt').innerText = state.autoClicker?"ON":"OFF";
}

function startAutoClicker() {
    if(autoClickerInterval) clearInterval(autoClickerInterval);
    // 4 clicks per second = 250ms
    autoClickerInterval = setInterval(() => {
        if(state.autoClicker && !enemy.dead && state.upgrades.leftovers) {
            damageEnemy(getClick());
        }
    }, 250);
}

function toggleStopOnRare() {
    state.stopOnRare = !state.stopOnRare;
    updateAutoStopBtn();
}

function updateAutoStopBtn() {
    const b = document.getElementById('auto-stop-btn');
    b.className = state.stopOnRare ? "bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-2 rounded-full shadow-md border border-green-400 flex items-center gap-1 transition-all mr-1" : "bg-gray-600 hover:bg-gray-500 text-gray-300 text-[9px] font-bold py-1 px-2 rounded-full shadow-md border border-gray-400 flex items-center gap-1 transition-all mr-1";
}

function showFeedback(t,c) {
    const e = document.getElementById('feedback-msg');
    e.innerHTML = `<span class="text-${c}-400 font-bold text-2xl pixel-font text-shadow-lg">${t}</span>`;
    e.classList.remove('hidden'); 
    e.classList.add('animate-bounce');
    setTimeout(()=>e.classList.add('hidden'), 1200);
}

function changeZone(d) {
    const n = state.zoneIdx + d;
    if(n>=0 && (n<=state.unlockedZone || state.cheat) && n<ZONES.length) {
        if(state.cheat && n > state.unlockedZone) state.unlockedZone = n;
        state.zoneIdx = n; 
        state.subStage = 1;
        updateBg(); renderShop(); renderBag(); renderPC(); spawnEnemy();
    }
}

function shakeBtn(id) {
    const b = document.getElementById(id);
    b.classList.add('animate-pulse');
    setTimeout(()=>b.classList.remove('animate-pulse'), 300);
}

// --- GAME LOOP & START ---
setInterval(() => {
    if(state.auto && state.team.length>0 && !enemy.dead) {
        damageEnemy(getDPS(enemy.id)/10);
    }
}, 100);

// Launch
window.onload = init;

</script>
</body>
</html>