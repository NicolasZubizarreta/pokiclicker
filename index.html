<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Poké-Clicker: Kanto Origins</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <style>
        body { font-family: 'Open Sans', sans-serif; background: #0f172a; color: white; overflow: hidden; }
        h1, h2, h3, .pixel-font { font-family: 'Press Start 2P', cursive; }
        
        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .pokemon-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-5deg); } 75% { transform: translateX(5px) rotate(5deg); } 100% { transform: translateX(0); } }
        .shake-anim { animation: shake 0.3s ease-in-out; filter: brightness(2) drop-shadow(0 0 5px red); }

        @keyframes catch-shake { 
            0% { transform: scale(1) rotate(0); } 
            20% { transform: scale(0.8) rotate(-10deg); } 
            40% { transform: scale(0.8) rotate(10deg); } 
            60% { transform: scale(0.8) rotate(-10deg); } 
            80% { transform: scale(0.8) rotate(0); } 
            100% { transform: scale(0); opacity: 0; }
        }
        .catching { animation: catch-shake 1.5s ease-in-out forwards; filter: brightness(0); }

        @keyframes evolution-flash {
            0% { filter: brightness(1); transform: scale(1); }
            5% { filter: brightness(100); transform: scale(0.5); }
            10% { filter: brightness(100); transform: scale(1.2); }
            15% { filter: brightness(100); transform: scale(0.5); }
            20% { filter: brightness(100); transform: scale(1.2); }
            25% { filter: brightness(100); transform: scale(0.5); }
            30% { filter: brightness(100); transform: scale(1.2); }
            35% { filter: brightness(100); transform: scale(0.5); }
            40% { filter: brightness(100); transform: scale(1.2); }
            45% { filter: brightness(100); transform: scale(0.5); }
            50% { filter: brightness(100); transform: scale(1.2); }
            55% { filter: brightness(100); transform: scale(0.5); }
            60% { filter: brightness(100); transform: scale(1.2); }
            65% { filter: brightness(100); transform: scale(0.5); }
            70% { filter: brightness(100); transform: scale(1.2); }
            75% { filter: brightness(100); transform: scale(0.5); }
            80% { filter: brightness(100); transform: scale(1.2); }
            85% { filter: brightness(100); transform: scale(0.5); }
            90% { filter: brightness(100); transform: scale(1.5); }
            100% { filter: brightness(1); transform: scale(1); }
        }
        .evolving { animation: evolution-flash 3s linear forwards; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* UI Elements */
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); }
        .locked-blur { filter: blur(4px) grayscale(100%); pointer-events: none; opacity: 0.5; }
        .pc-screen { background: radial-gradient(circle, #1a2e1a 0%, #051405 100%); box-shadow: inset 0 0 20px #000; border: 4px solid #333; }
        
        /* Background Layer */
        #bg-layer {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            image-rendering: pixelated;
            z-index: 0;
            position: absolute;
            inset: 0;
            opacity: 1;
        }
        
        .cheat-active { box-shadow: 0 0 15px #ef4444; border-color: #ef4444; color: #ef4444; background: #450a0a !important; }
        
        /* Utility for missing images */
        img[src=""] { opacity: 0; }

        /* Shiny Effect */
        .shiny-filter { filter: hue-rotate(150deg) saturate(150%) brightness(1.1) drop-shadow(0 0 5px gold); }
        .shiny-glow { filter: drop-shadow(0 0 15px gold) brightness(1.1); }
        .grayscale { filter: grayscale(100%) opacity(0.3); }

        /* Gen 1 Fly Animation */
        #gen1-fly-overlay {
            display: none;
            position: absolute;
            inset: 0;
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .fly-track {
            width: 100%;
            height: 180px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-top: 20px solid black;
            border-bottom: 20px solid black;
            clip-path: inset(50% 0 50% 0);
            transition: clip-path 0.8s ease-in-out;
        }
        .fly-speed-lines {
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='180'%3E%3Crect width='400' height='180' fill='black'/%3E%3Crect x='25' y='15' width='8' height='2' fill='white'/%3E%3Crect x='150' y='30' width='12' height='2' fill='white'/%3E%3Crect x='80' y='100' width='10' height='2' fill='white'/%3E%3Crect x='300' y='80' width='8' height='2' fill='white'/%3E%3Crect x='350' y='20' width='9' height='2' fill='white'/%3E%3Crect x='220' y='90' width='11' height='2' fill='white'/%3E%3Crect x='20' y='70' width='7' height='2' fill='white'/%3E%3Crect x='250' y='50' width='9' height='2' fill='white'/%3E%3Crect x='120' y='5' width='8' height='2' fill='white'/%3E%3Crect x='380' y='110' width='10' height='2' fill='white'/%3E%3Crect x='50' y='85' width='9' height='2' fill='white'/%3E%3Crect x='180' y='60' width='12' height='2' fill='white'/%3E%3Crect x='100' y='140' width='10' height='2' fill='white'/%3E%3Crect x='320' y='160' width='8' height='2' fill='white'/%3E%3Crect x='200' y='130' width='12' height='2' fill='white'/%3E%3C/svg%3E");
        }
        .fly-bird-sprite {
            position: absolute; top: 50%; left: 150%;
            transform: translate(-50%, -50%) scale(2.2);
            image-rendering: pixelated;
        }
        #gen1-fly-overlay.active .fly-speed-lines,
        #gen1-fly-overlay.closing .fly-speed-lines { animation: move-lines 0.2s linear infinite; }
        #gen1-fly-overlay.active .fly-track { 
            clip-path: inset(0 0 0 0);
            animation: track-open 0.4s ease-out forwards; 
        }
        #gen1-fly-overlay.active .fly-bird-sprite { 
            animation: bird-fly-sequence 2.5s ease-in-out forwards; 
        }
        #gen1-fly-overlay.closing .fly-track {
            animation: track-close 0.4s ease-in-out forwards;
        }
        @keyframes move-lines { from { background-position: 0 0; } to { background-position: -400px 0; } }
        @keyframes track-open {
            0% { clip-path: inset(48% 0 48% 100%); } /* Trait fin à droite */
            50% { clip-path: inset(48% 0 48% 0); }   /* Trait fin toute largeur */
            100% { clip-path: inset(0 0 0 0); }      /* Pleine hauteur */
        }
        @keyframes track-close {
            0% { clip-path: inset(0 0 0 0); }
            100% { clip-path: inset(50% 0 50% 0); }
        }
        @keyframes bird-fly-sequence {
            0% { left: 150%; }
            10% { left: 150%; } /* Attente ouverture */
            30% { left: 50%; }  /* Arrivée au centre (Rapide) */
            60% { left: 50%; }  /* Pause */
            100% { left: -50%; } /* Départ vers la gauche (Lent) */
        }

        @media (max-width: 1024px) {
            body {
                overflow-y: auto;
            }
            #sidebar-left, #sidebar-right {
                display: none !important;
            }
            #game-ui {
                flex-direction: column;
            }
            #main-game-view {
                order: 1;
                height: 65vh;
                width: 100vw;
            }
            #mobile-menu-container {
                order: 2;
                display: flex;
                height: 35vh;
                width: 100vw;
            }
        }

        /* Easter Eggs */
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .rainbow-anim { animation: rainbow 2s linear infinite; }
        .upside-down { transform: rotate(180deg); }
    </style>
</head>
<body class="h-screen flex flex-col selection:bg-red-500 selection:text-white select-none">

<div class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-4 hidden" id="starter-modal">
    <div class="text-center mb-10 animate-bounce">
        <h1 class="text-3xl md:text-5xl text-yellow-400 mb-2 pixel-font drop-shadow-lg">POKÉ CLICKER</h1>
        <p class="text-gray-400 text-sm tracking-widest">KANTO ORIGINS</p>
    </div>
    <div class="bg-slate-800/80 p-8 rounded-3xl border-4 border-slate-600 shadow-2xl max-w-4xl w-full backdrop-blur-sm max-h-[90vh] overflow-y-auto custom-scroll">
        <h2 class="text-center text-white mb-8 pixel-font text-lg">CHOISIS TON STARTER</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="group relative bg-gradient-to-br from-green-900 to-slate-900 border-2 border-green-600 hover:border-green-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(1)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/1.png">
                <div class="pixel-font text-green-400 text-sm">BULBIZARRE</div>
            </div>
            <div class="group relative bg-gradient-to-br from-red-900 to-slate-900 border-2 border-red-600 hover:border-red-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(4)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png">
                <div class="pixel-font text-red-400 text-sm">SALAMÈCHE</div>
            </div>
            <div class="group relative bg-gradient-to-br from-blue-900 to-slate-900 border-2 border-blue-600 hover:border-blue-400 rounded-xl p-6 cursor-pointer transition-all hover:-translate-y-2 text-center" onclick="startGame(7)">
                <img class="w-32 h-32 mx-auto mb-4 object-contain group-hover:scale-110 transition-transform" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/7.png">
                <div class="pixel-font text-blue-400 text-sm">CARAPUCE</div>
            </div>
        </div>
        <div class="mt-8 text-center">
            <button onclick="loadSaveFile()" class="text-xs text-gray-500 hover:text-white underline">Importer une sauvegarde (JSON)</button>
            <input type="file" id="file-input" class="hidden" accept=".json" onchange="handleFileSelect(event)">
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="pokedex-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl relative">
        <button onclick="togglePokedex()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-4xl z-10">close</button>
        <div class="p-4 border-b border-slate-700 bg-slate-900 rounded-t-xl flex flex-col md:flex-row justify-between items-center pr-4 md:pr-20 gap-4">
            <div>
                <h2 class="text-yellow-400 pixel-font text-xl">POKÉDEX</h2>
                <p class="text-xs text-gray-400 mt-1">CAPTUREZ-LES TOUS POUR DES BONUS !</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleMilestones()" class="bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] font-bold py-1 px-3 rounded shadow-md border border-yellow-400 flex items-center gap-1 transition-all"><span class="material-symbols-outlined text-[14px]">trophy</span> RÉCOMPENSES</button>
                <div class="text-right">
                    <div class="text-2xl font-bold text-white"><span id="pokedex-count">0</span>/151</div>
                    <div class="text-xs text-blue-400" id="next-milestone-text">Prochain palier: 10</div>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 custom-scroll">
            <div class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-2" id="pokedex-grid"></div>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="map-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-3xl aspect-video flex flex-col shadow-2xl relative overflow-hidden">
        <button onclick="toggleMap()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-4xl z-20 bg-slate-900 rounded-full">close</button>
        <div class="relative w-full h-full bg-[#70A8C0]" id="map-container">
            <img src="img/kanto.png" class="absolute inset-0 w-full h-full object-fill opacity-90" alt="Carte de Kanto">
            <svg id="map-svg" class="absolute inset-0 w-full h-full" preserveAspectRatio="none"></svg>
            <img id="fly-trainer" src="img/sprites/SpriteFly1.png" class="absolute z-30 hidden" style="height: 100px; image-rendering: pixelated; transform: translate(-50%, -50%);">
            <div id="gen1-fly-overlay" class="hidden">
                <div class="fly-track">
                    <div class="fly-speed-lines"></div>
                    <img src="https://img.pokemondb.net/sprites/black-white/anim/normal/pidgeot.gif" class="fly-bird-sprite">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="badges-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6">
        <button onclick="toggleBadges()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <h2 class="text-center text-yellow-400 pixel-font text-xl mb-2">BOÎTE À BADGES</h2>
        <p class="text-center text-xs text-gray-400 mb-6">BATTEZ LES CHAMPIONS POUR OBTENIR DES BONUS PERMANENTS</p>
        
        <div class="grid grid-cols-4 gap-4" id="badges-grid">
            <!-- Badges will be rendered here -->
        </div>

        <div class="mt-6 bg-slate-900/50 p-3 rounded border border-slate-700 text-center min-h-[60px] flex items-center justify-center">
            <p id="badge-tooltip" class="text-sm text-blue-300 font-bold">Survolez un badge pour voir son effet</p>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="milestones-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6 max-h-[80vh]">
        <button onclick="toggleMilestones()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <h2 class="text-center text-yellow-400 pixel-font text-xl mb-6">RÉCOMPENSES</h2>
        
        <div class="flex-1 overflow-y-auto custom-scroll space-y-2" id="milestones-list">
            <!-- Generated by JS -->
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="stats-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6 max-h-[90vh]">
        <button onclick="hideStats()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <div class="flex items-center justify-center gap-2 mb-6">
            <span class="material-symbols-outlined text-purple-400 text-2xl">bar_chart</span>
            <h2 class="text-center text-yellow-400 pixel-font text-xl">STATISTIQUES</h2>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scroll space-y-4" id="stats-content"></div>
    </div>
</div>

<div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 hidden pointer-events-none" id="rare-alert">
    <div class="bg-yellow-500 text-black px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white animate-bounce flex items-center gap-2">
        <span class="material-symbols-outlined">warning</span>
        POKÉMON RARE ! COMBAT AUTO STOPPÉ !
    </div>
</div>
<div class="fixed top-24 left-1/2 transform -translate-x-1/2 z-50 hidden pointer-events-none" id="swap-alert">
    <div class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white flex items-center gap-2 animate-pulse">
        <span class="material-symbols-outlined">swap_horiz</span>
        SÉLECTIONNEZ UN POKÉMON À REMPLACER
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="auto-stop-settings-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-md flex flex-col shadow-2xl relative p-6">
        <button onclick="toggleAutoStopSettingsModal()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <h2 class="text-center text-yellow-400 pixel-font text-xl mb-2">SÉCURITÉ AUTO-COMBAT</h2>
        <p class="text-center text-xs text-gray-400 mb-6">Arrêter le combat auto pour les raretés sélectionnées.</p>
        <div class="space-y-2" id="auto-stop-settings-list">
            <!-- Checkboxes will be rendered here -->
        </div>
    </div>
</div>

<div class="fixed inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center p-4 hidden" id="radar-modal">
    <div class="bg-slate-800 border-4 border-slate-600 rounded-xl w-full max-w-2xl flex flex-col shadow-2xl relative p-6 max-h-[80vh]">
        <button onclick="toggleRadarModal()" class="absolute top-4 right-4 text-red-500 hover:text-white material-symbols-outlined text-3xl z-10">close</button>
        <div class="flex items-center justify-center gap-2 mb-1">
            <span class="material-symbols-outlined text-green-400">radar</span>
            <h2 class="text-center text-yellow-400 pixel-font text-xl">POKÉ-RADAR</h2>
        </div>
        <p class="text-center text-xs text-gray-400 mb-6" id="radar-zone-name">Zone Actuelle</p>
        <div class="flex-1 overflow-y-auto custom-scroll p-1">
            <div class="grid grid-cols-3 md:grid-cols-5 gap-4" id="radar-grid">
                <!-- Pokémon will be rendered here -->
            </div>
        </div>
    </div>
</div>

<div class="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-4 hidden" id="victory-modal">
    <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    <div class="relative z-10 text-center flex flex-col items-center animate-bounce">
        <img src="img/Bravo.png" class="w-64 h-64 md:w-80 md:h-80 object-contain mb-6 drop-shadow-[0_0_30px_rgba(255,215,0,0.6)]">
        <h1 class="text-2xl md:text-4xl text-yellow-400 mb-6 pixel-font drop-shadow-lg tracking-widest leading-relaxed">FÉLICITATIONS !</h1>
        <div class="bg-slate-800/90 p-6 rounded-xl border-4 border-yellow-500 shadow-2xl backdrop-blur-sm max-w-2xl mb-8">
            <p class="text-white text-xs md:text-base font-bold pixel-font leading-loose">
                TU ES MAINTENANT LE<br>
                <span class="text-yellow-400 text-lg md:text-2xl">MAÎTRE DE LA LIGUE DE KANTO !</span>
            </p>
        </div>
        <button onclick="closeVictory()" class="bg-gradient-to-r from-yellow-600 to-yellow-400 hover:from-yellow-500 hover:to-yellow-300 text-black font-bold py-3 px-8 rounded-full text-sm md:text-base shadow-[0_0_20px_rgba(234,179,8,0.8)] transition-all transform hover:scale-110 pixel-font border-2 border-white">
            CONTINUER
        </button>
    </div>
</div>

<div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 hidden" id="item-info-modal" onclick="this.classList.add('hidden')">
    <div class="bg-slate-800 border-2 border-slate-500 p-4 rounded-xl shadow-2xl max-w-[280px] w-full text-center relative" onclick="event.stopPropagation()">
        <button onclick="document.getElementById('item-info-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-white material-symbols-outlined text-sm">close</button>
        <h3 class="text-yellow-400 font-bold mb-3 pixel-font text-xs tracking-wide" id="info-title">ITEM</h3>
        <div class="flex justify-center mb-3" id="info-icon-container"></div>
        <p class="text-gray-200 text-xs leading-relaxed font-medium" id="info-desc">Description</p>
    </div>
</div>

<div class="flex h-full w-full opacity-0 transition-opacity duration-1000 hidden" id="game-ui">
    
    <div id="sidebar-left" class="w-[20%] flex flex-col h-full bg-slate-900 border-r border-slate-700 z-20 shadow-2xl shrink-0">
        <div id="team-container" class="flex-1 flex flex-col min-h-0 bg-slate-800/50">
            <div class="p-2 bg-gradient-to-r from-red-700 to-red-800 shadow-lg z-10 flex flex-col gap-2 border-b border-red-900 shrink-0">
                <div class="flex justify-between items-end w-full">
                    <span class="pixel-font text-[10px] text-white tracking-wide">ÉQUIPE (<span id="team-count">1</span>/6)</span>
                    <span class="text-[9px] text-red-200 font-mono">DPS: <span class="font-bold text-white" id="total-dps">15</span></span>
                </div>
                <div class="flex items-center justify-between gap-2 w-full">
                    <div class="flex-1 flex items-stretch justify-center">
                        <button class="flex-grow justify-center bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-1 rounded-l-md shadow-md border border-green-400 flex items-center gap-1 transition-all" id="auto-stop-btn" onclick="toggleStopOnRare()" title="Activer/Désactiver la sécurité d'arrêt auto">
                            <span class="material-symbols-outlined text-[12px]">front_hand</span>
                        </button>
                        <button class="justify-center bg-slate-600 hover:bg-slate-500 text-white text-[9px] font-bold py-1 px-2 rounded-r-md shadow-md border-y border-r border-slate-500 flex items-center transition-all" onclick="toggleAutoStopSettingsModal()" title="Configurer la sécurité">
                            <span class="material-symbols-outlined text-[12px]">settings</span>
                        </button>
                    </div>
                    <button class="flex-1 justify-center bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold py-1 px-1 rounded shadow-md border border-green-400 flex items-center gap-1 transition-all" id="auto-attack-btn" onclick="toggleAutoAttack()" title="Auto Attaque"><span class="material-symbols-outlined text-[12px]">swords</span></button>
                    <button class="flex-1 justify-center bg-gray-600 hover:bg-gray-500 text-gray-300 text-[9px] font-bold py-1 px-1 rounded shadow-md border border-gray-400 flex items-center gap-1 transition-all hidden" id="auto-click-btn" onclick="toggleAutoClicker()" title="Auto Click (Restes)"><span class="material-symbols-outlined text-[12px]">ads_click</span></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll" id="team-list">
                </div>
        </div>
        <div id="bag-container" class="h-[38%] flex flex-col min-h-0 bg-slate-800 border-t border-slate-700 shrink-0">
            <div class="p-2 bg-slate-700 text-center shadow-md border-b border-slate-600">
                <span class="pixel-font text-xs text-yellow-300 tracking-wider">SAC À DOS</span>
            </div>
            <div class="flex-1 overflow-y-auto p-2 grid grid-cols-2 gap-2 custom-scroll" id="bag-content">
                </div>
        </div>
    </div>

    <div id="main-game-view" class="w-[60%] relative flex flex-col h-full bg-black overflow-hidden shrink-0">
        <div id="bg-layer" style="background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');"></div>

        <!-- Content Container (Z-10) -->
        <div class="relative z-10 flex flex-col h-full w-full">
            <!-- Top Bar -->
            <div class="flex-none w-full p-2 flex flex-wrap lg:flex-nowrap items-center gap-y-2 lg:gap-1">
                
                <!-- Zone Info (Mobile: Top Full / Desktop: Center) -->
                <div class="w-full lg:w-[50%] order-1 lg:order-2 flex justify-center items-center gap-1">
                    <button id="prev-zone-btn-d" onclick="changeZone(-1)" class="w-6 h-6 lg:w-8 lg:h-8 rounded-full bg-slate-800 border border-slate-600 text-white flex items-center justify-center hover:bg-slate-700 transition disabled:opacity-50 shadow-lg shrink-0">
                        <span class="material-symbols-outlined text-xs lg:text-sm">arrow_back</span>
                    </button>
                    <div class="glass-panel px-2 py-1 rounded-xl text-center shadow-lg flex-1 flex flex-col justify-center min-w-0 h-12 lg:h-16">
                        <div class="text-[8px] text-blue-400 uppercase tracking-widest font-bold truncate">Zone <span id="zone-id">1</span></div>
                        <div class="text-[10px] lg:text-xs font-bold pixel-font text-white leading-snug mb-0.5 truncate w-full" id="zone-name">Route 1</div>
                        <div class="flex items-center justify-center gap-1 w-full">
                            <div class="w-12 lg:w-16 h-1 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 transition-all duration-300 w-1/10" id="zone-progress" style="width: 10%;"></div>
                            </div>
                            <span class="text-[8px] text-gray-400 font-mono" id="stage-text">1/10</span>
                        </div>
                    </div>
                    <button id="next-zone-btn-d" onclick="changeZone(1)" class="w-6 h-6 lg:w-8 lg:h-8 rounded-full bg-slate-800 border border-slate-600 text-white flex items-center justify-center hover:bg-slate-700 transition disabled:opacity-50 shadow-lg shrink-0">
                        <span class="material-symbols-outlined text-xs lg:text-sm">arrow_forward</span>
                    </button>
                </div>

                <!-- Money (Mobile: Left Below / Desktop: Left) -->
                <div class="w-1/2 lg:w-[25%] order-2 lg:order-1 flex justify-start">
                    <div class="glass-panel px-2 py-1 rounded-full flex items-center gap-1 shadow-lg max-w-full">
                        <span class="material-symbols-outlined text-yellow-400 text-xs">attach_money</span>
                        <span class="text-[10px] font-bold pixel-font text-white text-shadow truncate" id="money-display">0</span>
                    </div>
                </div>

                <!-- Map (Mobile: Right Below / Desktop: Right) -->
                <div class="w-1/2 lg:w-[25%] order-3 lg:order-3 flex justify-end">
                    <button onclick="toggleMap()" class="w-8 h-8 lg:w-10 lg:h-10 bg-slate-800 rounded-full border border-blue-400 hover:bg-slate-700 shadow-lg flex items-center justify-center transition-all hover:scale-110 group" title="Ouvrir la Carte">
                        <span class="material-symbols-outlined text-blue-200 group-hover:text-white text-sm lg:text-base">map</span>
                    </button>
                </div>
            </div>

            <!-- Middle (Pokemon) - Adjusted padding for mobile top bar -->
            <div class="flex-1 flex flex-col items-center justify-center min-h-0 relative group select-none">
                <div class="absolute -top-20 left-0 w-full text-center hidden pointer-events-none z-50" id="feedback-msg">
                    <span class="text-yellow-400 font-bold text-2xl pixel-font text-shadow-lg drop-shadow-lg">CAPTURED!</span>
                </div>
                <div id="catch-tooltip" class="hidden absolute top-4 right-4 bg-black/90 border border-slate-500 p-3 rounded-lg text-xs text-white z-50 pointer-events-none shadow-xl backdrop-blur-sm min-w-[120px]"></div>
                <div id="searching-msg" class="hidden text-white pixel-font text-sm animate-pulse tracking-widest z-20">RECHERCHE EN COURS...</div>
                <img class="w-48 h-48 lg:w-72 lg:h-72 object-contain pokemon-float drop-shadow-2xl transition-all duration-100 cursor-pointer active:scale-95" id="enemy-sprite" onclick="clickAttack(event)" onmouseenter="showCatchTooltip()" onmouseleave="hideCatchTooltip()" src="" draggable="false">
                <div class="hidden absolute top-0 right-10 bg-red-600 text-white font-bold text-[10px] px-3 py-1 rounded border border-white shadow-lg animate-bounce" id="boss-badge" style="display: none;">BOSS</div>
            </div>
            
            <!-- HP Bar Area -->
            <div class="flex-none w-[80%] max-w-md mb-4 bg-slate-900/80 rounded-xl border-2 border-slate-600 p-2 shadow-2xl backdrop-blur-md relative mx-auto">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white text-xs font-bold px-3 py-0.5 rounded-full border border-slate-500 shadow-md">
                    <span id="enemy-level">Lv. 2</span>
                </div>
                <div class="flex justify-between text-xs font-bold px-2 mb-1 mt-1">
                    <span class="text-white truncate max-w-[60%]" id="enemy-name">...</span>
                    <span class="text-white font-mono" id="hp-text">...</span>
                </div>
                <div class="h-4 bg-slate-800 rounded-full overflow-hidden relative">
                    <div class="h-full transition-all duration-100 bg-red-500" id="hp-bar" style="width: 100%;"></div>
                </div>
                <div class="h-1.5 mt-1 bg-slate-800 rounded-full overflow-hidden relative hidden" id="boss-timer-wrapper">
                    <div class="h-full bg-purple-500 transition-all duration-1000 ease-linear" id="boss-timer-bar" style="width: 100%;"></div>
                </div>
                <div id="active-effects" class="flex flex-wrap justify-center gap-1 mt-1 empty:hidden"></div>
            </div>

            <!-- Bottom Controls -->
            <div class="flex-none p-2 flex justify-start gap-2">
                <button class="bg-gray-800 text-gray-400 border border-gray-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-gray-700 transition-all opacity-50 hover:opacity-100" id="cheat-btn" onclick="toggleCheat()" title="Active le mode triche">CHEAT</button>
                <button class="bg-red-800 text-red-200 border border-red-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-red-700 transition-all shadow-lg flex items-center gap-1" onclick="resetSave()">
                    <span class="material-symbols-outlined text-[14px]">delete</span> RESET
                </button>
            </div>

            <button id="radar-btn" onclick="toggleRadarModal()" title="Poké-Radar" class="absolute bottom-4 right-4 w-12 h-12 bg-slate-800 rounded-full border-2 border-slate-600 flex items-center justify-center shadow-lg transition-all group disabled:opacity-50 disabled:cursor-not-allowed z-20" disabled>
                <span id="radar-icon-lock" class="material-symbols-outlined text-slate-500 text-2xl">lock</span>
                <span id="radar-icon-active" class="material-symbols-outlined text-green-400 text-2xl hidden group-hover:scale-125 transition-transform">radar</span>
            </button>
        </div>
    </div>

    <div id="sidebar-right" class="w-[20%] flex flex-col h-full bg-slate-900 border-l border-slate-700 z-20 shadow-2xl shrink-0">
        <div id="shop-container" class="h-[62%] flex flex-col relative border-b border-slate-700 min-h-0 shrink-0">
            <div class="p-2 bg-slate-800 text-center shadow-md border-b border-slate-600 z-10">
                <span class="pixel-font text-xs text-blue-300 tracking-wider">POKÉSHOP</span>
            </div>
            <div class="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center text-center p-4" id="shop-locked">
                <span class="material-symbols-outlined text-gray-500 text-3xl mb-2">lock</span>
                <p class="text-xs text-gray-400 font-bold">DÉBLOQUÉ ZONE 2</p>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-3 custom-scroll locked-blur" id="shop-content">
                </div>
        </div>
        <div id="pc-container" class="h-[38%] flex flex-col relative bg-slate-900 min-h-0 border-t border-slate-700 shrink-0">
            <!-- Menu View -->
            <div id="right-menu-view" class="flex-1 flex flex-col p-2 gap-2 justify-center items-stretch overflow-y-auto custom-scroll">
                <h3 class="text-center text-yellow-400 pixel-font text-[10px] mb-1 tracking-widest">MENU</h3>
                <button onclick="showPC()" class="bg-slate-800 hover:bg-slate-700 text-green-300 border border-slate-600 p-2 rounded flex items-center justify-center gap-2 font-bold text-xs transition-all shadow-lg group">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">computer</span> PC DE LÉO
                </button>
                <button onclick="togglePokedex()" class="bg-slate-800 hover:bg-slate-700 text-red-300 border border-slate-600 p-2 rounded flex items-center justify-center gap-2 font-bold text-xs transition-all shadow-lg group">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">book</span> POKÉDEX
                </button>
                <button onclick="toggleBadges()" class="bg-slate-800 hover:bg-slate-700 text-yellow-300 border border-slate-600 p-2 rounded flex items-center justify-center gap-2 font-bold text-xs transition-all shadow-lg group">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">military_tech</span> BADGES
                </button>
                <button onclick="showStats()" class="bg-slate-800 hover:bg-slate-700 text-purple-300 border border-slate-600 p-2 rounded flex items-center justify-center gap-2 font-bold text-xs transition-all shadow-lg group">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">bar_chart</span> STATISTIQUES
                </button>
                <button onclick="exportSave()" class="bg-slate-800 hover:bg-slate-700 text-blue-300 border border-slate-600 p-2 rounded flex items-center justify-center gap-2 font-bold text-xs transition-all shadow-lg group">
                    <span class="material-symbols-outlined group-hover:scale-110 transition-transform">save</span> SAUVER
                </button>
            </div>
            <div id="pc-view" class="absolute inset-0 flex flex-col bg-slate-900 hidden z-20">
                <div class="p-2 bg-green-900/50 text-center shadow-md border-b border-green-800 z-10 flex justify-between items-center">
                    <button onclick="hidePC()" class="text-green-300 hover:text-white material-symbols-outlined text-lg bg-green-900/50 rounded-full w-6 h-6 flex items-center justify-center">arrow_back</button>
                    <span class="pixel-font text-[10px] text-green-300 tracking-wider">PC DE LÉO</span>
                    <div class="w-6"></div>
                </div>
                <div id="pc-content" class="flex-1 overflow-y-auto p-2 pc-screen custom-scroll bg-black"></div>
                <div class="absolute inset-0 top-9 bg-slate-900/95 z-20 flex flex-col items-center justify-center text-center p-4" id="pc-locked">
                    <span class="material-symbols-outlined text-gray-600 text-3xl mb-2">computer</span>
                    <p class="text-xs text-gray-500 font-bold">DÉBLOQUÉ ZONE 4</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Area -->
    <div id="mobile-menu-container" class="h-[35vh] bg-slate-900 border-t-4 border-slate-700 flex-col z-40 shrink-0 hidden">
        <!-- Main Menu Grid -->
        <div id="mobile-main-menu" class="grid grid-cols-4 grid-rows-2 gap-2 p-2 h-full">
            <button onclick="openMobileSubView('mobile-team-view')" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-white border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">group</span>ÉQUIPE</button>
            <button onclick="openMobileSubView('mobile-bag-view')" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-white border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">backpack</span>SAC</button>
            <button onclick="openMobileSubView('mobile-shop-view')" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-blue-300 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">storefront</span>SHOP</button>
            <button onclick="openMobileSubView('mobile-pc-view')" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-green-300 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">computer</span>PC</button>
            <button onclick="togglePokedex()" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-red-400 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">book</span>POKÉDEX</button>
            <button onclick="toggleBadges()" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-yellow-500 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">military_tech</span>BADGES</button>
            <button onclick="showStats()" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-purple-400 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">bar_chart</span>STATS</button>
            <button onclick="exportSave()" class="bg-slate-800 rounded flex flex-col items-center justify-center text-xs font-bold text-blue-200 border border-slate-600 active:bg-slate-700"><span class="material-symbols-outlined mb-1">save</span>SAUVER</button>
        </div>

        <!-- Sub-views Container -->
        <div id="mobile-subview-container" class="relative h-full w-full hidden">
            <div id="mobile-team-view" class="h-full w-full flex-col hidden bg-slate-800 absolute inset-0">
                <div class="p-2 bg-slate-700 flex items-center justify-between gap-2 border-b border-slate-600 shrink-0">
                    <div class="flex items-center gap-2">
                        <button onclick="closeMobileSubViews()" class="material-symbols-outlined text-white hover:text-yellow-400">arrow_back</button>
                        <h3 class="pixel-font text-xs text-white">ÉQUIPE</h3>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-[9px] text-red-200 font-mono mr-1">DPS: <span class="font-bold text-white" id="total-dps-m">0</span></span>
                        <div class="flex items-stretch">
                            <button id="auto-stop-btn-m" onclick="toggleStopOnRare()" title="Activer/Désactiver la sécurité d'arrêt auto" class="justify-center text-[9px] font-bold p-1.5 rounded-l-md shadow-md flex items-center gap-1 transition-all">
                                <span class="material-symbols-outlined text-sm">front_hand</span>
                            </button>
                            <button onclick="toggleAutoStopSettingsModal()" title="Configurer la sécurité" class="justify-center bg-slate-600 hover:bg-slate-500 text-white text-[9px] font-bold p-1.5 rounded-r-md shadow-md border-y border-r border-slate-500 flex items-center transition-all">
                                <span class="material-symbols-outlined text-sm">settings</span>
                            </button>
                        </div>
                        <button id="auto-attack-btn-m" onclick="toggleAutoAttack()" title="Auto Attaque" class="justify-center text-[9px] font-bold p-1.5 rounded shadow-md flex items-center gap-1 transition-all"><span class="material-symbols-outlined text-sm">swords</span></button>
                        <button id="auto-click-btn-m" onclick="toggleAutoClicker()" title="Auto Click (Restes)" class="justify-center text-[9px] font-bold p-1.5 rounded shadow-md flex items-center gap-1 transition-all hidden"><span class="material-symbols-outlined text-sm">ads_click</span></button>
                    </div>
                </div>
                <div id="mobile-team-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll"></div>
            </div>
            <div id="mobile-bag-view" class="h-full w-full flex-col hidden bg-slate-800 absolute inset-0">
                <div class="p-2 bg-slate-700 flex items-center gap-2 border-b border-slate-600 shrink-0"><button onclick="closeMobileSubViews()" class="material-symbols-outlined text-white hover:text-yellow-400">arrow_back</button><h3 class="pixel-font text-xs text-yellow-300">SAC À DOS</h3></div>
                <div id="mobile-bag-content" class="flex-1 overflow-y-auto p-2 grid grid-cols-2 gap-2 custom-scroll"></div>
            </div>
            <div id="mobile-shop-view" class="h-full w-full flex-col hidden bg-slate-800 absolute inset-0">
                <div class="p-2 bg-slate-700 flex items-center gap-2 border-b border-slate-600 shrink-0"><button onclick="closeMobileSubViews()" class="material-symbols-outlined text-white hover:text-yellow-400">arrow_back</button><h3 class="pixel-font text-xs text-blue-300">POKÉSHOP</h3></div>
                <div id="mobile-shop-content" class="flex-1 overflow-y-auto p-3 space-y-3 custom-scroll"></div>
            </div>
            <div id="mobile-pc-view" class="h-full w-full flex-col hidden bg-slate-900 absolute inset-0">
                <div class="p-2 bg-green-900/50 flex items-center gap-2 border-b border-green-800 shrink-0"><button onclick="closeMobileSubViews()" class="material-symbols-outlined text-green-300 hover:text-white">arrow_back</button><h3 class="pixel-font text-xs text-green-300">PC DE LÉO</h3></div>
                <div id="mobile-pc-content" class="flex-1 overflow-y-auto p-2 pc-screen custom-scroll bg-black"></div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONSTANTS ---
const ITEMS = {
    // Consommables
    pokeball: { name: "Pokéball", price: 200, desc: "Capture des Pokémon (Faible chance)", type: "consumable", zone: 0, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png", invKey: "balls" },
    superball: { name: "Superball", price: 600, desc: "Capture des Pokémon (Moyenne chance x2)", type: "consumable", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png", invKey: "superballs" },
    hyperball: { name: "Hyperball", price: 1500, desc: "Capture des Pokémon (Haute chance x4)", type: "consumable", zone: 9, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png", invKey: "hyperballs" },
    candy: { name: "Bonbon", price: 5000, desc: "Fait monter un Pokémon de niveau", type: "consumable", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/rare-candy.png", invKey: "candy" },
    masterball: { name: "Master Ball", price: 200000, desc: "Capture à coup sûr (100%)", type: "consumable", zone: 16, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png", invKey: "masterball" },
    repel: { name: "Repousse", price: 2000, desc: "Empêche les Pokémon communs d'apparaître pendant 30s", type: "consumable", zone: 5, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/repel.png", invKey: "repel" },    
    xAttack: { name: "Attaque +", price: 7500, desc: "Dégâts/clic x2 (30s)", type: "consumable", zone: 8, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-attack.png", invKey: "xAttack" },
    xSpecial: { name: "Attaque Spé +", price: 10000, desc: "DPS Équipe x2 (30s)", type: "consumable", zone: 11, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-sp-atk.png", invKey: "xSpecial" },
    superRepel: { name: "Superepousse", price: 12000, desc: "Bloque Communs/Peu Communs (30s)", type: "consumable", zone: 13, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/super-repel.png", invKey: "superRepel" },
    pokeDoll: { name: "Poké Poupée", price: 7500, desc: "Invoque le Boss (Si déjà vaincu)", type: "consumable", zone: 15, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-doll.png", invKey: "pokeDoll" },
    // Améliorations
    runningShoes: { name: "Chaussures Sport", price: 2000, desc: "Divise le temps d'apparition des ennemis par 1.5", type: "upgrade", zone: 1, icon: "sprint", iconColor: "text-orange-400" },
    amuletCoin: { name: "Pièce Rune", price: 4000, desc: "Gains d'argent +30%", type: "upgrade", zone: 2, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/amulet-coin.png" },
    protein: { name: "Protéine", price: 7500, desc: "Augmente les dégâts du clic de +50%", type: "upgrade", zone: 3, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/protein.png" },
    expShare: { name: "Multi Exp", price: 12000, desc: "XP gagnée +50%", type: "upgrade", zone: 4, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/exp-share.png" },
    hardStone: { name: "Pierre Dure", price: 15000, desc: "Augmente les dégâts du clic de +30%", type: "upgrade", zone: 6, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/hard-stone.png" },
    bicycle: { name: "Bicyclette", price: 30000, desc: "Vitesse de spawn x3 (Remplace Chaussures)", type: "upgrade", zone: 7, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/bicycle.png" },
    luckyEgg: { name: "Oeuf Chance", price: 75000, desc: "XP gagnée x1.5", type: "upgrade", zone: 10, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/lucky-egg.png" },
    pokeradar: { name: "Poké-Radar", price: 45000, desc: "Affiche les Pokémon trouvables dans la zone actuelle.", type: "upgrade", zone: 8, icon: "radar", iconColor: "text-green-400" },
    leftovers: { name: "Restes", price: 150000, desc: "Auto-click 9 clics/sec", type: "upgrade", zone: 12, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/leftovers.png" }
};
const EVOLUTIONS = {
    1:{id:2,lvl:16,name:"Herbizarre"}, 2:{id:3,lvl:32,name:"Florizarre"},
    4:{id:5,lvl:16,name:"Reptincel"}, 5:{id:6,lvl:36,name:"Dracaufeu"},
    7:{id:8,lvl:16,name:"Carabaffe"}, 8:{id:9,lvl:36,name:"Tortank"},
    10:{id:11,lvl:7,name:"Chrysacier"}, 11:{id:12,lvl:10,name:"Papilusion"},
    13:{id:14,lvl:7,name:"Coconfort"}, 14:{id:15,lvl:10,name:"Dardargnan"},
    16:{id:17,lvl:18,name:"Roucoups"}, 17:{id:18,lvl:36,name:"Roucarnage"},
    19:{id:20,lvl:20,name:"Rattatac"},
    21:{id:22,lvl:20,name:"Rapasdepic"},
    23:{id:24,lvl:22,name:"Arbok"},
    25:{id:26,lvl:22,name:"Raichu"},
    27:{id:28,lvl:22,name:"Sablaireau"},
    29:{id:30,lvl:16,name:"Nidorina"}, 30:{id:31,lvl:36,name:"Nidoqueen"},
    32:{id:33,lvl:16,name:"Nidorino"}, 33:{id:34,lvl:36,name:"Nidoking"},
    35:{id:36,lvl:25,name:"Mélodelfe"},
    37:{id:38,lvl:25,name:"Feunard"},
    39:{id:40,lvl:25,name:"Grodoudou"},
    41:{id:42,lvl:22,name:"Nosferalto"},
    43:{id:44,lvl:21,name:"Ortide"}, 44:{id:45,lvl:32,name:"Rafflesia"}, // Rafflesia requires Stone usually
    46:{id:47,lvl:24,name:"Parasect"},
    48:{id:49,lvl:31,name:"Aéromite"},
    50:{id:51,lvl:26,name:"Triopikeur"},
    52:{id:53,lvl:28,name:"Persian"},
    54:{id:55,lvl:33,name:"Akwakwak"},
    56:{id:57,lvl:28,name:"Colossinge"},
    58:{id:59,lvl:25,name:"Arcanin"},
    60:{id:61,lvl:25,name:"Têtarte"}, 61:{id:62,lvl:35,name:"Tartard"},
    63:{id:64,lvl:16,name:"Kadabra"}, 64:{id:65,lvl:36,name:"Alakazam"}, // Trade logic ignored for clicker
    66:{id:67,lvl:28,name:"Machopeur"}, 67:{id:68,lvl:40,name:"Mackogneur"},
    69:{id:70,lvl:21,name:"Boustiflor"}, 70:{id:71,lvl:32,name:"Empiflor"},
    72:{id:73,lvl:30,name:"Tentacruel"},
    74:{id:75,lvl:25,name:"Gravalanch"}, 75:{id:76,lvl:36,name:"Grolem"},
    77:{id:78,lvl:40,name:"Galopa"},
    79:{id:80,lvl:37,name:"Flagadoss"},
    81:{id:82,lvl:30,name:"Magnéton"},
    84:{id:85,lvl:31,name:"Dodrio"},
    86:{id:87,lvl:34,name:"Lamantine"},
    88:{id:89,lvl:38,name:"Grotadmorv"},
    90:{id:91,lvl:30,name:"Crustabri"},
    92:{id:93,lvl:25,name:"Spectrum"}, 93:{id:94,lvl:40,name:"Ectoplasma"},
    96:{id:97,lvl:26,name:"Hypnomade"},
    98:{id:99,lvl:28,name:"Krabboss"},
    100:{id:101,lvl:30,name:"Électrode"},
    102:{id:103,lvl:30,name:"Noadkoko"},
    104:{id:105,lvl:28,name:"Ossatueur"},
    109:{id:110,lvl:35,name:"Smogogo"},
    111:{id:112,lvl:42,name:"Rhinoféros"},
    116:{id:117,lvl:32,name:"Hypocéan"},
    118:{id:119,lvl:33,name:"Poissoroy"},
    120:{id:121,lvl:30,name:"Staross"},
    129:{id:130,lvl:20,name:"Léviator"},
    133:{id:[134,135,136],lvl:20,name:["Aquali","Voltali","Pyroli"]},
    138:{id:139,lvl:40,name:"Amonistar"},
    140:{id:141,lvl:40,name:"Kabutops"},
    147:{id:148,lvl:30,name:"Draco"}, 148:{id:149,lvl:55,name:"Dracolosse"}
};

const BASE_STATS = {
    // --- STARTERS (Gros Buff) ---
    "1": 79,  "2": 101, "3": 131,  // Bulbizarre
    "4": 77,  "5": 101, "6": 133,  // Salamèche (Dracaufeu puissant)
    "7": 78,  "8": 101, "9": 132,  // Carapuce

    // --- INSECTES & DÉBUT DE JEU ---
    "10": 48, "11": 51, "12": 98,  // Papilusion
    "13": 48, "14": 51, "15": 98,  // Dardargnan
    "16": 62, "17": 87, "18": 119, // Roucarnage
    "19": 63, "20": 103,           // Rattatac
    "21": 65, "22": 110,           // Rapasdepic
    "23": 72, "24": 112,           // Arbok
    "25": 80, "26": 121,           // Pikachu / Raichu

    // --- SOL / FÉE / POISON ---
    "27": 75, "28": 112,           // Sablaireau
    "29": 68, "30": 91, "31": 126, // Nidoqueen
    "32": 68, "33": 91, "34": 126, // Nidoking
    "35": 80, "36": 120,           // Melodelfe
    "37": 74, "38": 126,           // Feunard
    "39": 67, "40": 108,           // Grodoudou
    "41": 61, "42": 113,           // Nosferalto
    "43": 80, "44": 98, "45": 122, // Rafflesia
    "46": 71, "47": 101,           // Parasect
    "48": 76, "49": 118,           // Aeromite
    "50": 66, "51": 101,           // Triopikeur

    // --- CHATS / PSY / COMBAT ---
    "52": 72, "53": 110,           // Persian
    "54": 80, "55": 125,           // Akwakwak
    "56": 76, "57": 113,           // Colossinge
    "58": 87, "59": 138,           // Arcanin
    "60": 75, "61": 96, "62": 127, // Tartard
    "63": 77, "64": 100, "65": 125,// Alakazam
    "66": 76, "67": 101, "68": 126,// Mackogneur
    "69": 75, "70": 97, "71": 122, // Empiflor
    "72": 83, "73": 128,           // Tentacruel

    // --- ROCHE / FEU / EAU / TANK ---
    "74": 75, "75": 97, "76": 123, // Grolem
    "77": 102, "78": 125,          // Galopa
    "79": 78, "80": 122,           // Flagadoss
    "81": 81, "82": 116,           // Magneton
    "83": 77, "84": 92, "85": 117, // Dodrio
    "86": 81, "87": 118,           // Lamantine
    "88": 81, "89": 125,           // Grotadmorv
    "90": 76, "91": 131,           // Crustabri
    "92": 77, "93": 101, "94": 125,// Ectoplasma
    "95": 96,                      // Onix (Buffé)

    // --- PSY / ELECTRIK / EXOTIQUE ---
    "96": 82, "97": 120,           // Hypnomade
    "98": 81, "99": 118,           // Krabboss
    "100": 82, "101": 120,         // Electrode
    "102": 81, "103": 130,         // Noadkoko
    "104": 80, "105": 106,         // Ossatueur
    "106": 113,                    // Kicklee
    "107": 113,                    // Tygnon
    "108": 96,                     // Excelangue
    "109": 85, "110": 122,         // Smogogo
    "111": 86, "112": 121,         // Rhinoferos
    "113": 112,                    // Leveinard (Buffé)
    "114": 108,                    // Saquedeneu
    "115": 122,                    // Kangourex

    // --- EAU / INSECTE / NORMAL ---
    "116": 73, "117": 135,         // Hypocean
    "118": 80, "119": 112,         // Poissoroy
    "120": 85, "121": 130,         // Staross
    "122": 115,                    // M. Mime
    "123": 125,                    // Insecateur
    "124": 113,                    // Lippoutou
    "125": 122,                    // Elektek
    "126": 123,                    // Magmar
    "127": 125,                    // Scarabrute
    "128": 122,                    // Tauros

    // --- SPÉCIAUX ---
    "129": 5, "130": 135,          // Léviator
    "131": 133,                    // Lokhlass
    "132": 72,                     // Metamorph
    "133": 81, "134": 131, "135": 131, "136": 131, // Evoli et évolutions

    // --- FOSSILES / RONFLEX ---
    "137": 98,                     // Porygon
    "138": 88, "139": 123,         // Amonistar
    "140": 88, "141": 123,         // Kabutops
    "142": 128,                    // Ptera
    "143": 135,                    // Ronflex

    // --- LÉGENDAIRES & MYTHIQUES ---
    "144": 145,                    // Artikodin
    "145": 145,                    // Electhor
    "146": 145,                    // Sulfura
    "147": 75, "148": 105, "149": 150, // Dracolosse
    "150": 170,                    // Mewtwo
    "151": 150                     // Mew
};

const BASE_HP = {
    // --- STARTERS ---
    "1": 53,  "2": 68, "3": 88,  // Bulbizarre
    "4": 51,  "5": 66, "6": 85,  // Salamèche
    "7": 53,  "8": 70, "9": 95,  // Carapuce (Le plus tanky)

    // --- INSECTES ---
    "10": 33, "11": 37, "12": 60,  // Papilusion
    "13": 32, "14": 35, "15": 60,  // Dardargnan

    // --- OISEAUX / RONGEURS ---
    "16": 42, "17": 58, "18": 77,  // Roucarnage
    "19": 38, "20": 67,            // Rattatac
    "21": 42, "22": 72,            // Rapasdepic
    "23": 50, "24": 73,            // Arbok
    "25": 40, "26": 68,            // Pikachu / Raichu

    // --- SOL / FÉE / POISON ---
    "27": 58, "28": 87,            // Sablaireau
    "29": 58, "30": 74, "31": 97,  // Nidoqueen
    "32": 53, "33": 70, "34": 97,  // Nidoking
    "35": 62, "36": 90,            // Melodelfe
    "37": 63, "38": 97,            // Feunard
    "39": 72, "40": 92,            // Grodoudou (Nerfé)
    "41": 43, "42": 77,            // Nosferalto
    "43": 57, "44": 72, "45": 92,  // Rafflesia
    "46": 52, "47": 77,            // Parasect
    "48": 57, "49": 78,            // Aeromite
    "50": 32, "51": 57,            // Triopikeur

    // --- CHATS / PSY / COMBAT ---
    "52": 52, "53": 73,            // Persian
    "54": 60, "55": 87,            // Akwakwak
    "56": 48, "57": 72,            // Colossinge
    "58": 67, "59": 90,            // Arcanin
    "60": 55, "61": 70, "62": 92,  // Tartard
    "63": 38, "64": 55, "65": 65,  // Alakazam (Fragile)
    "66": 58, "67": 72, "68": 88,  // Mackogneur
    "69": 50, "70": 67, "71": 87,  // Empiflor
    "72": 72, "73": 100,           // Tentacruel

    // --- ROCHE / FEU / EAU ---
    "74": 58, "75": 72, "76": 92,  // Grolem
    "77": 60, "78": 77,            // Galopa
    "79": 78, "80": 98,            // Flagadoss
    "81": 57, "82": 78,            // Magneton
    "83": 48, "84": 62, "85": 72,  // Dodrio
    "86": 72, "87": 98,            // Lamantine
    "88": 72, "89": 98,            // Grotadmorv
    "90": 58, "91": 92,            // Crustabri (Buffé)
    "92": 45, "93": 60, "94": 75,  // Ectoplasma
    "95": 80,                      // Onix (Gros Buff)

    // --- DIVERS ---
    "96": 77, "97": 100,           // Hypnomade
    "98": 62, "99": 82,            // Krabboss
    "100": 55, "101": 73,          // Electrode
    "102": 67, "103": 92,          // Noadkoko
    "104": 68, "105": 83,          // Ossatueur
    "106": 70, "107": 78,          // Hitmons
    "108": 72,                     // Excelangue
    "109": 62, "110": 83,          // Smogogo
    "111": 63, "112": 88,          // Rhinoferos
    "113": 120,                    // Leveinard (Équilibré)
    "114": 82,                     // Saquedeneu
    "115": 92,                     // Kangourex

    // --- EAU / INSECTE / NORMAL ---
    "116": 50, "117": 92,          // Hypocean
    "118": 60, "119": 80,          // Poissoroy
    "120": 57, "121": 82,          // Staross
    "122": 80,                     // M. Mime
    "123": 75,                     // Insecateur
    "124": 68,                     // Lippoutou
    "125": 70,                     // Elektek
    "126": 72,                     // Magmar
    "127": 82,                     // Scarabrute
    "128": 82,                     // Tauros

    // --- SPÉCIAUX ---
    "129": 20, "130": 95,          // Léviator
    "131": 102,                    // Lokhlass
    "132": 48,                     // Metamorph
    "133": 55, "134": 97, "135": 78, "136": 82, // Evoli line

    // --- FOSSILES / RONFLEX ---
    "137": 70,                     // Porygon
    "138": 82, "139": 98,          // Amonistar
    "140": 68, "141": 80,          // Kabutops
    "142": 72,                     // Ptera
    "143": 112,                    // Ronflex

    // --- LÉGENDAIRES ---
    "144": 105,                    // Artikodin
    "145": 95,                     // Electhor
    "146": 95,                     // Sulfura
    "147": 55, "148": 78, "149": 103, // Dracolosse
    "150": 95,                     // Mewtwo
    "151": 100                     // Mew
};

const ZONE_MULT = [1, 1.5, 2.2, 3.5, 6];

const TYPES = {
    NORMAL:"Normal", FIRE:"Fire", WATER:"Water", GRASS:"Grass", ELECTRIC:"Electric", ICE:"Ice", 
    FIGHTING:"Fighting", POISON:"Poison", GROUND:"Ground", FLYING:"Flying", PSYCHIC:"Psychic", 
    BUG:"Bug", ROCK:"Rock", GHOST:"Ghost", DRAGON:"Dragon", STEEL:"Steel", DARK:"Dark", FAIRY:"Fairy"
};

const TYPE_CHART = {
    Normal: { Rock: 0.5, Ghost: 0, Steel: 0.5 },
    Fire: { Fire: 0.5, Water: 0.5, Grass: 2, Ice: 2, Bug: 2, Rock: 0.5, Dragon: 0.5, Steel: 2 },
    Water: { Fire: 2, Water: 0.5, Grass: 0.5, Ground: 2, Rock: 2, Dragon: 0.5 },
    Grass: { Fire: 0.5, Water: 2, Grass: 0.5, Poison: 0.5, Ground: 2, Flying: 0.5, Bug: 0.5, Rock: 2, Dragon: 0.5, Steel: 0.5 },
    Electric: { Water: 2, Grass: 0.5, Electric: 0.5, Ground: 0, Flying: 2, Dragon: 0.5 },
    Ice: { Fire: 0.5, Grass: 2, Ice: 0.5, Ground: 2, Flying: 2, Dragon: 2, Steel: 0.5 },
    Fighting: { Normal: 2, Ice: 2, Poison: 0.5, Flying: 0.5, Psychic: 0.5, Bug: 0.5, Rock: 2, Ghost: 0, Dark: 2, Steel: 2, Fairy: 0.5 },
    Poison: { Grass: 2, Poison: 0.5, Ground: 0.5, Rock: 0.5, Ghost: 0.5, Steel: 0, Fairy: 2 },
    Ground: { Fire: 2, Grass: 0.5, Electric: 2, Poison: 2, Flying: 0, Bug: 0.5, Rock: 2, Steel: 2 },
    Flying: { Grass: 2, Electric: 0.5, Fighting: 2, Bug: 2, Rock: 0.5, Steel: 0.5 },
    Psychic: { Fighting: 2, Poison: 2, Psychic: 0.5, Dark: 0, Steel: 0.5 },
    Bug: { Fire: 0.5, Grass: 2, Fighting: 0.5, Poison: 0.5, Flying: 0.5, Psychic: 2, Ghost: 0.5, Dark: 2, Steel: 0.5, Fairy: 0.5 },
    Rock: { Fire: 2, Ice: 2, Fighting: 0.5, Ground: 0.5, Flying: 2, Bug: 2, Steel: 0.5 },
    Ghost: { Normal: 0, Psychic: 2, Ghost: 2, Dark: 0.5 },
    Dragon: { Dragon: 2, Steel: 0.5, Fairy: 0 },
    Steel: { Fire: 0.5, Water: 0.5, Electric: 0.5, Ice: 2, Rock: 2, Steel: 0.5, Fairy: 2 },
    Dark: { Fighting: 0.5, Psychic: 2, Ghost: 2, Dark: 0.5, Fairy: 0.5 },
    Fairy: { Fire: 0.5, Fighting: 2, Poison: 0.5, Dragon: 2, Dark: 2, Steel: 0.5 }
};

const PKMN_TYPES = {
    1: ["Grass", "Poison"], 2: ["Grass", "Poison"], 3: ["Grass", "Poison"],
    4: ["Fire"], 5: ["Fire"], 6: ["Fire", "Flying"],
    7: ["Water"], 8: ["Water"], 9: ["Water"],
    10: ["Bug"], 11: ["Bug"], 12: ["Bug", "Flying"],
    13: ["Bug", "Poison"], 14: ["Bug", "Poison"], 15: ["Bug", "Poison"],
    16: ["Normal", "Flying"], 17: ["Normal", "Flying"], 18: ["Normal", "Flying"],
    19: ["Normal"], 20: ["Normal"],
    21: ["Normal", "Flying"], 22: ["Normal", "Flying"],
    23: ["Poison"], 24: ["Poison"],
    25: ["Electric"], 26: ["Electric"],
    27: ["Ground"], 28: ["Ground"],
    29: ["Poison"], 30: ["Poison"], 31: ["Poison", "Ground"],
    32: ["Poison"], 33: ["Poison"], 34: ["Poison", "Ground"],
    35: ["Fairy"], 36: ["Fairy"], // Retcon Fée
    37: ["Fire"], 38: ["Fire"],
    39: ["Normal", "Fairy"], 40: ["Normal", "Fairy"], // Retcon Fée
    41: ["Poison", "Flying"], 42: ["Poison", "Flying"],
    43: ["Grass", "Poison"], 44: ["Grass", "Poison"], 45: ["Grass", "Poison"],
    46: ["Bug", "Grass"], 47: ["Bug", "Grass"],
    48: ["Bug", "Poison"], 49: ["Bug", "Poison"],
    50: ["Ground"], 51: ["Ground"],
    52: ["Normal"], 53: ["Normal"],
    54: ["Water"], 55: ["Water"],
    56: ["Fighting"], 57: ["Fighting"],
    58: ["Fire"], 59: ["Fire"],
    60: ["Water"], 61: ["Water"], 62: ["Water", "Fighting"],
    63: ["Psychic"], 64: ["Psychic"], 65: ["Psychic"],
    66: ["Fighting"], 67: ["Fighting"], 68: ["Fighting"],
    69: ["Grass", "Poison"], 70: ["Grass", "Poison"], 71: ["Grass", "Poison"],
    72: ["Water", "Poison"], 73: ["Water", "Poison"],
    74: ["Rock", "Ground"], 75: ["Rock", "Ground"], 76: ["Rock", "Ground"],
    77: ["Fire"], 78: ["Fire"],
    79: ["Water", "Psychic"], 80: ["Water", "Psychic"],
    81: ["Electric", "Steel"], 82: ["Electric", "Steel"], // Retcon Acier
    83: ["Normal", "Flying"], 84: ["Normal", "Flying"], 85: ["Normal", "Flying"],
    86: ["Water"], 87: ["Water", "Ice"],
    88: ["Poison"], 89: ["Poison"],
    90: ["Water"], 91: ["Water", "Ice"],
    92: ["Ghost", "Poison"], 93: ["Ghost", "Poison"], 94: ["Ghost", "Poison"],
    95: ["Rock", "Ground"],
    96: ["Psychic"], 97: ["Psychic"],
    98: ["Water"], 99: ["Water"],
    100: ["Electric"], 101: ["Electric"],
    102: ["Grass", "Psychic"], 103: ["Grass", "Psychic"],
    104: ["Ground"], 105: ["Ground"],
    106: ["Fighting"], 107: ["Fighting"],
    108: ["Normal"],
    109: ["Poison"], 110: ["Poison"],
    111: ["Ground", "Rock"], 112: ["Ground", "Rock"],
    113: ["Normal"],
    114: ["Grass"],
    115: ["Normal"],
    116: ["Water"], 117: ["Water"],
    118: ["Water"], 119: ["Water"],
    120: ["Water"], 121: ["Water", "Psychic"],
    122: ["Psychic", "Fairy"], // Retcon Fée
    123: ["Bug", "Flying"],
    124: ["Ice", "Psychic"],
    125: ["Electric"],
    126: ["Fire"],
    127: ["Bug"],
    128: ["Normal"],
    129: ["Water"], 130: ["Water", "Flying"],
    131: ["Water", "Ice"],
    132: ["Normal"],
    133: ["Normal"],
    134: ["Water"],
    135: ["Electric"],
    136: ["Fire"],
    137: ["Normal"],
    138: ["Rock", "Water"], 139: ["Rock", "Water"],
    140: ["Rock", "Water"], 141: ["Rock", "Water"],
    142: ["Rock", "Flying"],
    143: ["Normal"],
    144: ["Ice", "Flying"],
    145: ["Electric", "Flying"],
    146: ["Fire", "Flying"],
    147: ["Dragon"], 148: ["Dragon"], 149: ["Dragon", "Flying"],
    150: ["Psychic"], 151: ["Psychic"]
};

const TYPE_COLORS = {
    Normal: "#A8A77A", Fire: "#EE8130", Water: "#6390F0", Electric: "#F7D02C", Grass: "#7AC74C",
    Ice: "#96D9D6", Fighting: "#C22E28", Poison: "#A33EA1", Ground: "#E2BF65", Flying: "#A98FF3",
    Psychic: "#F95587", Bug: "#A6B91A", Rock: "#B6A136", Ghost: "#735797", Dragon: "#6F35FC",
    Steel: "#B7B7CE", Dark: "#705746", Fairy: "#D685AD"
};

const MILESTONES = [
    {count:10, title:"Débutant", desc:"Dégâts Clic x2"},
    {count:20, title:"Amateur", desc:"+2,500 $P"},
    {count:30, title:"Collectionneur", desc:"DPS Équipe +50%"},
    {count:40, title:"Dresseur", desc:"Omni XP (XP +100%)"},
    {count:50, title:"Expert", desc:"Spawn +20%"},
    {count:70, title:"Champion", desc:"Shop -15%"},
    {count:90, title:"Maître", desc:"Dégâts Totaux +50%"},
    {count:110, title:"Légende", desc:"Jeton Brillant"},
    {count:130, title:"Mythique", desc:"Master Ball + 10 Bonbons"},
    {count:151, title:"Kanto Master", desc:"Shiny Chance x2"}
];

// Map names to IDs manually for older entries, but preferred to put ID in ZONE data
const ID_MAP_FALLBACK = {
    "Rattata":19,"Roucool":16,"Rattatac":20,"Roucoups":17,"Bulbizarre":1,"Chenipan":10,"Aspicot":13,"Chrysacier":11,"Coconfort":14,
    "Pikachu":25,"Salamèche":4,"Papilusion":12,"Racaillou":74,"Sabelette":27,"Nidoran♀":29,"Nidoran♂":32,"Onix":95,"Carapuce":7,
    "Nosferapti":41,"Paras":46,"Mélofée":35,"Rondoudou":39,"Leveinard":113,"Mélodelfe":36,"Mystherbe":43,"Chétiflor":69,"Abra":63,
    "Mimitoss":48,"Mew":151,"Roucarnage":18
};

const BADGES = [
    {id:1, zoneIdx:2, name:"Roche", desc:"Dégâts Clic +50%"},
    {id:2, zoneIdx:4, name:"Cascade", desc:"DPS Équipe +30%"},
    {id:3, zoneIdx:6, name:"Foudre", desc:"Dégâts Totaux +20%"},
    {id:4, zoneIdx:10, name:"Prisme", desc:"Or gagné +20%"},
    {id:5, zoneIdx:12, name:"Âme", desc:"XP gagnée +50%"},
    {id:6, zoneIdx:14, name:"Marais", desc:"Taux Capture +30%"},
    {id:7, zoneIdx:16, name:"Volcan", desc:"Dégâts Totaux +50%"},
    {id:8, zoneIdx:17, name:"Terre", desc:"Vitesse de spawn +20%"}
];

const MAP_DATA = [
    { type: "rect", coords: [300,694,359,762], name: "Route 1", zoneId: 0, color: "orange" },
    { type: "rect", coords: [308,486,352,533], name: "Forêt de Jade", zoneId: 1, color: "blue" },
    { type: "circle", coords: [331,391,37], name: "Arène d'Argenta", zoneId: 2, color: "red" },
    { type: "polygon", coords: [607,307,652,307,652,353,607,353], name: "Mont Sélénite", zoneId: 3, color: "blue" },
    { type: "circle", coords: [931,331,38], name: "Arène d'Azuria", zoneId: 4, color: "red" },
    { type: "rect", coords: [900,248,961,287], name: "Pont Pépite", zoneId: 5, color: "orange" },
    { type: "circle", coords: [931,690,38], name: "Arène de Carmin", zoneId: 6, color: "red" },
    { type: "rect", coords: [968,666,1013,713], name: "Cave Taupiqueur", zoneId: 7, color: "blue" },
    { type: "rect", coords: [1147,307,1193,353], name: "Tunnel Rocheux", zoneId: 8, color: "blue" },
    { type: "circle", coords: [1171,511,38], name: "Lavanville", zoneId: null, color: "gray" }, // Non jouable
    { type: "rect", coords: [1163,502,1209,548], name: "Tour Pokémon", zoneId: 9, color: "blue" },
    { type: "circle", coords: [751,510,38], name: "Arène de Céladopole", zoneId: 10, color: "red" },
    { type: "rect", coords: [1147,367,1193,413], name: "Centrale", zoneId: 11, color: "blue" },
    { type: "circle", coords: [810,870,38], name: "Arène de Parmanie", zoneId: 12, color: "red" },
    { type: "rect", coords: [923,503,969,548], name: "Sylphe SARL", zoneId: 13, color: "blue" },
    { type: "circle", coords: [931,509,37], name: "Arène de Safrania", zoneId: 14, color: "red" },
    { type: "rect", coords: [547,967,593,1013], name: "Îles Écume", zoneId: 15, color: "blue" },
    { type: "circle", coords: [331,992,37], name: "Arène Cramois'Île", zoneId: 16, color: "red" },
    { type: "circle", coords: [331,630,37], name: "Arène de Jadielle", zoneId: 17, color: "red" },
    { type: "polygon", coords: [917,180,917,153,927,153,927,146,956,145,956,152,966,152,966,180,956,180,950,167,934,166,927,180], name: "Caverne Azurée", zoneId: 18, color: "cyan" },
    { type: "rect", coords: [186,368,232,412], name: "Route Victoire", zoneId: 19, color: "blue" },
    { type: "circle", coords: [210,331,37], name: "Ligue Pokémon", zoneId: 20, color: "red" },
    { type: "circle", coords: [331,811,35], name: "Bourg Palette", zoneId: null, color: "gray" },
    { type: "rect", coords: [308,428,352,474], name: "Daran Ass", zoneId: null, color: "gray" }
];

// ZONE CONFIGURATION (Updated with explicit IDs)
const ZONES = [
  // --- DÉBUT DE L'AVENTURE ---
  {id:1, name:"Route 1", bg:"img/background/Zone 1.png", minLevel:2, maxLevel:5,
   pokemons:[
     {name:"Rattata", id:19, rarity:"Commun", spawnRate:0.3, catchRate:255},
     {name:"Roucool", id:16, rarity:"Commun", spawnRate:0.3, catchRate:255},
     {name:"Piafabec", id:21, rarity:"Commun", spawnRate:0.2, catchRate:255}, // NOUVEAU
     {name:"Rattatac", id:20, rarity:"Peu Commun", spawnRate:0.1, catchRate:127},
     {name:"Roucoups", id:17, rarity:"Peu Commun", spawnRate:0.05, catchRate:120},
     {name:"Bulbizarre", id:1, rarity:"Très Rare", spawnRate:0.05, catchRate:45}
   ], boss:{name:"Rattata (Géant)", id:19, level:6, catchRate:0}},
  
  {id:2, name:"Forêt de Jade", bg:"img/background/Zone 2.png", minLevel:5, maxLevel:8,
   pokemons:[
     {name:"Chenipan", id:10, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Aspicot", id:13, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Chrysacier", id:11, rarity:"Peu Commun", spawnRate:0.15, catchRate:120},
     {name:"Coconfort", id:14, rarity:"Peu Commun", spawnRate:0.15, catchRate:120},
     {name:"Pikachu", id:25, rarity:"Rare", spawnRate:0.15, catchRate:190},
     {name:"Salamèche", id:4, rarity:"Très Rare", spawnRate:0.05, catchRate:45}
   ], boss:{name:"Papilusion", id:12, level:10, catchRate:0}},

  // BADGE 1 : ROCHE
  {id:3, name:"Arène d'Argenta", bg:"img/background/Zone 3.png", minLevel:9, maxLevel:12,
   pokemons:[
     {name:"Racaillou", id:74, rarity:"Commun", spawnRate:0.3, catchRate:255},
     {name:"Sabelette", id:27, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Nidoran♀", id:29, rarity:"Peu Commun", spawnRate:0.15, catchRate:235},
     {name:"Nidoran♂", id:32, rarity:"Peu Commun", spawnRate:0.15, catchRate:235},
     {name:"Onix", id:95, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Carapuce", id:7, rarity:"Très Rare", spawnRate:0.05, catchRate:45}
   ], boss:{name:"Pierre (Onix)", id:95, level:14, catchRate:0, badge:"Roche"}},

  {id:4, name:"Mont Sélénite", bg:"img/background/Zone 4.png", minLevel:12, maxLevel:15,
   pokemons:[
     {name:"Nosferapti", id:41, rarity:"Commun", spawnRate:0.4, catchRate:255},
     {name:"Paras", id:46, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Magicarpe", id:129, rarity:"Commun", spawnRate:0.2, catchRate:255}, // NOUVEAU (Le fameux vendeur)
     {name:"Mélofée", id:35, rarity:"Rare", spawnRate:0.1, catchRate:150},
     {name:"Rondoudou", id:39, rarity:"Rare", spawnRate:0.05, catchRate:170},
     {name:"Leveinard", id:113, rarity:"Très Rare", spawnRate:0.05, catchRate:30}
   ], boss:{name:"Mélodelfe", id:36, level:16, catchRate:0}},

  // BADGE 2 : CASCADE
  {id:5, name:"Arène d'Azuria", bg:"img/background/Zone 5.png", minLevel:15, maxLevel:18,
   pokemons:[
     {name:"Mystherbe", id:43, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Chétiflor", id:69, rarity:"Commun", spawnRate:0.25, catchRate:255},
     {name:"Ptitard", id:60, rarity:"Peu Commun", spawnRate:0.2, catchRate:255}, // NOUVEAU
     {name:"Stari", id:120, rarity:"Peu Commun", spawnRate:0.15, catchRate:225},
     {name:"Poissirène", id:118, rarity:"Peu Commun", spawnRate:0.1, catchRate:225},
     {name:"Psykokwak", id:54, rarity:"Rare", spawnRate:0.05, catchRate:190}
   ], boss:{name:"Ondine (Staross)", id:121, level:21, catchRate:0, badge:"Cascade"}},

  // ZONE SPÉCIALE MEW
  {id:6, name:"Pont Pépite", bg:"img/background/Zone 6.png", minLevel:17, maxLevel:20,
   pokemons:[
     {name:"Abra", id:63, rarity:"Commun", spawnRate:0.3, catchRate:200},
     {name:"Roucoups", id:17, rarity:"Commun", spawnRate:0.2, catchRate:120},
     {name:"Mimitoss", id:48, rarity:"Peu Commun", spawnRate:0.2, catchRate:190},
     {name:"Ramoloss", id:79, rarity:"Peu Commun", spawnRate:0.15, catchRate:190},
     {name:"Rapasdepic", id:22, rarity:"Rare", spawnRate:0.14, catchRate:90}, // NOUVEAU (Le "Shield" anti-Mew)
     {name:"Mew", id:151, rarity:"Légendaire", spawnRate:0.01, catchRate:45}
   ], boss:{name:"Rival (Roucarnage)", id:18, level:23, catchRate:0}},

  // BADGE 3 : FOUDRE
  {id:7, name:"Arène de Carmin", bg:"img/background/Zone 7.png", minLevel:20, maxLevel:25,
   pokemons:[
     {name:"Voltorbe", id:100, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Magnéti", id:81, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Miaouss", id:52, rarity:"Peu Commun", spawnRate:0.2, catchRate:255},
     {name:"Canarticho", id:83, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Pikachu", id:25, rarity:"Rare", spawnRate:0.1, catchRate:190}
   ], boss:{name:"Major Bob (Raichu)", id:26, level:26, catchRate:0, badge:"Foudre"}},

  {id:8, name:"Cave Taupiqueur", bg:"img/background/Zone 8.png", minLevel:23, maxLevel:27,
   pokemons:[
     {name:"Taupiqueur", id:50, rarity:"Commun", spawnRate:0.8, catchRate:255},
     {name:"Osselait", id:104, rarity:"Rare", spawnRate:0.1, catchRate:190},
     {name:"Triopikeur", id:51, rarity:"Très Rare", spawnRate:0.1, catchRate:50}
   ], boss:{name:"Triopikeur", id:51, level:29, catchRate:0}},

  {id:9, name:"Tunnel Rocheux", bg:"img/background/Zone 9.png", minLevel:25, maxLevel:30,
   pokemons:[
     {name:"Machoc", id:66, rarity:"Commun", spawnRate:0.35, catchRate:180},
     {name:"Férosinge", id:56, rarity:"Commun", spawnRate:0.35, catchRate:190},
     {name:"Gravalanch", id:75, rarity:"Rare", spawnRate:0.2, catchRate:120},
     {name:"Onix", id:95, rarity:"Très Rare", spawnRate:0.1, catchRate:45}
   ], boss:{name:"Grolem", id:76, level:33, catchRate:0}},

  {id:10, name:"Tour Pokémon", bg:"img/background/Zone 10.png", minLevel:28, maxLevel:33,
   pokemons:[
     {name:"Fantominus", id:92, rarity:"Commun", spawnRate:0.5, catchRate:190},
     {name:"Spectrum", id:93, rarity:"Peu Commun", spawnRate:0.25, catchRate:90},
     {name:"Têtarte", id:61, rarity:"Peu Commun", spawnRate:0.15, catchRate:120}, // NOUVEAU (Pour faire évoluer en Tartard)
     {name:"Soporifik", id:96, rarity:"Rare", spawnRate:0.05, catchRate:190},
     {name:"Ossatueur", id:105, rarity:"Très Rare", spawnRate:0.05, catchRate:75}
   ], boss:{name:"Ectoplasma", id:94, level:36, catchRate:0}},

  // BADGE 4 : PRISME
  {id:11, name:"Arène de Céladopole", bg:"img/background/Zone 11.png", minLevel:30, maxLevel:35,
   pokemons:[
     {name:"Goupix", id:37, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Caninos", id:58, rarity:"Commun", spawnRate:0.25, catchRate:190},
     {name:"Noeunoeuf", id:102, rarity:"Peu Commun", spawnRate:0.2, catchRate:90}, // NOUVEAU
     {name:"Ortide", id:44, rarity:"Peu Commun", spawnRate:0.1, catchRate:120},
     {name:"Boustiflor", id:70, rarity:"Peu Commun", spawnRate:0.1, catchRate:120},
     {name:"Évoli", id:133, rarity:"Rare", spawnRate:0.1, catchRate:45}
   ], boss:{name:"Erika (Empiflor)", id:71, level:39, catchRate:0, badge:"Prisme"}},

  // ZONE LÉGENDAIRE 1
  {id:12, name:"Centrale", bg:"img/background/Zone 12.png", minLevel:32, maxLevel:38,
   pokemons:[
     {name:"Voltorbe", id:100, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Magnéti", id:81, rarity:"Commun", spawnRate:0.3, catchRate:190},
     {name:"Élektek", id:125, rarity:"Rare", spawnRate:0.2, catchRate:45}, // Sert de shield Rare
     {name:"Électrode", id:101, rarity:"Peu Commun", spawnRate:0.15, catchRate:60},
     {name:"Ronflex", id:143, rarity:"Très Rare", spawnRate:0.05, catchRate:25}, // NOUVEAU (Shield Très Rare)
     {name:"Électhor", id:145, rarity:"Légendaire", spawnRate:0.02, catchRate:3}
   ], boss:{name:"Électhor", id:145, level:45, catchRate:0}},

  // BADGE 5 : ÂME (Mix Parmanie + Safari pour tout avoir)
  {id:13, name:"Arène de Parmanie", bg:"img/background/Zone 13.png", minLevel:35, maxLevel:40,
   pokemons:[
     {name:"Nidorino", id:33, rarity:"Commun", spawnRate:0.12, catchRate:120},
     {name:"Nidorina", id:30, rarity:"Commun", spawnRate:0.12, catchRate:120},
     {name:"Doduo", id:84, rarity:"Peu Commun", spawnRate:0.12, catchRate:190},
     {name:"Tentacool", id:72, rarity:"Peu Commun", spawnRate:0.12, catchRate:190},
     // Les Rares du Safari
     {name:"Kangourex", id:115, rarity:"Rare", spawnRate:0.08, catchRate:45},
     {name:"Insécateur", id:123, rarity:"Rare", spawnRate:0.08, catchRate:45},
     {name:"Scarabrute", id:127, rarity:"Rare", spawnRate:0.08, catchRate:45},
     {name:"Tauros", id:128, rarity:"Rare", spawnRate:0.08, catchRate:45},
     {name:"Saquedeneu", id:114, rarity:"Rare", spawnRate:0.1, catchRate:45},
     // Le Très Rare
     {name:"Minidraco", id:147, rarity:"Très Rare", spawnRate:0.1, catchRate:45}
   ], boss:{name:"Koga (Smogogo)", id:110, level:45, catchRate:0, badge:"Âme"}},

  {id:14, name:"Sylphe SARL", bg:"img/background/Zone 14.png", minLevel:38, maxLevel:43,
   pokemons:[
     {name:"Abo", id:23, rarity:"Commun", spawnRate:0.2, catchRate:255},
     {name:"Smogo", id:109, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Tadmorv", id:88, rarity:"Peu Commun", spawnRate:0.2, catchRate:190},
     {name:"Porygon", id:137, rarity:"Rare", spawnRate:0.2, catchRate:45}, // Passé en Rare
     {name:"Métamorph", id:132, rarity:"Très Rare", spawnRate:0.1, catchRate:35}, // NOUVEAU (Le clone raté)
     {name:"Lokhlass", id:131, rarity:"Très Rare", spawnRate:0.1, catchRate:45}
   ], boss:{name:"Giovanni (Persian)", id:53, level:47, catchRate:0}},

  // BADGE 6 : MARAIS
  {id:15, name:"Arène de Safrania", bg:"img/background/Zone 15.png", minLevel:40, maxLevel:45,
   pokemons:[
     {name:"Abra", id:63, rarity:"Commun", spawnRate:0.3, catchRate:200},
     {name:"Kadabra", id:64, rarity:"Peu Commun", spawnRate:0.2, catchRate:100},
     {name:"M. Mime", id:122, rarity:"Rare", spawnRate:0.15, catchRate:45},
     {name:"Kicklee", id:106, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Tygnon", id:107, rarity:"Rare", spawnRate:0.1, catchRate:45},
     {name:"Excelangue", id:108, rarity:"Rare", spawnRate:0.15, catchRate:45}
   ], boss:{name:"Sabrina (Alakazam)", id:65, level:48, catchRate:0, badge:"Marais"}},

  // ZONE LÉGENDAIRE 2
  {id:16, name:"Îles Écume", bg:"img/background/Zone 16.png", minLevel:43, maxLevel:48,
   pokemons:[
     // Les Communs 
     {name:"Otaria", id:86, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Kokiyas", id:90, rarity:"Commun", spawnRate:0.2, catchRate:190},
     
     // Les Peu Communs
     {name:"Krabby", id:98, rarity:"Peu Commun", spawnRate:0.15, catchRate:225},
     {name:"Hypotrempe", id:116, rarity:"Peu Commun", spawnRate:0.15, catchRate:190},
     {name:"Tentacruel", id:73, rarity:"Rare", spawnRate:0.15, catchRate:60},
     {name:"Lamantine", id:87, rarity:"Très Rare", spawnRate:0.1, catchRate:75},
     
     // Le Boss Légendaire
     {name:"Artikodin", id:144, rarity:"Légendaire", spawnRate:0.05, catchRate:3}
   ], boss:{name:"Artikodin", id:144, level:50, catchRate:0}},

  // BADGE 7 : VOLCAN
  {id:17, name:"Arène de Cramois'Île", bg:"img/background/Zone 17.png", minLevel:45, maxLevel:50,
   pokemons:[
     {name:"Ponyta", id:77, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Goupix", id:37, rarity:"Commun", spawnRate:0.2, catchRate:190},
     {name:"Magmar", id:126, rarity:"Rare", spawnRate:0.15, catchRate:45},
     {name:"Amonita", id:138, rarity:"Très Rare", spawnRate:0.15, catchRate:45},
     {name:"Kabuto", id:140, rarity:"Très Rare", spawnRate:0.15, catchRate:45},
     {name:"Ptéra", id:142, rarity:"Très Rare", spawnRate:0.15, catchRate:45}
   ], boss:{name:"Blaine (Arcanin)", id:59, level:54, catchRate:0, badge:"Volcan"}},

  // BADGE 8 : TERRE (Jadielle déplacée avant Azurée)
  {id:18, name:"Arène de Jadielle", bg:"img/background/Zone 18.png", minLevel:50, maxLevel:58,
   pokemons:[
     {name:"Nidorino", id:33, rarity:"Commun", spawnRate:0.25, catchRate:120},
     {name:"Nidorina", id:30, rarity:"Commun", spawnRate:0.25, catchRate:120},
     {name:"Rhinocorne", id:111, rarity:"Peu Commun", spawnRate:0.2, catchRate:120},
     {name:"Triopikeur", id:51, rarity:"Rare", spawnRate:0.15, catchRate:50},
     {name:"Rhinoféros", id:112, rarity:"Rare", spawnRate:0.15, catchRate:60}
   ], boss:{name:"Giovanni (Rhinoféros)", id:112, level:60, catchRate:0, badge:"Terre"}},

  // ZONE LÉGENDAIRE 3 + MEWTWO (Votre demande spécifique)
  {id:19, name:"Caverne Azurée", bg:"img/background/Zone 19.png", minLevel:55, maxLevel:65,
   pokemons:[
     {name:"Parasect", id:47, rarity:"Commun", spawnRate:0.2, catchRate:75},
     {name:"Kadabra", id:64, rarity:"Commun", spawnRate:0.2, catchRate:100},
     {name:"Raichu", id:26, rarity:"Rare", spawnRate:0.25, catchRate:75}, // Shield Rare
     {name:"Draco", id:148, rarity:"Très Rare", spawnRate:0.3, catchRate:45}, // Shield Très Rare (Haut taux pour compenser Mewtwo)
     {name:"Mewtwo", id:150, rarity:"Légendaire", spawnRate:0.05, catchRate:3}
   ], boss:{name:"Mewtwo", id:150, level:70, catchRate:0}},

  // ROUTE VICTOIRE
  {id:20, name:"Route Victoire", bg:"img/background/Zone 20.png", minLevel:60, maxLevel:70,
   pokemons:[
     {name:"Machopeur", id:67, rarity:"Commun", spawnRate:0.3, catchRate:90},
     {name:"Gravalanch", id:75, rarity:"Peu Commun", spawnRate:0.3, catchRate:120},
     {name:"Nosferalto", id:42, rarity:"Rare", spawnRate:0.25, catchRate:90}, // Shield Rare
     {name:"Dracolosse", id:149, rarity:"Très Rare", spawnRate:0.1, catchRate:45}, // Shield Très Rare
     {name:"Sulfura", id:146, rarity:"Légendaire", spawnRate:0.05, catchRate:3}
   ], boss:{name:"Sulfura", id:146, level:80, catchRate:0}},

  // LA LIGUE (Final Boss)
  {id:21, name:"Ligue Pokémon", bg:"img/background/Zone 21.png", minLevel:70, maxLevel:90,
   pokemons:[
     // OLGA (Glace/Eau)
     {name:"Lokhlass", id:131, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Lippoutou", id:124, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     
     // ALDO (Combat/Roche)
     {name:"Mackogneur", id:68, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Onix", id:95, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     
     // AGATHA (Spectre/Poison)
     {name:"Ectoplasma", id:94, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Arbok", id:24, rarity:"Conseil 4", spawnRate:0.1, catchRate:90},
     
     // PETER (Dragon)
     {name:"Dracolosse", id:149, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},
     {name:"Léviator", id:130, rarity:"Conseil 4", spawnRate:0.1, catchRate:45},

     // MAÎTRE BLUE (Son 1er Pokémon)
     {name:"Roucarnage", id:18, rarity:"Maître", spawnRate:0.1, catchRate:45}
   ], 
   // Le Boss est défini dynamiquement
   boss:{name:"Maître Blue", id:9, level:100, catchRate:0}}
];

// --- STATE ---
let state = {
    money: 0, 
    inv: { balls: 5, superballs: 0, hyperballs: 0, candy: 0, omniXp: 0, shinyToken: 0, masterball: 0, repel: 0, xAttack: 0, xSpecial: 0, superRepel: 0, pokeDoll: 0 },
    upgrades: { runningShoes: false, amuletCoin: false, protein: false, expShare: false, hardStone: false, bicycle: false, luckyEgg: false, leftovers: false, pokeradar: false },
    team: [], 
    pc: [],
    pokedex: [],
    badges: [],
    milestones: [],
    repelEndTime: 0,
    attackBoostEndTime: 0,
    dpsBoostEndTime: 0,
    superRepelEndTime: 0,
    zoneIdx: 0, 
    subStage: 1, 
    unlockedZone: 0,
    auto: true, 
    autoClicker: false,
    starterId: null,
    cheat: false,
    stats: { kills: 0, totalMoney: 0 },
    stopOnRare: true,
    autoStopSettings: { 'Commun': false, 'Peu Commun': false, 'Rare': true, 'Très Rare': true, 'Légendaire': true, 'Shiny': true },
    interruptedState: null,
    swapIdx: null,
    candyMode: false,
    candyTargetIdx: null,
    candyAmount: 1,
    editingTeamIdx: null,
    editingPcIdx: null
};

// Runtime variables (not saved)
let enemy = { hp: 10, maxHp: 10, id: 0, level: 1, isBoss: false, isShiny: false, catchRate: 1, name: "", rarity: "Commun", dead: false };
let audioCtx = false, synth = null;
let bossTimer = null;
let autoSaveInterval = null;
let autoClickerInterval = null;
let evolvingPokemon = { uid: null, endTime: 0, oldId: null, newId: null };
let evolutionInterval = null;
let victoryInterval = null;
let fireworkInterval = null;

// --- INIT ---
function init() {
    // Check for save
    if (localStorage.getItem('pokiClickerSave')) {
        document.getElementById('starter-modal').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        document.getElementById('game-ui').classList.remove('opacity-0');
        loadGame();
    } else {
        document.getElementById('starter-modal').classList.remove('hidden');
    }
}

function startGame(starterId) {
    state.starterId = starterId;
    let name = starterId===1?"Bulbizarre":starterId===4?"Salamèche":"Carapuce";
    addToTeam(starterId, name, 5, false);
    addToPokedex(starterId);
    
    document.getElementById('starter-modal').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    
    // Fade in
    setTimeout(()=>document.getElementById('game-ui').classList.remove('opacity-0'), 100);
    
    initAudio();
    spawnEnemy();
    updateBg(); 
    updateUI(); 
    renderShop(); 
    renderBag();
    startAutoClicker();
    startAutoSave();
}

function startAutoSave() {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    autoSaveInterval = setInterval(() => {
        localStorage.setItem('pokiClickerSave', JSON.stringify(state));
    }, 10000); // Save every 10s
}

function initAudio() { 
    if(!audioCtx) { 
        audioCtx=true; 
        try {
            synth=new Tone.PolySynth(Tone.Synth).toDestination(); 
            synth.volume.value=-12; 
        } catch(e) { console.log("Audio disabled"); }
    } 
}

function playTone(t) {
    if(!audioCtx || !synth) return;
    try {
        const now = Tone.now();
        if(t==='hit') synth.triggerAttackRelease("C2","32n",now);
        if(t==='coin') synth.triggerAttackRelease("B4","16n",now);
        if(t==='catch') synth.triggerAttackRelease(["C4","E4","G4"],"16n",now);
        if(t==='up') synth.triggerAttackRelease(["G3","C4"],"16n",now);
        if(t==='pc') synth.triggerAttackRelease(["E5","C5"],"16n",now);
    } catch(e){}
}

// --- CORE MECHANICS ---

function getPower(id) {
    const atk = BASE_STATS[id] || 40;
    const hp = BASE_HP[id] || 40;
    return atk + hp;
}

function calcMaxXp(id, level) {
    const power = getPower(id);
    // Tier : Faible (0.8), Fort (1.2), Moyen (1.0)
    let tier = (power < 100) ? 0.8 : (power > 180) ? 1.2 : 1.0;
    return Math.floor(50 * Math.pow(level, 2.2) * tier);
}

function calculateGoldReward(enemy) {
    // Formule : Base linéaire + légère courbe.
    // Niv 5 = ~25$ | Niv 20 = ~120$ | Niv 50 = ~500$
    let baseReward = (enemy.level * 4) + Math.pow(enemy.level, 1.4);
    
    // Bonus de rareté
    if (enemy.isBoss) baseReward *= 10;
    else if (enemy.rarity === "Rare" || enemy.rarity === "Très Rare") baseReward *= 3;
    else if (enemy.rarity === "Légendaire") baseReward *= 20;

    // Bonus Item (Pièce Rune)
    if (state.upgrades.amuletCoin) baseReward *= 1.3;

    return Math.floor(baseReward);
}

function getTypes(id) {
    return PKMN_TYPES[id] || ["Normal"];
}

function getMultiplier(atkId, defId) {
    if(!defId) return 1;
    const atkType = getTypes(atkId)[0]; // Primary type attacks
    const defTypes = getTypes(defId);
    let mult = 1;
    
    defTypes.forEach(dt => {
        if(TYPE_CHART[atkType] && TYPE_CHART[atkType][dt] !== undefined) {
            mult *= TYPE_CHART[atkType][dt];
        }
    });
    return mult;
}

function hasBadge(name) { return state.badges.includes(name); }

function hasMilestone(c) { return state.milestones.includes(c); }

function getDPS(targetId) { 
    let dps = state.team.reduce((s,p) => {
        let m = targetId ? getMultiplier(p.id, targetId) : 1;
        
        // Easter Egg: Johnny
        if (targetId && p.name === "Johnny" && getTypes(targetId).includes("Dark")) {
            m *= 1.5;
        }

        let shinyBonus = p.isShiny ? 2 : 1; // Shiny deals x2 damage
        let baseStat = BASE_STATS[p.id] || 40; // Fallback if ID missing
        let rawDmg = (baseStat * p.level) / 5;
        return s + (rawDmg * m * shinyBonus);
    }, 0); 
    
    if(hasMilestone(30)) dps *= 1.5;
    if(hasMilestone(90)) dps *= 1.5;
    if(hasBadge("Cascade")) dps *= 1.3;
    if(hasBadge("Foudre")) dps *= 1.2;
    if(hasBadge("Volcan")) dps *= 1.5;
    if(Date.now() < state.dpsBoostEndTime) dps *= 2;
    return dps;
}

function getClick() { 
    let dmg = 5 + Math.floor(getDPS(enemy.id)*0.002);
    if(hasMilestone(10)) dmg *= 2;
    if(hasMilestone(90)) dmg *= 1.5;
    if(state.upgrades.protein) dmg = Math.floor(dmg * 1.5);
    if(state.upgrades.hardStone) dmg = Math.floor(dmg * 1.3);
    if(hasBadge("Roche")) dmg = Math.floor(dmg * 1.5);
    if(hasBadge("Foudre")) dmg = Math.floor(dmg * 1.2);
    if(hasBadge("Volcan")) dmg *= 1.5;
    if(Date.now() < state.attackBoostEndTime) dmg *= 2;
    return state.cheat ? 999999 : dmg; 
}

function toggleCheat() {
    if (!state.cheat) {
        const pwd = prompt("Mot de passe requis pour activer la triche :");
        if (pwd !== "peter2005") {
            alert("Mot de passe incorrect !");
            return;
        }
    }
    state.cheat = !state.cheat;
    const updateBtn = (id, baseClass) => {
        const b = document.getElementById(id);
        if(!b) return;
        b.className = state.cheat ? 
            `${baseClass} bg-red-600 text-white border-red-400 cheat-active` : 
            `${baseClass} bg-gray-800 text-gray-400 border border-gray-600 hover:bg-gray-700 opacity-50 hover:opacity-100`;
        b.innerText = state.cheat ? "CHEAT: ON" : "CHEAT: OFF";
    };
    updateBtn('cheat-btn', "px-2 py-1 rounded text-[10px] font-bold transition-all");
    renderShop();
    updateZone();
}

function startBossTimer() {
    const w = document.getElementById('boss-timer-wrapper');
    const b = document.getElementById('boss-timer-bar');
    w.classList.remove('hidden');
    b.style.width = "100%";
    
    let t = 30;
    bossTimer = setInterval(() => {
        t--;
        b.style.width = (t/30*100)+"%";
        if(t<=0) {
            stopBossTimer();
            showFeedback("TEMPS ÉCOULÉ !", "red");
            state.subStage = 9;
            updateZone();
            spawnEnemy();
        }
    }, 1000);
}

function stopBossTimer() {
    if(bossTimer) clearInterval(bossTimer);
    bossTimer = null;
    const w = document.getElementById('boss-timer-wrapper');
    if(w) w.classList.add('hidden');
}

function spawnEnemy() {
    stopBossTimer();
    document.getElementById('searching-msg').classList.add('hidden');
    document.getElementById('enemy-sprite').classList.remove('hidden');

    enemy.dead = false;
    enemy.isCatching = false;
    enemy.uid = Date.now(); // Unique ID to prevent race conditions
    const z = ZONES[state.zoneIdx];
    enemy.isBoss = (state.subStage === 10);
    
    let shinyChance = hasMilestone(151) ? (1/128) : (1/256);
    if(state.cheat) shinyChance = 1;
    enemy.isShiny = !enemy.isBoss && Math.random() < shinyChance; 
    
    if(enemy.isBoss) {
        enemy.name = z.boss.name; 
        enemy.level = z.boss.level; 
        enemy.catchRate = z.boss.catchRate;
        enemy.id = z.boss.id;

        // --- LOGIQUE BOSS FINAL (MAÎTRE BLUE) ---
        // Zone 21 est à l'index 20
        if (state.zoneIdx === 20) { 
            if (state.starterId === 1) { // Joueur a Bulbizarre -> Rival a Dracaufeu
                enemy.id = 6; 
            } else if (state.starterId === 4) { // Joueur a Salamèche -> Rival a Tortank
                enemy.id = 9;
            } else if (state.starterId === 7) { // Joueur a Carapuce -> Rival a Florizarre
                enemy.id = 3;
            }
        }
        enemy.rarity = "Boss";
        startBossTimer();
    } else {
        const r = Math.random(); 
        let acc = 0; 
        
        // Repel Logic
        let pool = z.pokemons;
        if(Date.now() < state.superRepelEndTime) {
            const filtered = pool.filter(p => p.rarity !== "Commun" && p.rarity !== "Peu Commun");
            if(filtered.length > 0) pool = filtered;
        } else if(Date.now() < state.repelEndTime) {
            const filtered = pool.filter(p => p.rarity !== "Commun");
            if(filtered.length > 0) pool = filtered;
        }

        let sel = pool[0];
        for(let p of pool) { 
            acc += p.spawnRate; 
            if(r <= acc) { sel = p; break; } 
        }
        enemy.name = sel.name; 
        enemy.rarity = sel.rarity;
        enemy.id = sel.id || ID_MAP_FALLBACK[sel.name] || 25; 
        enemy.catchRate = sel.catchRate;
        enemy.level = Math.floor(Math.random()*(z.maxLevel-z.minLevel+1))+z.minLevel;
    }

    // Stop auto battle for rares
    const shouldStop = state.stopOnRare && (state.autoStopSettings[enemy.rarity] || (enemy.isShiny && state.autoStopSettings.Shiny));

    if(shouldStop && (state.auto || state.autoClicker)) {
        state.interruptedState = { auto: state.auto, autoClicker: state.autoClicker };
        state.auto = false; 
        state.autoClicker = false;
        updateAutoBtn(); updateAutoClickerBtn();
        const a = document.getElementById('rare-alert'); 
        const msg = enemy.isShiny ? "SHINY APPARU ! AUTO STOPPÉ !" : `${enemy.rarity.toUpperCase()} APPARU ! AUTO STOPPÉ !`;
        a.firstElementChild.innerHTML = `<span class="material-symbols-outlined">warning</span> ${msg}`;
        a.classList.remove('hidden');
        setTimeout(()=>a.classList.add('hidden'), 3000);
    }

    // HP Scaling
    const baseHp = BASE_HP[enemy.id] || 40;
    const zoneMult = ZONE_MULT[state.zoneIdx] || (6 + (state.zoneIdx - 4) * 2.5);
    enemy.maxHp = Math.floor((baseHp * enemy.level * 2) * zoneMult);
    if(enemy.isBoss) enemy.maxHp *= 4;
    enemy.hp = enemy.maxHp;
    updateUI(); // Refresh DPS display for new enemy
    updateEnemyUI();
    renderTeam(); // Refresh team DPS multipliers for new enemy
}

function damageEnemy(amt) {
    if(enemy.dead) return;
    enemy.hp -= amt;
    if(enemy.hp <= 0) {
        enemy.hp = 0;
        killEnemy();
    }
    updateHp();
}

function killEnemy() {
    if(enemy.dead) return; 
    stopBossTimer();
    enemy.dead = true;
    state.stats.kills++;
    
    let gold = calculateGoldReward(enemy);

    if(hasBadge("Prisme")) gold = Math.floor(gold * 1.2);
    if(enemy.isShiny) {
        gold *= 5;
        state.inv.candy += 5;
        showFeedback("SHINY! +5 BONBONS", "purple");
    }

    state.money += gold;
    if(!state.stats.totalMoney) state.stats.totalMoney = 0;
    state.stats.totalMoney += gold;
    
    // XP Logic
    const baseHp = BASE_HP[enemy.id] || 40;
    // MODIFICATION : Équilibrage (* 2.2)
    let xpGain = Math.floor((baseHp * enemy.level) * 2.2);
    
    // Bonus Boss (x5) pour motiver à finir la zone
    if (enemy.isBoss) xpGain *= 5;

    if (xpGain < 1) xpGain = 1;
    if (state.upgrades.expShare) xpGain = Math.floor(xpGain * 1.5);
    if (state.upgrades.luckyEgg) xpGain = Math.floor(xpGain * 1.5);
    if (state.inv.omniXp > 0) xpGain = Math.floor(xpGain * 2);
    if(hasBadge("Âme")) xpGain = Math.floor(xpGain * 1.5);
    
    state.team.forEach(p => {
        if(p.level < 100) {
            p.xp += xpGain;
            if(p.xp >= p.maxXp) {
                p.level++;
                p.xp -= p.maxXp;
                p.maxXp = calcMaxXp(p.id, p.level);
                playTone('up');
                if(p.level >= 100) { p.level = 100; p.xp = 0; p.maxXp = 0; }
            }
        }
    });

    playTone('coin');

    if(enemy.isBoss) {
        checkBadges();
        if(state.zoneIdx === state.unlockedZone && state.zoneIdx < ZONES.length-1) {
            state.unlockedZone++;
            showFeedback("ZONE DÉBLOQUÉE !", "yellow");
            renderShop(); 
            renderPC();
            // Allow user to stay on boss stage if they want, but usually reset
            state.subStage = 1; 
        } else {
             state.subStage = 1;
        }

        // VICTOIRE LIGUE (Zone 21 = Index 20)
        if(state.zoneIdx === 20) {
            showVictory();
        }
    } else {
        if(state.subStage < 10) state.subStage++;
    }
    
    updateUI(); 
    updateZone();
    
    resumeAutoBattle();
    // Gestion du délai de réapparition (sans animation 3D)
    document.getElementById('enemy-sprite').classList.add('hidden');
    document.getElementById('searching-msg').classList.remove('hidden');

    let totalDelay = 2000; // Base (Pied)
    if(state.upgrades.bicycle) totalDelay = 500;
    else if(state.upgrades.runningShoes) totalDelay = 1000;

    // Bonus
    if(hasBadge("Terre")) totalDelay = Math.floor(totalDelay / 1.2);
    if(hasMilestone(50)) totalDelay = Math.floor(totalDelay * 0.9);

    setTimeout(spawnEnemy, totalDelay);
}

function attemptCatch(type) {
    if(enemy.dead || enemy.catchRate === 0) { showFeedback("IMPOSSIBLE !", "red"); return; }
    if(enemy.isCatching) return;

    if(type === 'poke' && state.inv.balls <= 0) { showFeedback("PLUS DE BALLS !", "red"); return; }
    if(type === 'super' && state.inv.superballs <= 0) { showFeedback("PLUS DE SUPERBALLS !", "red"); return; }
    if(type === 'hyper' && state.inv.hyperballs <= 0) { showFeedback("PLUS D'HYPERBALLS !", "red"); return; }
    if(type === 'master' && state.inv.masterball <= 0) { showFeedback("PLUS DE MASTERBALLS !", "red"); return; }

    const captureUid = enemy.uid; // Capture current enemy ID
    enemy.isCatching = true;

    if(type === 'poke') state.inv.balls--; 
    else if(type === 'super') state.inv.superballs--;
    else if(type === 'hyper') state.inv.hyperballs--;
    else if(type === 'master') state.inv.masterball--;
    updateUI(); renderBag();

    let ballMult = type === 'super' ? 2 : 1;
    if(type === 'hyper') ballMult = 4;
    if(type === 'master') ballMult = 255;

    // 1. Base (Taux officiel 0-255)
    let baseChance = enemy.catchRate / 255;

    // 2. Bonus de Santé (Formule Gen 3)
    let hpFactor = ((3 * enemy.maxHp) - (2 * enemy.hp)) / (3 * enemy.maxHp);

    // 3. Pénalité de Niveau
    let levelPenalty = 1 + (enemy.level / 25);

    // 4. Calcul Final
    let chance = (baseChance * hpFactor * ballMult) / levelPenalty;

    if(hasBadge("Marais")) chance *= 1.3;

    // 5. Vérification Masterball
    if (ballMult >= 255) chance = 1;

    console.log(`Détail Capture -> Base: ${baseChance.toFixed(3)}, HP Factor: ${hpFactor.toFixed(3)}, Level Penalty: ${levelPenalty.toFixed(3)}, Final: ${(chance*100).toFixed(2)}%`);

    const img = document.getElementById('enemy-sprite');
    img.classList.remove('pokemon-float'); 
    img.classList.add('catching');

    setTimeout(() => {
        enemy.isCatching = false;
        if(enemy.uid !== captureUid) return; // Timer killed enemy during animation
        if(Math.random() < chance) {
            stopBossTimer();
            resumeAutoBattle();
            enemy.dead = true;
            playTone('catch');
            let cleanName = enemy.name.replace(/\s*\(.*\)/,""); // Remove (Géant) etc
            addToPokedex(enemy.id);
            
            if(state.team.length < 6) { 
                addToTeam(enemy.id, cleanName, enemy.level, enemy.isShiny); 
                showFeedback("CAPTURÉ !", "yellow"); 
            } else { 
                addToPC(enemy.id, cleanName, enemy.level, enemy.isShiny); 
                showFeedback("ENVOYÉ AU PC", "blue"); 
            }
            
            let gold = calculateGoldReward(enemy);
            if(hasBadge("Prisme")) gold = Math.floor(gold * 1.2);
            if(enemy.isShiny) gold *= 5;
            state.money += gold * 2;

            if(enemy.isShiny) {
                state.inv.candy += 5;
                showFeedback("SHINY! +5 BONBONS", "purple");
            }
            
            if(enemy.isBoss) {
                checkBadges();
                if(state.zoneIdx===state.unlockedZone && state.zoneIdx<ZONES.length-1) { 
                    state.unlockedZone++; renderShop(); renderPC(); 
                }
                state.subStage = 1;
            } else { 
                if(state.subStage < 10) state.subStage++; 
            }
            
            updateUI(); updateZone();
            img.style.opacity = '0';
            setTimeout(() => { 
                spawnEnemy(); 
                img.style.opacity='1'; 
                img.classList.remove('catching'); 
                img.classList.add('pokemon-float'); 
            }, 1000);
        } else {
            img.classList.remove('catching'); 
            img.classList.add('pokemon-float');
            showFeedback("ÉCHAPPÉ !", "red");
            // Penalty? Maybe enemy heals a bit?
        }
    }, 1000);
}

function getCatchChance(ballType) {
    if (enemy.dead || enemy.catchRate === 0) return 0;
    let ballMult = ballType === 'super' ? 2 : ballType === 'hyper' ? 4 : 1;
    if(ballType === 'master') ballMult = 255;

    let baseChance = enemy.catchRate / 255;
    let hpFactor = ((3 * enemy.maxHp) - (2 * enemy.hp)) / (3 * enemy.maxHp);
    let levelPenalty = 1 + (enemy.level / 25);
    let chance = (baseChance * hpFactor * ballMult) / levelPenalty;

    if(hasBadge("Marais")) chance *= 1.3;
    if (ballMult >= 255) chance = 1;
    return Math.min(chance, 1) * 100;
}

function showCatchTooltip() {
    if(!state.cheat) return;
    const t = document.getElementById('catch-tooltip');
    t.innerHTML = `
        <div class="text-[10px] font-bold text-gray-400 border-b border-gray-600 mb-1 pb-1">TAUX DE CAPTURE</div>
        <div class="flex justify-between gap-3"><span class="text-red-400 font-bold">Poké</span> <span class="font-mono">${getCatchChance('poke').toFixed(1)}%</span></div>
        <div class="flex justify-between gap-3"><span class="text-blue-400 font-bold">Super</span> <span class="font-mono">${getCatchChance('super').toFixed(1)}%</span></div>
        <div class="flex justify-between gap-3"><span class="text-yellow-400 font-bold">Hyper</span> <span class="font-mono">${getCatchChance('hyper').toFixed(1)}%</span></div>
    `;
    t.classList.remove('hidden');
}

function hideCatchTooltip() {
    document.getElementById('catch-tooltip').classList.add('hidden');
}

// --- HELPERS ---
function getSprite(id, isShiny) {
    if(isShiny) return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
    return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}
function getArtwork(id, isShiny) {
    if (isShiny) {
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/shiny/${id}.png`;
    }
    return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
}

function addToTeam(id,n,l,s) { 
    const maxXp = calcMaxXp(id, l);
    state.team.push({id:id, name:n, level:l, isShiny:s, xp:0, maxXp:maxXp, uid:Date.now() + Math.random(), img:getSprite(id, s)}); 
    renderTeam(); 
}
function addToPC(id,n,l,s) { 
    const maxXp = calcMaxXp(id, l);
    state.pc.push({id:id, name:n, level:l, isShiny:s, xp:0, maxXp:maxXp, uid:Date.now() + Math.random(), img:getSprite(id, s)}); 
    renderPC(); 
}

function addToPokedex(id) {
    if(!state.pokedex.includes(id)) {
        state.pokedex.push(id);
        checkMilestones();
    }
}

function useShinyToken(uid) {
    let p = state.team.find(x=>x.uid===uid);
    if(p && !p.isShiny && state.inv.shinyToken > 0) {
        state.inv.shinyToken--; p.isShiny = true; p.img = getSprite(p.id, true);
        playTone('up'); showFeedback("SHINY !!!", "purple");
        renderTeam(); renderBag();
    }
}

function useRepel() {
    if(state.inv.repel > 0) {
        state.inv.repel--;
        const now = Date.now();
        state.repelEndTime = (state.repelEndTime > now ? state.repelEndTime : now) + 30000;
        showFeedback("REPOUSSE ACTIF !", "gray");
        renderBag();
        updateActiveEffects();
    }
}

function useXAttack() {
    if(state.inv.xAttack > 0) {
        state.inv.xAttack--;
        const now = Date.now();
        state.attackBoostEndTime = (state.attackBoostEndTime > now ? state.attackBoostEndTime : now) + 30000;
        showFeedback("ATTAQUE + ACTIF !", "red");
        renderBag();
        updateActiveEffects();
    }
}

function useXSpecial() {
    if(state.inv.xSpecial > 0) {
        state.inv.xSpecial--;
        const now = Date.now();
        state.dpsBoostEndTime = (state.dpsBoostEndTime > now ? state.dpsBoostEndTime : now) + 30000;
        showFeedback("DPS x2 ACTIF !", "blue");
        renderBag();
        updateActiveEffects();
    }
}

function useSuperRepel() {
    if(state.inv.superRepel > 0) {
        state.inv.superRepel--;
        const now = Date.now();
        state.superRepelEndTime = (state.superRepelEndTime > now ? state.superRepelEndTime : now) + 30000;
        showFeedback("SUPER REPOUSSE !", "gray");
        renderBag();
        updateActiveEffects();
    }
}

function usePokeDoll() {
    if(state.inv.pokeDoll > 0) {
        if(state.unlockedZone > state.zoneIdx) {
            state.inv.pokeDoll--;
            state.subStage = 10;
            spawnEnemy();
            showFeedback("BOSS INVOQUÉ !", "purple");
            renderBag();
        } else {
            showFeedback("BOSS NON VAINCU !", "red");
        }
    }
}

function initCandyUse() {
    if(state.inv.candy <= 0) return;
    state.candyMode = true;
    state.candyTargetIdx = null;
    showFeedback("SÉLECTIONNEZ UN POKÉMON", "blue");
    renderTeam();
}

function handleTeamClick(i) {
    if(state.swapIdx !== null) {
        confirmSwap(i);
    } else if (state.candyMode) {
        if(state.team[i].level >= 100) {
            showFeedback("NIVEAU MAX !", "red");
            return;
        }
        state.candyTargetIdx = i;
        state.candyAmount = 1;
        renderTeam();
    }
}

function adjustCandyAmount(delta) {
    if (state.candyTargetIdx === null) return;
    const p = state.team[state.candyTargetIdx];
    const maxUse = Math.min(state.inv.candy, 100 - p.level);
    
    let newAmt = state.candyAmount + delta;
    if (newAmt < 1) newAmt = 1;
    if (newAmt > maxUse) newAmt = maxUse;
    
    state.candyAmount = newAmt;
    renderTeam();
}

function confirmCandyUse() {
    if (state.candyTargetIdx === null) return;
    const i = state.candyTargetIdx;
    const p = state.team[i];
    const count = state.candyAmount;
    
    if(count > 0 && state.inv.candy >= count) {
        state.inv.candy -= count;
        p.level += count;
        p.maxXp = calcMaxXp(p.id, p.level);
        playTone('up'); 
        showFeedback(`+${count} NIVEAUX !`, "green");
        
        state.candyMode = false;
        state.candyTargetIdx = null;
        updateUI(); renderBag(); renderTeam(); 
    }
}

function cancelCandyUse() {
    state.candyMode = false;
    state.candyTargetIdx = null;
    renderTeam();
}

function startTeamRename(index, event) {
    event.stopPropagation();
    state.editingPcIdx = null; // Close any open PC rename
    state.editingTeamIdx = index;
    renderTeam();
    setTimeout(() => {
        const input = document.getElementById(`rename-input-team-${index}`);
        if (input) {
            input.focus();
            input.select();
        }
    }, 0);
}

function confirmTeamRename(index) {
    const input = document.getElementById(`rename-input-team-${index}`);
    if (input) {
        const newName = input.value.trim();
        if (newName && newName.length > 0 && newName.length <= 12) {
            state.team[index].name = newName;
        }
    }
    state.editingTeamIdx = null;
    renderTeam();
}

function cancelTeamRename() {
    state.editingTeamIdx = null;
    renderTeam();
}

function startPcRename(index, event) {
    event.stopPropagation();
    state.editingTeamIdx = null; // Close any open team rename
    state.editingPcIdx = index;
    renderPC();
    setTimeout(() => {
        const input = document.getElementById(`rename-input-pc-${index}`);
        if (input) {
            input.focus();
            input.select();
        }
    }, 0);
}

function confirmPcRename(index) {
    const input = document.getElementById(`rename-input-pc-${index}`);
    if (input) {
        const newName = input.value.trim();
        if (newName && newName.length > 0 && newName.length <= 12) {
            state.pc[index].name = newName;
        }
    }
    state.editingPcIdx = null;
    renderPC();
}

function cancelPcRename() {
    state.editingPcIdx = null;
    renderPC();
}

function evolve(uid) {
    let p = state.team.find(x=>x.uid===uid);
    let ed = EVOLUTIONS[p.id];
    if(p && ed && p.level>=ed.lvl) { 
        const oldId = p.id;
        let newId, newName;
        if(Array.isArray(ed.id)) {
            // Eevee Easter Egg (Renaming)
            if (p.id === 133) {
                const n = p.name.trim().toLowerCase();
                if (n === "jolteon") { newId = 135; newName = "Voltali"; }
                else if (n === "vaporeon") { newId = 134; newName = "Aquali"; }
                else if (n === "flareon") { newId = 136; newName = "Pyroli"; }
                else {
                    const r = Math.floor(Math.random() * ed.id.length);
                    newId = ed.id[r]; newName = ed.name[r];
                }
            } else {
                const r = Math.floor(Math.random() * ed.id.length);
                newId = ed.id[r]; newName = ed.name[r];
            }
        } else {
            newId = ed.id;
            newName = ed.name;
        }
        p.id = newId;
        p.name = newName;
        p.img=getSprite(p.id, p.isShiny); 
        addToPokedex(p.id);
        
        evolvingPokemon = { uid: uid, endTime: Date.now() + 3000, oldId: oldId, newId: newId };
        
        if(evolutionInterval) clearInterval(evolutionInterval);
        evolutionInterval = setInterval(() => {
            if(Date.now() > evolvingPokemon.endTime) {
                clearInterval(evolutionInterval);
                evolutionInterval = null;
                renderTeam();
            } else {
                renderTeam();
            }
        }, 50);

        renderTeam(); 
        playTone('up'); 
        showFeedback("ÉVOLUTION !", "purple");
    }
}

function showItemInfo(id, e) {
    e.stopPropagation();
    const item = ITEMS[id];
    if(!item) return;
    
    document.getElementById('info-title').innerText = item.name.toUpperCase();
    document.getElementById('info-desc').innerText = item.desc;
    
    let iconHtml = item.img ? `<img src="${item.img}" class="w-12 h-12 object-contain">` : 
                   item.icon ? `<span class="material-symbols-outlined text-4xl ${item.iconColor || 'text-white'}">${item.icon}</span>` : '';
    document.getElementById('info-icon-container').innerHTML = iconHtml;
    
    document.getElementById('item-info-modal').classList.remove('hidden');
}

function showVictory() {
    document.getElementById('victory-modal').classList.remove('hidden');
    startVictoryAnimation();
    playTone('pc'); // Son de victoire (réutilisation du son PC pour l'instant)
}

function closeVictory() {
    document.getElementById('victory-modal').classList.add('hidden');
    stopVictoryAnimation();
}

function startVictoryAnimation() {
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    
    // Confetti
    victoryInterval = setInterval(() => {
        const c = document.createElement('div');
        c.className = 'absolute w-2 h-2 rounded-sm';
        c.style.left = Math.random() * 100 + 'vw';
        c.style.top = '-10px';
        c.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        c.style.transition = `top ${Math.random()*2+2}s linear, transform ${Math.random()*2+2}s linear`;
        container.appendChild(c);
        
        requestAnimationFrame(() => {
            c.style.top = '110vh';
            c.style.transform = `rotate(${Math.random()*720}deg)`;
        });
        
        setTimeout(() => c.remove(), 4000);
    }, 50);

    // Fireworks (Cercles qui s'agrandissent)
    fireworkInterval = setInterval(() => {
        const f = document.createElement('div');
        f.className = 'absolute rounded-full border-2 opacity-0';
        f.style.width = '10px';
        f.style.height = '10px';
        f.style.left = Math.random() * 80 + 10 + 'vw';
        f.style.top = Math.random() * 60 + 10 + 'vh';
        const color = `hsl(${Math.random()*360}, 100%, 50%)`;
        f.style.borderColor = color;
        f.style.boxShadow = `0 0 20px ${color}, inset 0 0 20px ${color}`;
        f.style.transition = 'all 1s ease-out';
        container.appendChild(f);
        
        requestAnimationFrame(() => {
            f.style.transform = `scale(${Math.random()*15+10})`;
            f.style.opacity = '0';
            f.style.borderWidth = '0px';
        });
        
        setTimeout(() => f.remove(), 1000);
    }, 400);
}

function stopVictoryAnimation() {
    if(victoryInterval) clearInterval(victoryInterval);
    if(fireworkInterval) clearInterval(fireworkInterval);
    document.getElementById('confetti-container').innerHTML = '';
}

function getPrice(base) {
    if(state.cheat) return 1;
    if(hasMilestone(70)) return Math.floor(base * 0.85);
    return base;
}

function getItemPrice(id) {
    const item = ITEMS[id];
    if(!item) return 0;
    let base = item.price;
    if(item.type === 'consumable') {
        base = Math.floor(base * (1 + state.badges.length * 0.25));
    }
    return base;
}

function buyItem(id) {
    const item = ITEMS[id];
    if(!item) return;
    
    let p = getPrice(getItemPrice(id));
    
    if(state.money >= p) {
        if(item.type === 'upgrade' && state.upgrades[id]) return; // Already owned
        
        state.money -= p;
        
        if(item.type === 'consumable') {
            state.inv[item.invKey]++;
        } else {
            state.upgrades[id] = true;
        }
        
        updateUI(); renderBag(); renderShop();
    }
}

// --- SAVE SYSTEM ---
function exportSave() {
    const json = JSON.stringify(state);
    const blob = new Blob([json], {type: "application/json;charset=utf-8"});
    saveAs(blob, "pokiclicker_save.json");
    showFeedback("SAUVEGARDÉ", "green");
}

function loadSaveFile() {
    document.getElementById('file-input').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            loadData(data);
            document.getElementById('starter-modal').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('opacity-0');
        } catch(err) {
            alert("Sauvegarde invalide !");
        }
    };
    reader.readAsText(file);
}

function loadGame() {
    const saved = localStorage.getItem('pokiClickerSave');
    if(saved) loadData(JSON.parse(saved));
}

function loadData(data) {
    state = {...state, ...data};
    // Init new fields if missing
    state.candyMode = false;
    state.candyTargetIdx = null;
    state.candyAmount = 1;
    state.editingTeamIdx = null;
    state.editingPcIdx = null;
    if(state.starterId === undefined) state.starterId = null;
    if(!state.pokedex) state.pokedex = [];
    if(!state.milestones) state.milestones = [];
    if(!state.badges) state.badges = [];
    if(state.inv.omniXp === undefined) state.inv.omniXp = 0;
    if(state.inv.shinyToken === undefined) state.inv.shinyToken = 0;
    if(state.inv.masterball === undefined) state.inv.masterball = 0;
    if(state.inv.repel === undefined) state.inv.repel = 0;
    if(state.inv.hyperballs === undefined) state.inv.hyperballs = 0;
    if(state.inv.xAttack === undefined) state.inv.xAttack = 0;
    if(state.inv.xSpecial === undefined) state.inv.xSpecial = 0;
    if(state.inv.superRepel === undefined) state.inv.superRepel = 0;
    if(state.inv.pokeDoll === undefined) state.inv.pokeDoll = 0;
    if(!state.attackBoostEndTime) state.attackBoostEndTime = 0;
    if(!state.dpsBoostEndTime) state.dpsBoostEndTime = 0;
    if(!state.superRepelEndTime) state.superRepelEndTime = 0;
    if(!state.upgrades) state.upgrades = { runningShoes: false, amuletCoin: false, protein: false, expShare: false, pokeradar: false };
    if(!state.repelEndTime) state.repelEndTime = 0;
    if(state.stopOnRare === undefined) state.stopOnRare = true;
    if(state.autoStopSettings === undefined) {
        state.autoStopSettings = { 'Commun': false, 'Peu Commun': false, 'Rare': true, 'Très Rare': true, 'Légendaire': true, 'Shiny': true };
    }
    state.interruptedState = null; // Always reset on load
    if(state.stats.totalMoney === undefined) state.stats.totalMoney = state.money;
    
    // Re-bind images and init XP if missing (for old saves)
    const initP = (p) => {
        p.img = getSprite(p.id, p.isShiny);
        if(p.xp === undefined) p.xp = 0;
        if(p.maxXp === undefined) p.maxXp = calcMaxXp(p.id, p.level);
    };
    
    state.team.forEach(initP);
    state.pc.forEach(initP);
    
    initAudio();
    updateUI(); renderTeam(); renderBag(); renderShop(); renderPC(); updateZone(); updateBg(); updateRadarButton();
    spawnEnemy(); startAutoClicker();
    startAutoSave();
}

function checkMilestones() {
    const count = state.pokedex.length;
    MILESTONES.forEach(m => {
        if(count >= m.count && !state.milestones.includes(m.count)) {
            state.milestones.push(m.count);
            showFeedback(`PALIER ${m.count}: ${m.title}`, "yellow");
            
            // One-time rewards
            if(m.count === 20) state.money += 2500;
            if(m.count === 40) state.inv.omniXp++;
            if(m.count === 110) state.inv.shinyToken++;
            if(m.count === 130) { state.inv.masterball++; state.inv.candy+=10; }
            
            updateUI(); renderBag();
        }
    });
}

function checkBadges() {
    BADGES.forEach(b => {
        if(state.zoneIdx === b.zoneIdx && !state.badges.includes(b.name)) {
            state.badges.push(b.name);
            showFeedback(`BADGE ${b.name.toUpperCase()} OBTENU !`, "yellow");
            playTone('up');
        }
    });
}

function togglePokedex() {
    const m = document.getElementById('pokedex-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderPokedex();
    } else {
        m.classList.add('hidden');
    }
}

function toggleBadges() {
    const m = document.getElementById('badges-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderBadges();
    } else {
        m.classList.add('hidden');
    }
}

function toggleMilestones() {
    const m = document.getElementById('milestones-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderMilestones();
    } else {
        m.classList.add('hidden');
    }
}

function toggleAutoStopSettingsModal() {
    const m = document.getElementById('auto-stop-settings-modal');
    if (m.classList.contains('hidden')) {
        renderAutoStopSettings();
        m.classList.remove('hidden');
    } else {
        m.classList.add('hidden');
    }
}

function toggleMap() {
    const m = document.getElementById('map-modal');
    if(m.classList.contains('hidden')) {
        m.classList.remove('hidden');
        renderMap();
    } else {
        m.classList.add('hidden');
    }
}

function updateRadarButton() {
    const btn = document.getElementById('radar-btn');
    const lockIcon = document.getElementById('radar-icon-lock');
    const activeIcon = document.getElementById('radar-icon-active');
    if(!btn) return;

    if (state.upgrades.pokeradar) {
        btn.disabled = false;
        btn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
        lockIcon.classList.add('hidden');
        activeIcon.classList.remove('hidden');
    } else {
        btn.disabled = true;
        btn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
        lockIcon.classList.remove('hidden');
        activeIcon.classList.add('hidden');
    }
}

function toggleRadarModal() {
    if (!state.upgrades.pokeradar) return;
    const modal = document.getElementById('radar-modal');
    if (modal.classList.contains('hidden')) {
        renderRadar();
        modal.classList.remove('hidden');
    } else {
        modal.classList.add('hidden');
    }
}

function renderRadar() {
    const zone = ZONES[state.zoneIdx];
    const grid = document.getElementById('radar-grid');
    document.getElementById('radar-zone-name').innerText = zone.name;
    grid.innerHTML = '';

    const rarityColors = { "Commun": "bg-slate-500 text-white", "Peu Commun": "bg-green-600 text-white", "Rare": "bg-blue-600 text-white", "Très Rare": "bg-purple-600 text-white", "Légendaire": "bg-yellow-500 text-black", "Boss": "bg-red-600 text-white", "Conseil 4": "bg-indigo-600 text-white", "Maître": "bg-black text-yellow-300" };

    zone.pokemons.forEach(p => {
        const caught = state.pokedex.includes(p.id);
        const imgSrc = getSprite(p.id, false);
        const imgClass = caught ? '' : 'grayscale brightness-0';
        const colorClasses = rarityColors[p.rarity] || "bg-gray-500 text-white";
        grid.innerHTML += `<div class="aspect-square bg-slate-900/50 rounded-lg flex flex-col items-center justify-center p-2 relative border border-slate-700"><img src="${imgSrc}" class="w-20 h-20 object-contain ${imgClass}" title="${p.name}"><div class="absolute bottom-1 right-1 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-md ${colorClasses}">${p.rarity}</div></div>`;
    });
}

function flyToZone(zoneId) {
    const overlay = document.getElementById('gen1-fly-overlay');
    const trainer = document.getElementById('fly-trainer');
    const mapModal = document.getElementById('map-modal');
    const mapContainer = document.getElementById('map-container');
    const mapImg = mapContainer.querySelector('img');

    // Prevent multiple clicks during animation
    if (overlay.style.display === 'flex') return;

    // 1. Find current zone coordinates to position the trainer
    const currentArea = MAP_DATA.find(a => a.zoneId === state.zoneIdx);
    if (!currentArea) return;

    let centerX, centerY;
    const coords = currentArea.coords;
    if (currentArea.type === 'circle') {
        centerX = coords[0];
        centerY = coords[1];
    } else if (currentArea.type === 'rect') {
        centerX = (coords[0] + coords[2]) / 2;
        centerY = (coords[1] + coords[3]) / 2;
    } else if (currentArea.type === 'polygon') {
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
        for (let i = 0; i < coords.length; i += 2) {
            minX = Math.min(minX, coords[i]);
            maxX = Math.max(maxX, coords[i]);
            minY = Math.min(minY, coords[i+1]);
            maxY = Math.max(maxY, coords[i+1]);
        }
        centerX = (minX + maxX) / 2;
        centerY = (minY + maxY) / 2;
    }

    // Convert to percentage for absolute positioning
    trainer.style.left = `${(centerX / mapImg.naturalWidth) * 100}%`;
    trainer.style.top = `${(centerY / mapImg.naturalHeight) * 100}%`;
    trainer.classList.remove('hidden');
    
    // Animation SpriteFly (1 à 5)
    let frame = 1;
    trainer.src = `img/sprites/SpriteFly${frame}.png`;
    const animInterval = setInterval(() => {
        frame++;
        if(frame <= 5) trainer.src = `img/sprites/SpriteFly${frame}.png`;
        else clearInterval(animInterval);
    }, 150); // 150ms par frame

    // 2. Wait a bit, then start the fly animation
    setTimeout(() => {
        // Show overlay (Black Band)
        overlay.style.display = 'flex';
        
        setTimeout(() => {
            overlay.classList.add('active');
        }, 50);

        // 3. Set timeout for the duration of the fly animation
        setTimeout(() => {
            // Execute the zone change
            if(state.cheat && zoneId > state.unlockedZone) state.unlockedZone = zoneId;
            state.zoneIdx = zoneId; 
            state.subStage = 1; 
            updateBg(); renderShop(); renderBag(); renderPC(); spawnEnemy(); 
            
            // Close map and hide/reset animation overlay
            overlay.classList.remove('active');
            overlay.classList.add('closing');
            
            setTimeout(() => {
                mapModal.classList.add('hidden');
                overlay.style.display = 'none';
                overlay.classList.remove('closing');
                
                trainer.classList.add('hidden');
            }, 500);
        }, 2500); // 2.5s animation
    }, 800); // Wait for trainer to appear and pose
}

function renderMap() {
    const img = document.querySelector('#map-container img');
    const c = document.getElementById('map-svg');
    
    if (!img.complete || img.naturalWidth === 0) {
        img.onload = () => renderMap();
        return;
    }
    
    c.setAttribute('viewBox', `0 0 ${img.naturalWidth} ${img.naturalHeight}`);
    c.innerHTML = "";
    
    MAP_DATA.forEach(area => {
        const isUnlocked = area.zoneId !== null && (area.zoneId <= state.unlockedZone || state.cheat);
        const isCurrent = area.zoneId === state.zoneIdx;
        
        // Determine Color
        let fillClass = "fill-gray-600/50"; // Default Locked/Placeholder
        if (isUnlocked) {
            if (area.color === "red") fillClass = "fill-red-500/50";
            else if (area.color === "orange") fillClass = "fill-amber-500/50";
            else if (area.color === "cyan") fillClass = "fill-cyan-400/50";
            else fillClass = "fill-blue-500/50";
        }
        if (isCurrent) fillClass = "fill-green-400/70 animate-pulse";

        // Create SVG Element
        let el = document.createElementNS("http://www.w3.org/2000/svg", area.type);
        
        if (area.type === "rect") {
            el.setAttribute("x", area.coords[0]);
            el.setAttribute("y", area.coords[1]);
            el.setAttribute("width", area.coords[2] - area.coords[0]);
            el.setAttribute("height", area.coords[3] - area.coords[1]);
        } else if (area.type === "circle") {
            el.setAttribute("cx", area.coords[0]);
            el.setAttribute("cy", area.coords[1]);
            el.setAttribute("r", area.coords[2]);
        } else if (area.type === "polygon") {
            el.setAttribute("points", area.coords.join(" "));
        }

        el.setAttribute("class", `${fillClass} stroke-white stroke-2 transition-all duration-300 hover:stroke-yellow-400 hover:fill-opacity-80 cursor-pointer`);
        
        // Tooltip Title
        let title = document.createElementNS("http://www.w3.org/2000/svg", "title");
        title.textContent = area.zoneId !== null ? `${area.name} (Zone ${area.zoneId + 1})` : area.name;
        el.appendChild(title);

        if (isUnlocked) {
            el.onclick = () => { 
                flyToZone(area.zoneId);
            };
        }
        c.appendChild(el);
    });
}

function renderMilestones() {
    const l = document.getElementById('milestones-list');
    l.innerHTML = "";
    
    MILESTONES.forEach(m => {
        const unlocked = state.pokedex.length >= m.count;
        const div = document.createElement('div');
        div.className = `p-3 rounded border flex justify-between items-center ${unlocked ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 grayscale opacity-50'}`;
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${unlocked ? 'bg-yellow-500 text-black' : 'bg-slate-800 text-gray-500'}">${m.count}</div>
                <div>
                    <div class="font-bold ${unlocked ? 'text-yellow-400' : 'text-gray-400'}">${m.title}</div>
                    <div class="text-xs text-gray-300">${m.desc}</div>
                </div>
            </div>
            ${unlocked ? '<span class="material-symbols-outlined text-green-400">check_circle</span>' : '<span class="material-symbols-outlined text-gray-600">lock</span>'}
        `;
        l.appendChild(div);
    });
}

function renderBadges() {
    const g = document.getElementById('badges-grid');
    g.innerHTML = "";
    
    BADGES.forEach(b => {
        const unlocked = state.badges.includes(b.name);
        const div = document.createElement('div');
        div.className = `aspect-square rounded-full border-4 flex items-center justify-center relative transition-all group ${unlocked ? 'bg-[#E6E6E6] border-yellow-500 shadow-[0_0_15px_rgba(234,179,8,0.5)]' : 'bg-slate-900 border-slate-700 grayscale opacity-50'}`;
        div.innerHTML = `
            <img src="img/badges/${b.name}.png" class="w-3/4 h-3/4 object-contain ${unlocked?'':'brightness-0 invert opacity-30'}">
        `;
        div.onmouseenter = () => document.getElementById('badge-tooltip').innerHTML = `<span class="text-yellow-400 font-bold">${b.name}</span>: ${b.desc}`;
        div.onmouseleave = () => document.getElementById('badge-tooltip').innerText = "Survolez un badge pour voir son effet";
        g.appendChild(div);
    });
    
    if(state.badges.length === 0) {
        document.getElementById('badge-tooltip').innerText = "Aucun badge obtenu. Battez les champions d'arène !";
    }
}

function resetSave() {
    if(confirm("Effacer la sauvegarde locale et recommencer ?")) {
        localStorage.removeItem('pokiClickerSave');
        location.reload();
    }
}

// --- UI LOGIC ---

function initSwap(idx) {
    if(state.team.length < 6) {
        let p = state.pc.splice(idx,1)[0]; 
        state.team.push(p);
        playTone('pc'); 
        renderTeam(); renderPC();
    } else {
        state.swapIdx = idx;
        document.getElementById('swap-alert').classList.remove('hidden');
        renderTeam();
    }
}

function confirmSwap(tIdx) {
    if(state.swapIdx === null) return;
    let temp = state.team[tIdx];
    state.team[tIdx] = state.pc[state.swapIdx];
    state.pc[state.swapIdx] = temp;
    state.swapIdx = null;
    document.getElementById('swap-alert').classList.add('hidden');
    playTone('pc'); renderTeam(); renderPC();
}

function releasePokemon(idx) { 
    if(confirm("Relâcher ce Pokémon ?")) { 
        state.pc.splice(idx,1); 
        renderPC(); 
    } 
}

function updateUI() {
    document.getElementById('money-display').innerText = state.money.toLocaleString('de-DE');
    const currentDps = getDPS(enemy.dead ? null : enemy.id).toFixed(1);
    document.getElementById('total-dps').innerText = currentDps;
    if(document.getElementById('total-dps-m')) document.getElementById('total-dps-m').innerText = currentDps;
    document.getElementById('team-count').innerText = state.team.length;
    
    // Shop Stocks
    if(document.getElementById('shop-stock-pokeball')) document.getElementById('shop-stock-pokeball').innerText = state.inv.balls;
    if(document.getElementById('shop-stock-superball')) document.getElementById('shop-stock-superball').innerText = state.inv.superballs;
    if(document.getElementById('shop-stock-candy')) document.getElementById('shop-stock-candy').innerText = state.inv.candy;
    if(document.getElementById('shop-stock-hyperball')) document.getElementById('shop-stock-hyperball').innerText = state.inv.hyperballs;
    if(document.getElementById('shop-stock-masterball')) document.getElementById('shop-stock-masterball').innerText = state.inv.masterball;
    if(document.getElementById('shop-stock-repel')) document.getElementById('shop-stock-repel').innerText = state.inv.repel;
    updateAutoBtn();
    updateRadarButton();
    updateAutoStopBtn();
}

function updateZone() {
    const z = ZONES[state.zoneIdx];
    document.getElementById('zone-name').innerText = z.name;
    document.getElementById('zone-id').innerText = state.zoneIdx+1;
    document.getElementById('stage-text').innerText = state.subStage+"/10";
    document.getElementById('zone-progress').style.width = (state.subStage*10)+"%";
    
    // Arrows
    const canNext = (state.zoneIdx < state.unlockedZone || state.cheat) && state.zoneIdx < ZONES.length-1;
    
    const prevD = document.getElementById('prev-zone-btn-d');
    if(prevD) prevD.disabled = state.zoneIdx===0;
    const nextD = document.getElementById('next-zone-btn-d');
    if(nextD) {
        nextD.disabled = !canNext;
        nextD.className = canNext ? "w-6 h-6 lg:w-8 lg:h-8 rounded-full bg-blue-600 hover:bg-blue-500 border border-blue-400 text-white flex items-center justify-center transition transform hover:scale-105 animate-pulse shadow-lg shrink-0" : "w-6 h-6 lg:w-8 lg:h-8 rounded-full bg-slate-800 border border-slate-600 text-white flex items-center justify-center hover:bg-slate-700 transition disabled:opacity-50 shadow-lg shrink-0";
    }
}

function updateBg() {
    const bg = ZONES[state.zoneIdx].bg;
    const layer = document.getElementById('bg-layer');
    if(bg.includes("http") || bg.includes("img/")) {
        layer.style.backgroundImage = `url('${bg}')`;
        layer.style.background = ""; 
        layer.style.backgroundImage = `url('${encodeURI(bg)}')`;
    } else {
        layer.style.backgroundImage = "";
        layer.style.background = bg; // Use gradient
    }
}

function updateEnemyUI() {
    const img = document.getElementById('enemy-sprite');
    img.src = getArtwork(enemy.id, enemy.isShiny);
    if(enemy.isBoss) img.classList.add('scale-125'); else img.classList.remove('scale-125');
    
    if(enemy.isShiny) {
        img.classList.remove('shiny-filter'); // On enlève le filtre de couleur
        img.classList.add('shiny-glow');      // On met juste l'aura dorée
    } else {
        img.classList.remove('shiny-filter');
        img.classList.remove('shiny-glow');
    }
    
    document.getElementById('enemy-name').innerText = enemy.name;
    document.getElementById('enemy-level').innerText = "Lv. " + enemy.level;
    document.getElementById('boss-badge').style.display = enemy.isBoss ? 'block' : 'none';
    
    // Show Types
    const types = getTypes(enemy.id);
    let typeHtml = types.map(t => `<span style="background:${TYPE_COLORS[t]}" class="text-[9px] px-1.5 py-0.5 rounded text-white shadow-sm ml-1 uppercase">${t}</span>`).join("");
    if(enemy.isShiny) typeHtml += `<span class="text-[9px] px-1.5 py-0.5 rounded bg-yellow-400 text-black font-bold shadow-sm ml-1">★</span>`;
    if(state.pokedex.includes(enemy.id)) typeHtml += `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-3 h-3 inline-block ml-1" title="Déjà capturé">`;
    document.getElementById('enemy-name').innerHTML = enemy.name + typeHtml;
    
    const hasLeftovers = state.upgrades.leftovers;
    ['auto-click-btn', 'auto-click-btn-m'].forEach(id => {
        document.getElementById(id)?.classList.toggle('hidden', !hasLeftovers);
    });
    updateAutoClickerBtn();
    
    updateHp();
    updateZone();
}

function updateHp() {
    const pct = Math.max(0, (enemy.hp/enemy.maxHp)*100);
    const bar = document.getElementById('hp-bar');
    bar.style.width = pct + "%";
    bar.className = `h-full transition-all duration-100 ${pct<25?'bg-red-500':pct<50?'bg-yellow-500':'bg-green-500'}`;
    document.getElementById('hp-text').innerText = Math.ceil(Math.max(0, enemy.hp)) + "/" + enemy.maxHp;
    if(state.cheat && !document.getElementById('catch-tooltip').classList.contains('hidden')) showCatchTooltip();
}

function updateActiveEffects() {
    const container = document.getElementById('active-effects');
    if(!container) return;
    container.innerHTML = "";
    
    const now = Date.now();
    
    const addBadge = (endTime, label, colorClass) => {
        if(endTime > now) {
            const remaining = Math.ceil((endTime - now) / 1000);
            const div = document.createElement('div');
            div.className = `text-[8px] px-2 py-0.5 rounded-full font-bold text-white shadow-sm border ${colorClass} bg-opacity-80 backdrop-blur-sm`;
            div.innerText = `${label}: ${remaining}s`;
            container.appendChild(div);
        }
    };

    addBadge(state.attackBoostEndTime, "ATK +", "bg-red-900 border-red-500");
    addBadge(state.dpsBoostEndTime, "SPÉ +", "bg-blue-900 border-blue-500");
    addBadge(state.repelEndTime, "REPOUSSE", "bg-gray-700 border-gray-500");
    addBadge(state.superRepelEndTime, "SUPER REP.", "bg-slate-600 border-slate-400");
}

function renderTeam() {
    const desktopList = document.getElementById('team-list');
    const mobileList = document.getElementById('mobile-team-list');
    if (!desktopList && !mobileList) return;

    if (desktopList) desktopList.innerHTML = "";
    if (mobileList) mobileList.innerHTML = "";

    let html = "";
    state.team.forEach((p,i) => {
        const evo = EVOLUTIONS[p.id] && p.level >= EVOLUTIONS[p.id].lvl;
        const swapMode = state.swapIdx!==null;
        const candyMode = state.candyMode;
        const isCandyTarget = candyMode && state.candyTargetIdx === i;
        const isInteractive = swapMode || candyMode;
        const mult = !enemy.dead ? getMultiplier(p.id, enemy.id) : 1;
        const multColor = mult > 1 ? "text-green-400" : mult < 1 ? "text-red-400" : "text-gray-400";
        const typeIcon = `<div class="w-2 h-2 rounded-full inline-block mr-1" style="background:${TYPE_COLORS[getTypes(p.id)[0]]}"></div>`;
        const shinyClass = p.isShiny ? "shiny-glow" : "";
        const shinyIcon = p.isShiny ? "<span class='text-yellow-400 ml-1'>★</span>" : "";
        const shinyDpsMult = p.isShiny ? 2 : 1;
        let baseStat = BASE_STATS[p.id] || 40;
        let rawDmg = (baseStat * p.level) / 5;
        const xpPct = p.level >= 100 ? 100 : Math.min(100, (p.xp / p.maxXp) * 100);
        
        const isEvolving = p.uid === evolvingPokemon.uid && Date.now() < evolvingPokemon.endTime;
        const animClass = isEvolving ? "evolving" : "";
        
        let displayImg = p.img;
        if(isEvolving) {
            const timeLeft = evolvingPokemon.endTime - Date.now();
            // Swap every 150ms (sync with CSS 5% steps of 3000ms)
            if (Math.floor(timeLeft / 150) % 2 === 0) {
                displayImg = getSprite(evolvingPokemon.oldId, p.isShiny);
            }
        }

        // Easter Eggs Visuals
        let specialClass = "";
        if (p.name === "Dinnerbone" || p.name === "Grumm") specialClass = "upside-down";
        if (p.name === "jeb_") specialClass = "rainbow-anim";

        const isEditing = state.editingTeamIdx === i;
        let nameDisplay;
        if (isEditing) {
            nameDisplay = `
            <div class="flex items-center gap-1 relative z-50" onclick="event.stopPropagation()">
                <input type="text" id="rename-input-team-${i}" value="${p.name}" maxlength="12" class="w-20 text-[10px] text-black px-1 py-0.5 rounded border border-blue-400 focus:outline-none select-text" onkeydown="if(event.key==='Enter') confirmTeamRename(${i})">
                <button onclick="confirmTeamRename(${i})" class="text-green-400 hover:text-green-300 material-symbols-outlined text-[14px] bg-slate-800 rounded-full">check</button>
                <button onclick="cancelTeamRename()" class="text-red-400 hover:text-red-300 material-symbols-outlined text-[14px] bg-slate-800 rounded-full">close</button>
            </div>`;
        } else {
            nameDisplay = `
            <div class="flex items-center gap-1 min-w-0 relative z-10">
                <div class="text-xs font-bold text-gray-200 truncate">${typeIcon}${p.name}${shinyIcon}</div>
                ${!isInteractive ? `<button onclick="startTeamRename(${i}, event)" class="material-symbols-outlined text-[12px] text-gray-500 hover:text-white cursor-pointer opacity-50 hover:opacity-100 transition-opacity ml-1 bg-transparent border-none p-0" title="Renommer">edit</button>` : ''}
            </div>`;
        }

        html += `
        <div onclick="${isInteractive ? `handleTeamClick(${i})` : ''}" class="flex items-center p-2 rounded border ${isInteractive?'border-blue-400 bg-blue-900/30 cursor-pointer animate-pulse':'border-slate-600 bg-slate-700/40'} hover:bg-slate-700 transition group">
            <img src="${displayImg}" class="w-10 h-10 mr-3 ${shinyClass} ${animClass} ${specialClass}">
            <div class="flex-1 min-w-0">
                ${nameDisplay}
                <div class="text-[10px] text-yellow-500">DPS: ${(rawDmg*mult*shinyDpsMult).toFixed(1)} <span class="${multColor} text-[8px]">x${mult}</span></div>
            </div>
            ${!swapMode ? `
            ${isCandyTarget ? `
            <div class="flex items-center gap-1 bg-slate-800 rounded p-1 border border-blue-500" onclick="event.stopPropagation()">
                <button onclick="adjustCandyAmount(-1)" class="w-5 h-5 bg-slate-600 hover:bg-slate-500 rounded flex items-center justify-center"><span class="material-symbols-outlined text-[14px]">remove</span></button>
                <span class="text-xs font-bold w-6 text-center text-white">${state.candyAmount}</span>
                <button onclick="adjustCandyAmount(1)" class="w-5 h-5 bg-slate-600 hover:bg-slate-500 rounded flex items-center justify-center"><span class="material-symbols-outlined text-[14px]">add</span></button>
                <button onclick="confirmCandyUse()" class="ml-1 text-green-400 hover:text-green-300 material-symbols-outlined text-[16px]" title="Confirmer">check</button>
                <button onclick="cancelCandyUse()" class="text-red-400 hover:text-red-300 material-symbols-outlined text-[16px]" title="Annuler">close</button>
            </div>
            ` : `
            <div class="flex items-center gap-1">
                <div class="w-12 h-1.5 bg-slate-800 rounded-full overflow-hidden relative border border-slate-600 mr-1" title="XP: ${Math.floor(p.xp)}/${p.maxXp}">
                    <div class="h-full bg-blue-500 transition-all duration-300" style="width:${xpPct}%"></div>
                </div>
                <span class="text-[10px] text-blue-300 mr-1">Lv.${p.level}</span>
                ${evo ? `<button onclick="evolve(${p.uid}); event.stopPropagation();" class="bg-purple-600 text-white text-[9px] px-2 py-1 rounded animate-pulse">EVO</button>` : ''}
                ${!p.isShiny && state.inv.shinyToken>0 ? `<button onclick="useShinyToken(${p.uid}); event.stopPropagation();" class="bg-yellow-400 text-black text-[9px] px-1.5 py-1 rounded font-bold" title="Utiliser Jeton Shiny">★</button>` : ''}
            </div>`}
            ` : `<div class="text-[9px] text-blue-300 font-bold">REMPLACER</div>`}
        </div>`;
    });

    if (desktopList) desktopList.innerHTML = html;
    if (mobileList) mobileList.innerHTML = html;
}

function renderPC() {
    const desktopContent = document.getElementById('pc-content');
    const mobileContent = document.getElementById('mobile-pc-content');

    if(state.unlockedZone<3 && state.zoneIdx<3) { 
        document.getElementById('pc-locked').classList.remove('hidden'); 
        return; 
    }
    document.getElementById('pc-locked').classList.add('hidden');

    let html = state.pc.length===0 ? `<div class="text-center text-green-500 text-xs mt-10">VIDE</div>` : "";
    state.pc.forEach((p,i) => {
        const shinyClass = p.isShiny ? "shiny-glow" : "";
        const isEditing = state.editingPcIdx === i;

        let nameDisplay;
        if (isEditing) {
            nameDisplay = `
            <div class="flex items-center gap-1" onclick="event.stopPropagation()">
                <input type="text" id="rename-input-pc-${i}" value="${p.name}" maxlength="12" class="w-24 text-[10px] text-black px-1 py-0.5 rounded border border-blue-400 focus:outline-none select-text" onkeydown="if(event.key==='Enter') confirmPcRename(${i})">
                <button onclick="confirmPcRename(${i})" class="text-green-400 hover:text-green-300 material-symbols-outlined text-[14px] bg-slate-800 rounded-full">check</button>
                <button onclick="cancelPcRename()" class="text-red-400 hover:text-red-300 material-symbols-outlined text-[14px] bg-slate-800 rounded-full">close</button>
            </div>`;
        } else {
            nameDisplay = `
            <div class="flex items-center gap-1">
                <div class="text-[10px] text-green-400 truncate max-w-[100px]">${p.name}${p.isShiny?"★":""}</div>
                <button onclick="startPcRename(${i}, event)" class="material-symbols-outlined text-[12px] text-gray-500 hover:text-white cursor-pointer opacity-50 hover:opacity-100 transition-opacity shrink-0" title="Renommer">edit</button>
            </div>`;
        }

        html += `
        <div class="flex justify-between items-center bg-gray-900/80 p-2 mb-1 border-b border-green-900">
            <div class="flex items-center gap-2">
                <img src="${p.img}" class="w-8 h-8 ${shinyClass}">
                <div>
                    ${nameDisplay}
                    <div class="text-[8px] text-green-600">Lv.${p.level}</div>
                </div>
            </div>
            <div class="flex gap-1">
                <button onclick="initSwap(${i})" class="text-[8px] bg-green-700 text-white px-2 py-1 rounded">IN</button>
                <button onclick="releasePokemon(${i})" class="text-[8px] bg-red-900 text-white px-2 py-1 rounded">X</button>
            </div>
        </div>`;
    });

    if(desktopContent) desktopContent.innerHTML = html;
    if(mobileContent) mobileContent.innerHTML = html;
}

function renderBag() {
    const desktopBag = document.getElementById('bag-content');
    const mobileBag = document.getElementById('mobile-bag-content');

    let html = `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="attemptCatch('poke')" title="${ITEMS.pokeball.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Pokéball</div><div class="text-sm font-bold">x${state.inv.balls} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 ${state.inv.candy>0?'cursor-pointer hover:bg-slate-600':''}" ${state.inv.candy>0?'onclick="initCandyUse()"':''} title="${ITEMS.candy.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/rare-candy.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Super Bonbon</div><div class="text-sm font-bold">x${state.inv.candy} ${state.inv.candy>0?'<span class="text-[8px] text-yellow-500">UTILISER</span>':''}</div></div>
    </div>
    ${state.inv.repel>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useRepel()" title="${ITEMS.repel.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/repel.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Repousse</div><div class="text-sm font-bold">x${state.inv.repel} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.superRepel>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useSuperRepel()" title="${ITEMS.superRepel.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/super-repel.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Superepousse</div><div class="text-sm font-bold">x${state.inv.superRepel} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.xAttack>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useXAttack()" title="${ITEMS.xAttack.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-attack.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Attaque +</div><div class="text-sm font-bold">x${state.inv.xAttack} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.xSpecial>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="useXSpecial()" title="${ITEMS.xSpecial.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/x-sp-atk.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Attaque Spé +</div><div class="text-sm font-bold">x${state.inv.xSpecial} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.pokeDoll>0 ? `
    <div class="bg-slate-700 p-2 rounded flex items-center gap-2 border border-slate-600 cursor-pointer hover:bg-slate-600" onclick="usePokeDoll()" title="${ITEMS.pokeDoll.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-doll.png" class="w-6 h-6">
        <div><div class="text-xs text-gray-400">Poké Poupée</div><div class="text-sm font-bold">x${state.inv.pokeDoll} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.superballs>0 || state.unlockedZone>=4 || state.zoneIdx>=4 ? `
    <div class="bg-blue-900/40 p-2 rounded flex items-center gap-2 border border-blue-500 cursor-pointer hover:bg-blue-800/40" onclick="attemptCatch('super')" title="${ITEMS.superball.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/great-ball.png" class="w-6 h-6">
        <div><div class="text-xs text-blue-300">Superball</div><div class="text-sm font-bold">x${state.inv.superballs} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.hyperballs>0 || state.unlockedZone>=9 || state.zoneIdx>=9 ? `
    <div class="bg-yellow-900/40 p-2 rounded flex items-center gap-2 border border-yellow-500 cursor-pointer hover:bg-yellow-800/40" onclick="attemptCatch('hyper')" title="${ITEMS.hyperball.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png" class="w-6 h-6">
        <div><div class="text-xs text-yellow-300">Hyperball</div><div class="text-sm font-bold">x${state.inv.hyperballs} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.masterball>0 ? `
    <div class="bg-purple-900/40 p-2 rounded flex items-center gap-2 border border-purple-500 cursor-pointer hover:bg-purple-800/40" onclick="attemptCatch('master')" title="${ITEMS.masterball.desc}">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-6 h-6">
        <div><div class="text-xs text-purple-300">Masterball</div><div class="text-sm font-bold">x${state.inv.masterball} <span class="text-[8px] text-yellow-500">UTILISER</span></div></div>
    </div>`:''}
    ${state.inv.shinyToken>0 ? `
    <div class="bg-yellow-900/40 p-2 rounded flex items-center gap-2 border border-yellow-500" title="Transforme un Pokémon de l'équipe en Shiny">
        <div class="w-6 h-6 rounded-full bg-yellow-400 border-2 border-white flex items-center justify-center text-[10px] text-black font-bold">★</div>
        <div><div class="text-xs text-yellow-300">Jeton Shiny</div><div class="text-sm font-bold">x${state.inv.shinyToken}</div></div>
    </div>`:''}
    ${state.inv.omniXp>0 ? `
    <div class="bg-indigo-900/40 p-2 rounded flex items-center gap-2 border border-indigo-500" title="XP gagnée +100% (Passif)"><span class="material-symbols-outlined text-indigo-300">auto_awesome</span><div><div class="text-xs text-indigo-300">Omni XP</div><div class="text-sm font-bold">x${state.inv.omniXp}</div></div></div>`:''}
    `;

    if(desktopBag) desktopBag.innerHTML = html;
    if(mobileBag) mobileBag.innerHTML = html;
}

function renderShop() {
    const desktopShop = document.getElementById('shop-content');
    const mobileShop = document.getElementById('mobile-shop-content');

    if(state.unlockedZone<1 && state.zoneIdx<1) { 
        document.getElementById('shop-locked').classList.remove('hidden'); 
        if(desktopShop) desktopShop.classList.add('locked-blur'); 
    } else { 
        document.getElementById('shop-locked').classList.add('hidden'); 
        if(desktopShop) desktopShop.classList.remove('locked-blur'); 
    }

    let html = `<div class="text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider border-b border-gray-700 pb-1">Consommables</div>`;
    
    // Consumables
    for (const [id, item] of Object.entries(ITEMS)) {
        if (item.type !== 'consumable') continue;
        if (state.unlockedZone < item.zone && state.zoneIdx < item.zone) continue;

        let stockDisplay = "";
        if (item.invKey) {
            stockDisplay = `<div class="text-[8px] text-blue-300">x<span id="shop-stock-${id}">${state.inv[item.invKey]}</span></div>`;
        }

        let iconHtml = "";
        if (item.img) iconHtml = `<img class="w-6 h-6" src="${item.img}">`;
        else if (item.icon) iconHtml = `<span class="material-symbols-outlined ${item.iconColor || 'text-gray-400'}">${item.icon}</span>`;

        const finalPrice = getPrice(getItemPrice(id));
        const priceColor = state.money >= finalPrice ? "text-yellow-400" : "text-red-500";

        html += `
        <div class="bg-slate-800 p-2 rounded border ${id==='superball'?'border-blue-600 bg-blue-900/30':'border-slate-700'} hover:border-blue-500 cursor-pointer flex items-center gap-2 relative group" onclick="buyItem('${id}')" title="${item.desc}">
            ${iconHtml}
            <div class="flex-1 text-xs ${id==='superball'?'text-blue-200':''}">${item.name}</div>
            <div class="${priceColor} text-xs">${finalPrice.toLocaleString('de-DE')}$</div>
            ${stockDisplay}
            <button onclick="showItemInfo('${id}', event)" class="w-4 h-4 rounded-full bg-slate-600 hover:bg-slate-500 text-white text-[8px] flex items-center justify-center border border-slate-500 shrink-0 z-10 ml-1" title="Info">i</button>
        </div>`;
    }

    // Upgrades
    html += `<div class="text-xs font-bold text-gray-400 mb-1 mt-3 uppercase tracking-wider border-b border-gray-700 pb-1">Améliorations</div>`;
    
    for (const [id, item] of Object.entries(ITEMS)) {
        if (item.type !== 'upgrade') continue;
        if (state.unlockedZone < item.zone && state.zoneIdx < item.zone) continue;

        const owned = state.upgrades[id];
        let iconHtml = "";
        if (item.img) iconHtml = `<img class="w-6 h-6" src="${item.img}">`;
        else if (item.icon) iconHtml = `<span class="material-symbols-outlined ${item.iconColor || 'text-white'}">${item.icon}</span>`;

        const finalPrice = getPrice(getItemPrice(id));
        const priceColor = state.money >= finalPrice ? "text-yellow-400" : "text-red-500";

        html += `
        <div class="bg-slate-800 p-2 rounded border ${owned?'border-green-600 opacity-50':'border-slate-700 hover:border-blue-500 cursor-pointer'} flex items-center gap-2 relative group" ${!owned?`onclick="buyItem('${id}')"`:''} title="${item.desc}">
            ${iconHtml}
            <div class="flex-1 text-xs">${item.name}</div>
            ${owned ? `<div class="text-xs text-green-400 font-bold">ACQUIS</div>` : `<div class="${priceColor} text-xs">${finalPrice.toLocaleString('de-DE')}$</div>`}
            <button onclick="showItemInfo('${id}', event)" class="w-4 h-4 rounded-full bg-slate-600 hover:bg-slate-500 text-white text-[8px] flex items-center justify-center border border-slate-500 shrink-0 z-10 ml-1" title="Info">i</button>
        </div>`;
    }

    if(desktopShop) desktopShop.innerHTML = html;
    if(mobileShop) mobileShop.innerHTML = html;
}

function renderPokedex() {
    const g = document.getElementById('pokedex-grid');
    g.innerHTML = "";
    document.getElementById('pokedex-count').innerText = state.pokedex.length;
    
    // Find next milestone
    let nextM = MILESTONES.find(m => m.count > state.pokedex.length);
    document.getElementById('next-milestone-text').innerText = nextM ? `Prochain: ${nextM.count} (${nextM.title})` : "COMPLET !";

    for(let i=1; i<=151; i++) {
        const caught = state.pokedex.includes(i);
        const div = document.createElement('div');
        div.className = `aspect-square rounded border flex items-center justify-center relative ${caught ? 'bg-slate-700 border-slate-500' : 'bg-slate-900 border-slate-800'}`;
        
        if(caught) {
            div.innerHTML = `<img src="${getSprite(i)}" class="w-full h-full object-contain"><div class="absolute bottom-0 right-1 text-[8px] text-white font-mono">#${i}</div>`;
        } else {
            div.innerHTML = `<div class="text-slate-700 font-bold text-xl">#${i}</div>`;
        }
        g.appendChild(div);
    }
}

function clickAttack(e) {
    if(enemy.dead) return;
    const dmg = getClick();
    damageEnemy(dmg);
    const img = document.getElementById('enemy-sprite');
    img.classList.remove('shake-anim'); 
    void img.offsetWidth; // Trigger reflow
    img.classList.add('shake-anim');
    
    // Determine color based on leader effectiveness
    const leaderMult = state.team.length > 0 ? getMultiplier(state.team[0].id, enemy.id) : 1;
    playTone('hit');
    
    // Damage number
    const d = document.createElement('div');
    d.innerText = getClick(); 
    d.className="absolute text-white font-bold text-xl pointer-events-none z-50 text-shadow";
    d.style.left=(e.clientX-10)+"px"; 
    d.style.top=(e.clientY-30)+"px"; 
    if(leaderMult > 1) d.style.color = "#4ade80"; // Green
    if(leaderMult < 1) d.style.color = "#f87171"; // Red
    d.style.transition="0.5s";
    document.body.appendChild(d);
    
    requestAnimationFrame(()=>{ d.style.transform="translateY(-30px)"; d.style.opacity="0"; });
    setTimeout(()=>d.remove(), 500);
}

function toggleAutoAttack() {
    state.auto = !state.auto;
    updateAutoBtn();
}

function updateAutoBtn() {
    ['auto-attack-btn', 'auto-attack-btn-m'].forEach(id => {
        const b = document.getElementById(id);
        if (!b) return;

        const isDesktop = id === 'auto-attack-btn';
        let baseClass = "justify-center text-[9px] font-bold flex items-center gap-1 transition-all rounded shadow-md";
        baseClass += isDesktop ? " flex-1 py-1 px-1" : " p-1.5";

        const colorClass = state.auto 
            ? "bg-green-600 hover:bg-green-500 text-white border border-green-400" 
            : "bg-red-600 hover:bg-red-500 text-white border border-red-400";
        b.className = `${baseClass} ${colorClass}`;
    });
}

function toggleAutoClicker() {
    state.autoClicker = !state.autoClicker;
    updateAutoClickerBtn();
}

function updateAutoClickerBtn() {
    ['auto-click-btn', 'auto-click-btn-m'].forEach(id => {
        const b = document.getElementById(id);
        if (!b) return;

        const isDesktop = id === 'auto-click-btn';
        let baseClass = "justify-center text-[9px] font-bold flex items-center gap-1 transition-all rounded shadow-md";
        baseClass += isDesktop ? " flex-1 py-1 px-1" : " p-1.5";

        const colorClass = state.autoClicker 
            ? "bg-green-600 hover:bg-green-500 text-white border border-green-400" 
            : "bg-red-600 hover:bg-red-500 text-white border border-red-400";
        b.className = `${baseClass} ${colorClass}`;
    });
}

function startAutoClicker() {
    if(autoClickerInterval) clearInterval(autoClickerInterval);
    // 9 clicks per second = ~111ms
    autoClickerInterval = setInterval(() => {
        if(state.autoClicker && !enemy.dead && state.upgrades.leftovers) {
            damageEnemy(getClick());
        }
    }, 111);
}

function toggleStopOnRare() {
    state.stopOnRare = !state.stopOnRare;
    updateAutoStopBtn();
}

function updateAutoStopBtn() {
    ['auto-stop-btn', 'auto-stop-btn-m'].forEach(id => {
        const b = document.getElementById(id);
        if (!b) return;

        const isDesktop = id === 'auto-stop-btn';
        let baseClass = "justify-center text-[9px] font-bold flex items-center gap-1 transition-all rounded-l-md shadow-md";
        baseClass += isDesktop ? " flex-grow py-1 px-1" : " p-1.5";

        const classTrue = `${baseClass} bg-green-600 hover:bg-green-500 text-white border border-green-400`;
        const classFalse = `${baseClass} bg-gray-600 hover:bg-gray-500 text-gray-300 border border-gray-400`;

        b.className = state.stopOnRare ? classTrue : classFalse;
    });
}

function showFeedback(t,c) {
    const e = document.getElementById('feedback-msg');
    e.innerHTML = `<span class="text-${c}-400 font-bold text-2xl pixel-font text-shadow-lg">${t}</span>`;
    e.classList.remove('hidden'); 
    e.classList.add('animate-bounce');
    setTimeout(()=>e.classList.add('hidden'), 1200);
}

function changeZone(d) {
    const n = state.zoneIdx + d;
    if(n>=0 && (n<=state.unlockedZone || state.cheat) && n<ZONES.length) {
        if(state.cheat && n > state.unlockedZone) state.unlockedZone = n;
        state.zoneIdx = n; 
        state.subStage = 1;
        updateBg(); renderShop(); renderBag(); renderPC(); spawnEnemy();
    }
}

function shakeBtn(id) {
    const b = document.getElementById(id);
    b.classList.add('animate-pulse');
    setTimeout(()=>b.classList.remove('animate-pulse'), 300);
}

function showPC() {
    document.getElementById('right-menu-view').classList.add('hidden');
    document.getElementById('pc-view').classList.remove('hidden');
}

function hidePC() {
    document.getElementById('pc-view').classList.add('hidden');
    document.getElementById('right-menu-view').classList.remove('hidden');
}

function showStats() {
    document.getElementById('stats-modal').classList.remove('hidden');
    renderStats();
}

function renderAutoStopSettings() {
    const list = document.getElementById('auto-stop-settings-list');
    const rarities = ['Commun', 'Peu Commun', 'Rare', 'Très Rare', 'Légendaire', 'Shiny'];
    list.innerHTML = '';
    rarities.forEach(rarity => {
        const isChecked = state.autoStopSettings[rarity];
        list.innerHTML += `
        <label class="flex items-center justify-between p-2 rounded bg-slate-700 hover:bg-slate-600 cursor-pointer">
            <span class="font-bold text-sm text-white">${rarity}</span>
            <input type="checkbox" onchange="updateAutoStopSetting('${rarity}')" ${isChecked ? 'checked' : ''} class="w-5 h-5 rounded text-blue-500 bg-slate-900 border-slate-500 focus:ring-blue-600">
        </label>
        `;
    });
}

function updateAutoStopSetting(rarity) {
    state.autoStopSettings[rarity] = !state.autoStopSettings[rarity];
}

function resumeAutoBattle() {
    if (state.interruptedState) {
        state.auto = state.interruptedState.auto;
        state.autoClicker = state.interruptedState.autoClicker;
        state.interruptedState = null; // Reset the flag
        updateAutoBtn();
        updateAutoClickerBtn();
        showFeedback("AUTO-COMBAT REPRIS", "green");
    }
}

function hideStats() {
    document.getElementById('stats-modal').classList.add('hidden');
}

function renderStats() {
    const c = document.getElementById('stats-content');
    
    // Calculations
    let baseDps = state.team.reduce((s,p) => s + ((BASE_STATS[p.id]||40) * p.level)/5, 0);
    let currentDps = getDPS(null);
    
    let dpsMults = [];
    if(hasMilestone(30)) dpsMults.push("Collectionneur (x1.5)");
    if(hasMilestone(90)) dpsMults.push("Maître (x1.5)");
    if(hasBadge("Cascade")) dpsMults.push("Badge Cascade (x1.3)");
    if(hasBadge("Foudre")) dpsMults.push("Badge Foudre (x1.2)");
    if(hasBadge("Volcan")) dpsMults.push("Badge Volcan (x1.5)");
    if(Date.now() < state.dpsBoostEndTime) dpsMults.push("Attaque Spé + (x2)");

    // Base Click est calculé sur le DPS TOTAL (currentDps), pas le DPS de base
    let baseClick = 5 + Math.floor(currentDps * 0.002);
    
    // Recalcul pour affichage neutre (sans dépendre de l'ennemi actuel)
    let currentClick = baseClick;
    if(hasMilestone(10)) currentClick *= 2;
    if(hasMilestone(90)) currentClick *= 1.5;
    if(state.upgrades.protein) currentClick = Math.floor(currentClick * 1.5);
    if(state.upgrades.hardStone) currentClick = Math.floor(currentClick * 1.3);
    if(hasBadge("Roche")) currentClick = Math.floor(currentClick * 1.5);
    if(hasBadge("Foudre")) currentClick = Math.floor(currentClick * 1.2);
    if(hasBadge("Volcan")) currentClick *= 1.5;
    if(Date.now() < state.attackBoostEndTime) currentClick *= 2;

    let clickMults = [];
    if(hasMilestone(10)) clickMults.push("Débutant (x2)");
    if(hasMilestone(90)) clickMults.push("Maître (x1.5)");
    if(state.upgrades.protein) clickMults.push("Protéine (x1.5)");
    if(state.upgrades.hardStone) clickMults.push("Pierre Dure (x1.3)");
    if(hasBadge("Roche")) clickMults.push("Badge Roche (x1.5)");
    if(hasBadge("Foudre")) clickMults.push("Badge Foudre (x1.2)");
    if(hasBadge("Volcan")) clickMults.push("Badge Volcan (x1.5)");
    if(Date.now() < state.attackBoostEndTime) clickMults.push("Attaque + (x2)");

    let moneyMults = [];
    if(state.upgrades.amuletCoin) moneyMults.push("Pièce Rune (x1.3)");
    if(hasBadge("Prisme")) moneyMults.push("Badge Prisme (x1.2)");
    let moneyTotalMult = (state.upgrades.amuletCoin?1.3:1) * (hasBadge("Prisme")?1.2:1);

    let xpMults = [];
    if(state.upgrades.expShare) xpMults.push("Multi Exp (x1.5)");
    if(state.upgrades.luckyEgg) xpMults.push("Oeuf Chance (x1.5)");
    if(state.inv.omniXp > 0) xpMults.push("Omni XP (x2)");
    if(hasBadge("Âme")) xpMults.push("Badge Âme (x1.5)");
    let xpTotalMult = (state.upgrades.expShare?1.5:1) * (state.upgrades.luckyEgg?1.5:1) * (state.inv.omniXp>0?2:1) * (hasBadge("Âme")?1.5:1);

    let catchMults = [];
    if(hasBadge("Marais")) catchMults.push("Badge Marais (x1.3)");

    const statBlock = (title, base, mults, total, icon, color, baseLabel="Base") => `
        <div class="bg-slate-800 rounded p-3 border border-slate-700">
            <div class="flex items-center gap-2 mb-2 border-b border-slate-700 pb-1">
                <span class="material-symbols-outlined text-${color}-400 text-sm">${icon}</span>
                <span class="text-xs font-bold text-${color}-300">${title}</span>
            </div>
            <div class="grid grid-cols-2 gap-y-1 text-[10px]">
                <div class="text-gray-400">${baseLabel}:</div><div class="text-right font-mono">${base}</div>
                <div class="text-gray-400">Boosts:</div><div class="text-right text-${color}-400">${mults.length>0 ? mults.join(", ") : "Aucun"}</div>
                <div class="text-white font-bold border-t border-slate-600 mt-1 pt-1">Total:</div><div class="text-right font-bold text-${color}-300 border-t border-slate-600 mt-1 pt-1 font-mono">${total}</div>
            </div>
        </div>`;

    c.innerHTML = `
        <div class="bg-slate-800 rounded p-3 border border-slate-700 mb-2">
            <div class="text-[10px] text-gray-400">POKÉMON VAINCUS</div>
            <div class="text-xl font-bold text-white pixel-font">${state.stats.kills}</div>
        </div>
        <div class="bg-slate-800 rounded p-3 border border-slate-700 mb-4">
            <div class="text-[10px] text-gray-400">ARGENT TOTAL</div>
            <div class="text-xl font-bold text-yellow-400 pixel-font">${(state.stats.totalMoney || state.money).toLocaleString('de-DE')} $</div>
        </div>
        
        ${statBlock("DÉGÂTS CLIC", baseClick, clickMults, currentClick, "touch_app", "red", "Base (5+0.2% DPS)")}
        ${statBlock("DPS ÉQUIPE", baseDps.toFixed(1), dpsMults, currentDps.toFixed(1), "swords", "blue")}
        ${statBlock("GAINS ARGENT", "100%", moneyMults, "x"+moneyTotalMult.toFixed(2), "attach_money", "yellow")}
        ${statBlock("GAINS XP", "100%", xpMults, "x"+xpTotalMult.toFixed(2), "school", "green")}
        
        <div class="bg-slate-800 rounded p-3 border border-slate-700">
            <div class="flex items-center gap-2 mb-2 border-b border-slate-700 pb-1">
                <span class="material-symbols-outlined text-purple-400 text-sm">radio_button_checked</span>
                <span class="text-xs font-bold text-purple-300">TAUX CAPTURE</span>
            </div>
            <div class="text-[10px] text-gray-400">Boosts Passifs: <span class="text-purple-300">${catchMults.length>0 ? catchMults.join(", ") : "Aucun"}</span></div>
        </div>
    `;
}

function openMobileSubView(viewId) {
    document.getElementById('mobile-main-menu').classList.add('hidden');
    document.getElementById('mobile-subview-container').classList.remove('hidden');
    const views = ['mobile-team-view', 'mobile-bag-view', 'mobile-shop-view', 'mobile-pc-view'];
    views.forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(viewId).classList.remove('hidden');
    document.getElementById(viewId).classList.add('flex');
}

function closeMobileSubViews() {
    document.getElementById('mobile-main-menu').classList.remove('hidden');
    document.getElementById('mobile-subview-container').classList.add('hidden');
}

// --- GAME LOOP & START ---
setInterval(() => {
    const isEvolving = Date.now() < evolvingPokemon.endTime;
    if(state.auto && state.team.length>0 && !enemy.dead && !isEvolving) {
        damageEnemy(getDPS(enemy.id)/10);
    }
    updateActiveEffects();
}, 100);

// Launch
window.onload = init;

</script>
</body>
</html>